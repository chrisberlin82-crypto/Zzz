<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Galerie – MedReception</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<link rel="stylesheet" href="style.css">
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'Inter', sans-serif; background: #f8fafc; display: flex; }
  /* Main */
  .main { flex: 1; padding: 28px; overflow: auto; margin-left: 240px; }
  .top-bar { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
  h1 { font-size: 22px; font-weight: 700; color: #111827; }
  .live-badge { display: flex; align-items: center; gap: 5px; font-size: 11px; color: #15803d; font-weight: 600; background: #dcfce7; padding: 4px 10px; border-radius: 999px; }
  .live-dot { width: 7px; height: 7px; background: #22c55e; border-radius: 50%; animation: blink 1.2s infinite; }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }
  .date { font-size: 13px; color: #6b7280; margin-bottom: 20px; }

  /* Stats Row */
  .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 24px; }
  .stat-card { background: white; border-radius: 14px; border: 1px solid #e5e7eb; padding: 18px 20px; position: relative; overflow: hidden; }
  .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
  .stat-card.purple::before { background: #6366f1; }
  .stat-card.green::before { background: #22c55e; }
  .stat-card.yellow::before { background: #f59e0b; }
  .stat-card.blue::before { background: #3b82f6; }
  .stat-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 16px; margin-bottom: 12px; }
  .stat-icon.purple { background: #ede9fe; color: #6366f1; }
  .stat-icon.green { background: #dcfce7; color: #16a34a; }
  .stat-icon.yellow { background: #fef3c7; color: #d97706; }
  .stat-icon.blue { background: #dbeafe; color: #2563eb; }
  .stat-label { font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: .5px; margin-bottom: 6px; }
  .stat-value { font-size: 28px; font-weight: 800; color: #0f172a; }
  .stat-sub { font-size: 11px; color: #9ca3af; margin-top: 2px; }

  /* Filter Bar */
  .filter-bar { display: flex; align-items: center; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
  .search-box { position: relative; flex: 1; min-width: 220px; }
  .search-box input { width: 100%; padding: 10px 14px 10px 38px; border: 1.5px solid #e2e8f0; border-radius: 10px; font-size: 13px; font-family: 'Inter', sans-serif; color: #1e293b; outline: none; background: white; }
  .search-box input:focus { border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,.1); }
  .search-box i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-size: 13px; }
  .filter-select { padding: 10px 14px; border: 1.5px solid #e2e8f0; border-radius: 10px; font-size: 13px; font-family: 'Inter', sans-serif; color: #1e293b; outline: none; background: white; cursor: pointer; min-width: 140px; }
  .filter-select:focus { border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,.1); }
  .btn-create { display: flex; align-items: center; gap: 8px; padding: 10px 20px; border-radius: 10px; font-size: 13px; font-weight: 600; border: none; cursor: pointer; font-family: 'Inter', sans-serif; background: #6366f1; color: white; transition: all .15s; white-space: nowrap; }
  .btn-create:hover { background: #4f46e5; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(99,102,241,.3); }

  /* Card Grid */
  .agent-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
  @media (max-width: 1200px) { .agent-grid { grid-template-columns: repeat(2, 1fr); } }
  @media (max-width: 768px) {
    .agent-grid { grid-template-columns: 1fr; }
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
    .filter-bar { flex-direction: column; align-items: stretch; }
    .main { margin-left: 0; padding: 16px; }
  }
  @media (max-width: 480px) {
    .stats-grid { grid-template-columns: 1fr; }
  }

  /* Agent Card */
  .agent-card { background: white; border-radius: 14px; border: 1px solid #e5e7eb; overflow: hidden; transition: all .2s ease; display: flex; flex-direction: column; }
  .agent-card:hover { border-color: #c7d2fe; box-shadow: 0 8px 25px rgba(99,102,241,.1); transform: translateY(-2px); }
  .agent-card-header { padding: 20px 20px 0; display: flex; align-items: flex-start; gap: 14px; }
  .agent-avatar { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; color: white; flex-shrink: 0; }
  .agent-avatar.purple { background: linear-gradient(135deg, #6366f1, #8b5cf6); }
  .agent-avatar.green { background: linear-gradient(135deg, #22c55e, #16a34a); }
  .agent-avatar.blue { background: linear-gradient(135deg, #3b82f6, #2563eb); }
  .agent-avatar.orange { background: linear-gradient(135deg, #f59e0b, #ea580c); }
  .agent-avatar.pink { background: linear-gradient(135deg, #ec4899, #db2777); }
  .agent-avatar.teal { background: linear-gradient(135deg, #14b8a6, #0d9488); }
  .agent-header-info { flex: 1; min-width: 0; }
  .agent-name { font-size: 14px; font-weight: 700; color: #0f172a; margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .agent-branch { font-size: 11px; color: #6b7280; font-weight: 500; }
  .agent-status-badge { padding: 3px 10px; border-radius: 999px; font-size: 10px; font-weight: 700; letter-spacing: .3px; white-space: nowrap; flex-shrink: 0; }
  .agent-status-badge.aktiv { background: #dcfce7; color: #15803d; }
  .agent-status-badge.entwurf { background: #fef3c7; color: #92400e; }
  .agent-status-badge.inaktiv { background: #f3f4f6; color: #6b7280; }

  /* Agent Card Body */
  .agent-card-body { padding: 16px 20px; flex: 1; }
  .agent-detail-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-size: 12px; color: #475569; }
  .agent-detail-row i { width: 16px; text-align: center; color: #9ca3af; font-size: 11px; }
  .agent-detail-row span { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  /* Mini KPIs */
  .agent-kpis { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 14px; padding-top: 14px; border-top: 1px solid #f3f4f6; }
  .agent-kpi { text-align: center; }
  .agent-kpi-value { font-size: 16px; font-weight: 800; color: #0f172a; }
  .agent-kpi-label { font-size: 10px; color: #9ca3af; font-weight: 500; margin-top: 1px; }

  /* Agent Card Footer */
  .agent-card-footer { padding: 14px 20px; border-top: 1px solid #f3f4f6; display: flex; align-items: center; justify-content: space-between; background: #fafbfc; }
  .agent-modified { font-size: 10px; color: #9ca3af; }
  .agent-actions { display: flex; gap: 4px; }
  .agent-actions button { width: 32px; height: 32px; border-radius: 8px; border: 1.5px solid #e2e8f0; background: white; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #64748b; transition: all .15s; }
  .agent-actions button:hover { border-color: #6366f1; color: #6366f1; background: #f5f3ff; }
  .agent-actions button.danger:hover { border-color: #ef4444; color: #ef4444; background: #fef2f2; }
  .agent-actions button.success:hover { border-color: #22c55e; color: #22c55e; background: #f0fdf4; }
  .agent-actions button[title]::after { content: attr(title); }

  /* Empty State */
  .empty-state { text-align: center; padding: 60px 20px; color: #9ca3af; }
  .empty-state i { font-size: 48px; margin-bottom: 16px; color: #d1d5db; }
  .empty-state h3 { font-size: 16px; font-weight: 600; color: #6b7280; margin-bottom: 6px; }
  .empty-state p { font-size: 13px; }

  /* Modal Overlay */
  .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15,23,42,.5); z-index: 1000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
  .modal-overlay.show { display: flex; }
  .modal { background: white; border-radius: 16px; width: 90%; max-width: 540px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px rgba(0,0,0,.15); }
  .modal-header { padding: 20px 24px; border-bottom: 1px solid #f3f4f6; display: flex; align-items: center; justify-content: space-between; }
  .modal-header h2 { font-size: 16px; font-weight: 700; color: #0f172a; display: flex; align-items: center; gap: 8px; }
  .modal-close { width: 32px; height: 32px; border-radius: 8px; border: none; background: #f1f5f9; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; color: #64748b; transition: all .15s; }
  .modal-close:hover { background: #e2e8f0; color: #1e293b; }
  .modal-body { padding: 24px; }
  .modal-footer { padding: 16px 24px; border-top: 1px solid #f3f4f6; display: flex; justify-content: flex-end; gap: 10px; }
  .form-group { margin-bottom: 16px; }
  .form-group label { display: block; font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase; letter-spacing: .5px; margin-bottom: 6px; }
  .form-group input, .form-group select { width: 100%; padding: 10px 14px; border: 1.5px solid #e2e8f0; border-radius: 10px; font-size: 13px; font-family: 'Inter', sans-serif; color: #1e293b; outline: none; background: white; }
  .form-group input:focus, .form-group select:focus { border-color: #6366f1; box-shadow: 0 0 0 3px rgba(99,102,241,.1); }
  .form-row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  .btn { padding: 10px 20px; border-radius: 10px; font-size: 13px; font-weight: 600; border: none; cursor: pointer; font-family: 'Inter', sans-serif; transition: all .15s; }
  .btn.primary { background: #6366f1; color: white; }
  .btn.primary:hover { background: #4f46e5; }
  .btn.secondary { background: #f1f5f9; color: #475569; border: 1.5px solid #e2e8f0; }
  .btn.secondary:hover { background: #e2e8f0; }
  .btn.red { background: #ef4444; color: white; }
  .btn.red:hover { background: #dc2626; }

  /* Tooltip */
  .agent-actions button { position: relative; }
  .agent-actions button:hover::before { content: attr(title); position: absolute; bottom: calc(100% + 6px); left: 50%; transform: translateX(-50%); background: #1e293b; color: white; font-size: 10px; font-weight: 500; padding: 4px 8px; border-radius: 6px; white-space: nowrap; z-index: 10; pointer-events: none; }
  .agent-actions button:hover::after { content: ''; position: absolute; bottom: calc(100% + 2px); left: 50%; transform: translateX(-50%); border: 4px solid transparent; border-top-color: #1e293b; z-index: 10; pointer-events: none; }
</style>
</head>
<body>
<!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-logo" onclick="location.href='admin-dashboard.html'"><div class="icon">M</div><span>MedReception</span></div>
        <nav class="sidebar-nav">
            <div class="nav-group">Übersicht</div>
            <a href="admin-dashboard.html"><i class="fa-solid fa-gauge nav-icon"></i> Dashboard</a>
            <div class="nav-group">Callcenter</div>
            <a href="agenten.html"><i class="fa-solid fa-headset nav-icon"></i> Agenten</a>
            <a href="voicebot.html"><i class="fa-solid fa-robot nav-icon"></i> Voicebot</a>
            <a href="ansagen.html"><i class="fa-solid fa-tower-broadcast nav-icon"></i> Audio Studio</a>
            <a href="callflow.html"><i class="fa-solid fa-diagram-project nav-icon"></i> Callflow</a>
            <div class="nav-group">Telefonie</div>
            <a href="asterisk.html"><i class="fa-solid fa-server nav-icon"></i> Asterisk</a>
            <a href="acd.html"><i class="fa-solid fa-phone-volume nav-icon"></i> ACD</a>
            <div class="nav-group">Praxis</div>
            <a href="termine.html"><i class="fa-solid fa-calendar-days nav-icon"></i> Termine</a>
            <a href="auswertung.html"><i class="fa-solid fa-chart-line nav-icon"></i> Auswertungen</a>
            <div class="nav-group">KI</div>
            <a href="ai-agent.html"><i class="fa-solid fa-microchip nav-icon"></i> AI Agent</a>
            <a href="ai-galerie.html" class="active"><i class="fa-solid fa-robot nav-icon"></i> AI Galerie</a>
        </nav>
        <div class="sidebar-footer">
            <button onclick="sessionStorage.removeItem('mr_guard_session');location.href='index.html'" type="button"><i class="fa-solid fa-right-from-bracket nav-icon"></i> Abmelden</button>
        </div>
    </aside>

<!-- Main -->
<div class="main">
  <div class="top-bar">
    <h1><i class="fa-solid fa-robot" style="color:#6366f1;margin-right:8px"></i> AI Agent Galerie</h1>
    <div class="live-badge"><span class="live-dot"></span> System Online</div>
  </div>
  <p class="date">Alle konfigurierten KI-Agenten verwalten, duplizieren und ueberwachen</p>

  <!-- Stats Row -->
  <div class="stats-grid">
    <div class="stat-card purple">
      <div class="stat-icon purple"><i class="fa-solid fa-robot"></i></div>
      <div class="stat-label">Agents gesamt</div>
      <div class="stat-value" id="stat-total">5</div>
      <div class="stat-sub">Konfigurierte AI-Agents</div>
    </div>
    <div class="stat-card green">
      <div class="stat-icon green"><i class="fa-solid fa-circle-check"></i></div>
      <div class="stat-label">Aktiv</div>
      <div class="stat-value" id="stat-active">3</div>
      <div class="stat-sub">Produktiv im Einsatz</div>
    </div>
    <div class="stat-card yellow">
      <div class="stat-icon yellow"><i class="fa-solid fa-pen-ruler"></i></div>
      <div class="stat-label">Entwurf</div>
      <div class="stat-value" id="stat-draft">1</div>
      <div class="stat-sub">In Entwicklung</div>
    </div>
    <div class="stat-card blue">
      <div class="stat-icon blue"><i class="fa-solid fa-chart-line"></i></div>
      <div class="stat-label">Ø Erfolgsrate</div>
      <div class="stat-value" id="stat-success">88%</div>
      <div class="stat-sub">Durchschnitt aller aktiven Agents</div>
    </div>
  </div>

  <!-- Filter Bar -->
  <div class="filter-bar">
    <div class="search-box">
      <i class="fa-solid fa-magnifying-glass"></i>
      <input type="text" id="search-input" placeholder="Agent suchen..." oninput="applyFilters()">
    </div>
    <select class="filter-select" id="filter-status" onchange="applyFilters()">
      <option value="all">Alle Status</option>
      <option value="Aktiv">Aktiv</option>
      <option value="Entwurf">Entwurf</option>
      <option value="Inaktiv">Inaktiv</option>
    </select>
    <select class="filter-select" id="sort-select" onchange="applyFilters()">
      <option value="name-asc">Name A-Z</option>
      <option value="name-desc">Name Z-A</option>
      <option value="status">Status</option>
      <option value="date-desc">Zuletzt bearbeitet</option>
      <option value="date-asc">Aelteste zuerst</option>
    </select>
    <button class="btn-create" onclick="openCreateModal()">
      <i class="fa-solid fa-plus"></i> Neuen Agent erstellen
    </button>
  </div>

  <!-- Agent Card Grid -->
  <div class="agent-grid" id="agent-grid">
    <!-- Cards rendered by JS -->
  </div>

  <!-- Empty State -->
  <div class="empty-state" id="empty-state" style="display:none">
    <i class="fa-solid fa-robot"></i>
    <h3>Keine Agents gefunden</h3>
    <p>Passen Sie Ihre Suchkriterien an oder erstellen Sie einen neuen Agent.</p>
  </div>
</div>

<!-- Create/Edit Modal -->
<div class="modal-overlay" id="agent-modal">
  <div class="modal">
    <div class="modal-header">
      <h2><i class="fa-solid fa-robot" style="color:#6366f1"></i> <span id="modal-title">Neuen Agent erstellen</span></h2>
      <button class="modal-close" onclick="closeModal()"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="edit-agent-id">
      <div class="form-group">
        <label for="modal-name">Agent-Name</label>
        <input type="text" id="modal-name" placeholder="z.B. Praxis Dr. Mueller – Empfang">
      </div>
      <div class="form-row-2">
        <div class="form-group">
          <label for="modal-branch">Branche</label>
          <select id="modal-branch">
            <option>Arztpraxis</option>
            <option>Zahnarztpraxis</option>
            <option>Rechtsanwalt</option>
            <option>Steuerberatung</option>
            <option>Friseursalon</option>
            <option>KFZ-Werkstatt</option>
            <option>Tierarztpraxis</option>
            <option>Allgemeines Buero</option>
          </select>
        </div>
        <div class="form-group">
          <label for="modal-status">Status</label>
          <select id="modal-status">
            <option value="Aktiv">Aktiv</option>
            <option value="Entwurf">Entwurf</option>
            <option value="Inaktiv">Inaktiv</option>
          </select>
        </div>
      </div>
      <div class="form-group">
        <label for="modal-phone">Telefonnummer / IVR Entry Point</label>
        <input type="text" id="modal-phone" placeholder="z.B. +49 89 123456 – IVR Hauptmenue">
      </div>
      <div class="form-row-2">
        <div class="form-group">
          <label for="modal-voice">TTS-Stimme</label>
          <select id="modal-voice">
            <option>KatjaNeural</option>
            <option>ConradNeural</option>
            <option>Anna (Piper)</option>
            <option>Rachel (ElevenLabs)</option>
            <option>Nova (OpenAI)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="modal-model">LLM-Modell</label>
          <select id="modal-model">
            <option>Llama 3.1 8B</option>
            <option>Llama 3.1 70B</option>
            <option>Mistral 7B</option>
            <option>Gemma 2 9B</option>
          </select>
        </div>
      </div>
      <div class="form-row-2">
        <div class="form-group">
          <label for="modal-calls">Anrufe heute</label>
          <input type="number" id="modal-calls" placeholder="0" min="0">
        </div>
        <div class="form-group">
          <label for="modal-success">Erfolgsrate (%)</label>
          <input type="number" id="modal-success" placeholder="0" min="0" max="100">
        </div>
      </div>
      <div class="form-group">
        <label for="modal-duration">Ø Gespraechsdauer (Sek.)</label>
        <input type="number" id="modal-duration" placeholder="0" min="0">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn secondary" onclick="closeModal()">Abbrechen</button>
      <button class="btn primary" id="modal-save-btn" onclick="saveAgent()"><i class="fa-solid fa-floppy-disk" style="margin-right:6px"></i> Speichern</button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="delete-modal">
  <div class="modal" style="max-width:420px">
    <div class="modal-header">
      <h2><i class="fa-solid fa-triangle-exclamation" style="color:#ef4444"></i> Agent loeschen</h2>
      <button class="modal-close" onclick="closeDeleteModal()"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <p style="font-size:14px;color:#374151;line-height:1.6">Sind Sie sicher, dass Sie den Agent <strong id="delete-agent-name"></strong> unwiderruflich loeschen moechten?</p>
      <p style="font-size:12px;color:#9ca3af;margin-top:8px">Diese Aktion kann nicht rueckgaengig gemacht werden.</p>
    </div>
    <div class="modal-footer">
      <button class="btn secondary" onclick="closeDeleteModal()">Abbrechen</button>
      <button class="btn red" id="confirm-delete-btn" onclick="confirmDelete()"><i class="fa-solid fa-trash" style="margin-right:6px"></i> Endgueltig loeschen</button>
    </div>
  </div>
</div>

<!-- Chat Widget -->
<button id="chat-toggle" type="button"><i class="fa-solid fa-comment-dots"></i></button>
<div id="chat-fenster">
    <div class="chat-header"><span><i class="fa-solid fa-robot"></i> Praxis-Assistent</span><button id="chat-schliessen" type="button"><i class="fa-solid fa-xmark"></i></button></div>
    <div id="chat-nachrichten"></div>
    <div class="chat-eingabe">
        <input id="chat-input" type="text" placeholder="Frage stellen oder sprechen...">
        <button id="chat-mikrofon" type="button" title="Sprechen"><i class="fa-solid fa-microphone"></i></button>
        <button id="chat-senden" type="button"><i class="fa-solid fa-paper-plane"></i></button>
    </div>
</div>

<script src="app.js"></script>
<script>
// ═══════════════════════════════════════════════
// AI Agent Galerie — Full CRUD with localStorage
// ═══════════════════════════════════════════════

const STORAGE_KEY = 'med_ai_agents';
const AVATAR_COLORS = ['purple','green','blue','orange','pink','teal'];
let deleteTargetId = null;

// ── Demo Data ──
function getDefaultAgents() {
  return [
    {
      id: 'agent_001',
      name: 'Praxis Dr. Schmidt – Empfang',
      branch: 'Arztpraxis',
      status: 'Aktiv',
      phone: '+49 89 123456 – IVR Hauptmenue',
      voice: 'KatjaNeural',
      model: 'Llama 3.1 8B',
      callsToday: 38,
      successRate: 89,
      avgDuration: 142,
      modified: '2026-02-28T08:30:00',
      avatarColor: 'purple'
    },
    {
      id: 'agent_002',
      name: 'Praxis Dr. Schmidt – Notfall',
      branch: 'Arztpraxis',
      status: 'Entwurf',
      phone: '+49 89 123456 – IVR Notfall',
      voice: 'ConradNeural',
      model: 'Llama 3.1 8B',
      callsToday: 0,
      successRate: 0,
      avgDuration: 0,
      modified: '2026-02-27T14:15:00',
      avatarColor: 'orange'
    },
    {
      id: 'agent_003',
      name: 'Zahnarzt Dr. Weber – Rezeption',
      branch: 'Zahnarztpraxis',
      status: 'Aktiv',
      phone: '+49 89 654321 – IVR Empfang',
      voice: 'Anna (Piper)',
      model: 'Mistral 7B',
      callsToday: 24,
      successRate: 92,
      avgDuration: 118,
      modified: '2026-02-28T09:10:00',
      avatarColor: 'green'
    },
    {
      id: 'agent_004',
      name: 'Kanzlei Meier – Mandantenaufnahme',
      branch: 'Rechtsanwalt',
      status: 'Aktiv',
      phone: '+49 89 987654 – IVR Kanzlei',
      voice: 'Rachel (ElevenLabs)',
      model: 'Llama 3.1 70B',
      callsToday: 12,
      successRate: 85,
      avgDuration: 195,
      modified: '2026-02-26T16:45:00',
      avatarColor: 'blue'
    },
    {
      id: 'agent_005',
      name: 'Friseursalon Style – Termine',
      branch: 'Friseursalon',
      status: 'Inaktiv',
      phone: '+49 89 112233 – IVR Salon',
      voice: 'Nova (OpenAI)',
      model: 'Gemma 2 9B',
      callsToday: 0,
      successRate: 0,
      avgDuration: 0,
      modified: '2026-02-20T11:00:00',
      avatarColor: 'pink'
    }
  ];
}

// ── localStorage helpers ──
function loadAgents() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) {
    const defaults = getDefaultAgents();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(defaults));
    return defaults;
  }
  try {
    const parsed = JSON.parse(raw);
    if (!Array.isArray(parsed) || parsed.length === 0) {
      const defaults = getDefaultAgents();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(defaults));
      return defaults;
    }
    return parsed;
  } catch (e) {
    const defaults = getDefaultAgents();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(defaults));
    return defaults;
  }
}

function saveAgents(agents) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(agents));
}

function generateId() {
  return 'agent_' + Date.now() + '_' + Math.random().toString(36).substring(2, 7);
}

// ── Render ──
function renderAgents() {
  const agents = loadAgents();
  const searchTerm = (document.getElementById('search-input').value || '').toLowerCase().trim();
  const statusFilter = document.getElementById('filter-status').value;
  const sortBy = document.getElementById('sort-select').value;

  // Filter
  let filtered = agents.filter(function(a) {
    const matchesSearch = a.name.toLowerCase().includes(searchTerm) || a.branch.toLowerCase().includes(searchTerm);
    const matchesStatus = statusFilter === 'all' || a.status === statusFilter;
    return matchesSearch && matchesStatus;
  });

  // Sort
  filtered.sort(function(a, b) {
    switch (sortBy) {
      case 'name-asc':
        return a.name.localeCompare(b.name, 'de');
      case 'name-desc':
        return b.name.localeCompare(a.name, 'de');
      case 'status':
        var order = { 'Aktiv': 0, 'Entwurf': 1, 'Inaktiv': 2 };
        return (order[a.status] || 3) - (order[b.status] || 3);
      case 'date-desc':
        return new Date(b.modified) - new Date(a.modified);
      case 'date-asc':
        return new Date(a.modified) - new Date(b.modified);
      default:
        return 0;
    }
  });

  const grid = document.getElementById('agent-grid');
  const emptyState = document.getElementById('empty-state');

  if (filtered.length === 0) {
    grid.style.display = 'none';
    emptyState.style.display = '';
  } else {
    grid.style.display = '';
    emptyState.style.display = 'none';
  }

  grid.innerHTML = filtered.map(function(agent) {
    return renderCard(agent);
  }).join('');

  updateStats();
}

function renderCard(agent) {
  var statusClass = agent.status === 'Aktiv' ? 'aktiv' : (agent.status === 'Entwurf' ? 'entwurf' : 'inaktiv');
  var avatarColor = agent.avatarColor || AVATAR_COLORS[Math.floor(Math.random() * AVATAR_COLORS.length)];
  var durationFormatted = formatDuration(agent.avgDuration || 0);
  var modifiedFormatted = formatDate(agent.modified);
  var toggleIcon = agent.status === 'Aktiv' ? 'fa-pause' : 'fa-play';
  var toggleTitle = agent.status === 'Aktiv' ? 'Deaktivieren' : 'Aktivieren';

  return '<div class="agent-card" data-id="' + agent.id + '">' +
    '<div class="agent-card-header">' +
      '<div class="agent-avatar ' + avatarColor + '"><i class="fa-solid fa-robot"></i></div>' +
      '<div class="agent-header-info">' +
        '<div class="agent-name" title="' + escapeHtml(agent.name) + '">' + escapeHtml(agent.name) + '</div>' +
        '<div class="agent-branch">' + escapeHtml(agent.branch) + '</div>' +
      '</div>' +
      '<span class="agent-status-badge ' + statusClass + '">' + escapeHtml(agent.status) + '</span>' +
    '</div>' +
    '<div class="agent-card-body">' +
      '<div class="agent-detail-row"><i class="fa-solid fa-phone"></i><span>' + escapeHtml(agent.phone || '–') + '</span></div>' +
      '<div class="agent-detail-row"><i class="fa-solid fa-volume-high"></i><span>' + escapeHtml(agent.voice) + '</span></div>' +
      '<div class="agent-detail-row"><i class="fa-solid fa-microchip"></i><span>' + escapeHtml(agent.model) + '</span></div>' +
      '<div class="agent-kpis">' +
        '<div class="agent-kpi"><div class="agent-kpi-value">' + (agent.callsToday || 0) + '</div><div class="agent-kpi-label">Anrufe heute</div></div>' +
        '<div class="agent-kpi"><div class="agent-kpi-value" style="color:' + (agent.successRate >= 85 ? '#15803d' : (agent.successRate >= 70 ? '#d97706' : '#6b7280')) + '">' + (agent.successRate || 0) + '%</div><div class="agent-kpi-label">Erfolgsrate</div></div>' +
        '<div class="agent-kpi"><div class="agent-kpi-value">' + durationFormatted + '</div><div class="agent-kpi-label">Ø Dauer</div></div>' +
      '</div>' +
    '</div>' +
    '<div class="agent-card-footer">' +
      '<span class="agent-modified"><i class="fa-regular fa-clock" style="margin-right:4px"></i>' + modifiedFormatted + '</span>' +
      '<div class="agent-actions">' +
        '<button title="Bearbeiten" onclick="editAgent(\'' + agent.id + '\')"><i class="fa-solid fa-pen"></i></button>' +
        '<button title="Duplizieren" onclick="duplicateAgent(\'' + agent.id + '\')"><i class="fa-solid fa-copy"></i></button>' +
        '<button class="success" title="' + toggleTitle + '" onclick="toggleAgent(\'' + agent.id + '\')"><i class="fa-solid ' + toggleIcon + '"></i></button>' +
        '<button class="danger" title="Loeschen" onclick="deleteAgent(\'' + agent.id + '\')"><i class="fa-solid fa-trash"></i></button>' +
      '</div>' +
    '</div>' +
  '</div>';
}

function formatDuration(seconds) {
  if (!seconds || seconds === 0) return '–';
  var m = Math.floor(seconds / 60);
  var s = seconds % 60;
  return m + ':' + String(s).padStart(2, '0');
}

function formatDate(isoStr) {
  if (!isoStr) return '–';
  var d = new Date(isoStr);
  var day = String(d.getDate()).padStart(2, '0');
  var month = String(d.getMonth() + 1).padStart(2, '0');
  var year = d.getFullYear();
  var hours = String(d.getHours()).padStart(2, '0');
  var mins = String(d.getMinutes()).padStart(2, '0');
  return day + '.' + month + '.' + year + ' ' + hours + ':' + mins;
}

function escapeHtml(str) {
  if (!str) return '';
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

// ── Stats ──
function updateStats() {
  var agents = loadAgents();
  var total = agents.length;
  var active = agents.filter(function(a) { return a.status === 'Aktiv'; }).length;
  var draft = agents.filter(function(a) { return a.status === 'Entwurf'; }).length;
  var activeAgents = agents.filter(function(a) { return a.status === 'Aktiv' && a.successRate > 0; });
  var avgSuccess = 0;
  if (activeAgents.length > 0) {
    var sum = activeAgents.reduce(function(acc, a) { return acc + a.successRate; }, 0);
    avgSuccess = Math.round(sum / activeAgents.length);
  }

  document.getElementById('stat-total').textContent = total;
  document.getElementById('stat-active').textContent = active;
  document.getElementById('stat-draft').textContent = draft;
  document.getElementById('stat-success').textContent = avgSuccess + '%';
}

// ── Filters ──
function applyFilters() {
  renderAgents();
}

// ── Create / Edit Modal ──
function openCreateModal() {
  document.getElementById('edit-agent-id').value = '';
  document.getElementById('modal-title').textContent = 'Neuen Agent erstellen';
  document.getElementById('modal-name').value = '';
  document.getElementById('modal-branch').value = 'Arztpraxis';
  document.getElementById('modal-status').value = 'Entwurf';
  document.getElementById('modal-phone').value = '';
  document.getElementById('modal-voice').value = 'KatjaNeural';
  document.getElementById('modal-model').value = 'Llama 3.1 8B';
  document.getElementById('modal-calls').value = '0';
  document.getElementById('modal-success').value = '0';
  document.getElementById('modal-duration').value = '0';
  document.getElementById('modal-save-btn').innerHTML = '<i class="fa-solid fa-floppy-disk" style="margin-right:6px"></i> Erstellen';
  document.getElementById('agent-modal').classList.add('show');
}

function editAgent(id) {
  var agents = loadAgents();
  var agent = agents.find(function(a) { return a.id === id; });
  if (!agent) return;

  document.getElementById('edit-agent-id').value = agent.id;
  document.getElementById('modal-title').textContent = 'Agent bearbeiten';
  document.getElementById('modal-name').value = agent.name;
  document.getElementById('modal-branch').value = agent.branch;
  document.getElementById('modal-status').value = agent.status;
  document.getElementById('modal-phone').value = agent.phone || '';
  document.getElementById('modal-voice').value = agent.voice;
  document.getElementById('modal-model').value = agent.model;
  document.getElementById('modal-calls').value = agent.callsToday || 0;
  document.getElementById('modal-success').value = agent.successRate || 0;
  document.getElementById('modal-duration').value = agent.avgDuration || 0;
  document.getElementById('modal-save-btn').innerHTML = '<i class="fa-solid fa-floppy-disk" style="margin-right:6px"></i> Speichern';
  document.getElementById('agent-modal').classList.add('show');
}

function closeModal() {
  document.getElementById('agent-modal').classList.remove('show');
}

function saveAgent() {
  var name = document.getElementById('modal-name').value.trim();
  if (!name) {
    document.getElementById('modal-name').style.borderColor = '#ef4444';
    document.getElementById('modal-name').focus();
    return;
  }
  document.getElementById('modal-name').style.borderColor = '#e2e8f0';

  var agents = loadAgents();
  var editId = document.getElementById('edit-agent-id').value;
  var now = new Date().toISOString();

  if (editId) {
    // Update existing
    var idx = agents.findIndex(function(a) { return a.id === editId; });
    if (idx !== -1) {
      agents[idx].name = name;
      agents[idx].branch = document.getElementById('modal-branch').value;
      agents[idx].status = document.getElementById('modal-status').value;
      agents[idx].phone = document.getElementById('modal-phone').value;
      agents[idx].voice = document.getElementById('modal-voice').value;
      agents[idx].model = document.getElementById('modal-model').value;
      agents[idx].callsToday = parseInt(document.getElementById('modal-calls').value) || 0;
      agents[idx].successRate = parseInt(document.getElementById('modal-success').value) || 0;
      agents[idx].avgDuration = parseInt(document.getElementById('modal-duration').value) || 0;
      agents[idx].modified = now;
    }
  } else {
    // Create new
    var newAgent = {
      id: generateId(),
      name: name,
      branch: document.getElementById('modal-branch').value,
      status: document.getElementById('modal-status').value,
      phone: document.getElementById('modal-phone').value,
      voice: document.getElementById('modal-voice').value,
      model: document.getElementById('modal-model').value,
      callsToday: parseInt(document.getElementById('modal-calls').value) || 0,
      successRate: parseInt(document.getElementById('modal-success').value) || 0,
      avgDuration: parseInt(document.getElementById('modal-duration').value) || 0,
      modified: now,
      avatarColor: AVATAR_COLORS[agents.length % AVATAR_COLORS.length]
    };
    agents.push(newAgent);
  }

  saveAgents(agents);
  closeModal();
  renderAgents();
}

// ── Duplicate ──
function duplicateAgent(id) {
  var agents = loadAgents();
  var agent = agents.find(function(a) { return a.id === id; });
  if (!agent) return;

  var copy = JSON.parse(JSON.stringify(agent));
  copy.id = generateId();
  copy.name = agent.name + ' (Kopie)';
  copy.status = 'Entwurf';
  copy.callsToday = 0;
  copy.successRate = 0;
  copy.avgDuration = 0;
  copy.modified = new Date().toISOString();
  copy.avatarColor = AVATAR_COLORS[agents.length % AVATAR_COLORS.length];

  agents.push(copy);
  saveAgents(agents);
  renderAgents();
}

// ── Toggle Active / Inactive ──
function toggleAgent(id) {
  var agents = loadAgents();
  var agent = agents.find(function(a) { return a.id === id; });
  if (!agent) return;

  if (agent.status === 'Aktiv') {
    agent.status = 'Inaktiv';
  } else {
    agent.status = 'Aktiv';
  }
  agent.modified = new Date().toISOString();

  saveAgents(agents);
  renderAgents();
}

// ── Delete ──
function deleteAgent(id) {
  var agents = loadAgents();
  var agent = agents.find(function(a) { return a.id === id; });
  if (!agent) return;

  deleteTargetId = id;
  document.getElementById('delete-agent-name').textContent = agent.name;
  document.getElementById('delete-modal').classList.add('show');
}

function closeDeleteModal() {
  document.getElementById('delete-modal').classList.remove('show');
  deleteTargetId = null;
}

function confirmDelete() {
  if (!deleteTargetId) return;
  var agents = loadAgents();
  agents = agents.filter(function(a) { return a.id !== deleteTargetId; });
  saveAgents(agents);
  closeDeleteModal();
  renderAgents();
}

// ── Close modals on overlay click ──
document.getElementById('agent-modal').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});
document.getElementById('delete-modal').addEventListener('click', function(e) {
  if (e.target === this) closeDeleteModal();
});

// ── Close modals on Escape ──
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    closeModal();
    closeDeleteModal();
  }
});

// ── Live Clock ──
setInterval(function() {
  var now = new Date();
  var t = now.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
  document.querySelectorAll('.live-badge').forEach(function(b) {
    if (b.textContent.includes('Online') || b.textContent.includes('System')) {
      b.innerHTML = '<span class="live-dot"></span> System Online · ' + t;
    }
  });
}, 30000);

// ── Init ──
renderAgents();
</script>
</body>
</html>

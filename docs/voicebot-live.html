<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MED Rezeption - Voicebot Live</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        .vb-live-container {
            max-width: 800px;
            margin: 0 auto;
        }
        .vb-live-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        .vb-live-status.verbunden { background: #dcfce7; color: #166534; }
        .vb-live-status.getrennt { background: #fee2e2; color: #991b1b; }
        .vb-live-status.verbindet { background: #fef9c3; color: #854d0e; }
        .vb-live-status.spricht { background: #dbeafe; color: #1e40af; }

        .vb-call-panel {
            text-align: center;
            padding: 32px 16px;
        }
        .vb-branche-select {
            width: 100%;
            max-width: 360px;
            padding: 12px 16px;
            font-size: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            background: #fff;
            margin-bottom: 24px;
        }
        .vb-branche-select:focus { border-color: #3b82f6; outline: none; }

        .vb-call-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 88px;
            height: 88px;
            border-radius: 50%;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.2s;
            color: #fff;
        }
        .vb-call-btn.anrufen { background: #22c55e; }
        .vb-call-btn.anrufen:hover { background: #16a34a; transform: scale(1.05); }
        .vb-call-btn.auflegen { background: #ef4444; }
        .vb-call-btn.auflegen:hover { background: #dc2626; transform: scale(1.05); }
        .vb-call-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }

        .vb-call-label {
            display: block;
            margin-top: 8px;
            font-size: 0.85rem;
            color: #64748b;
        }

        .vb-audio-viz {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 3px;
            height: 48px;
            margin: 20px 0;
        }
        .vb-audio-bar {
            width: 5px;
            background: #3b82f6;
            border-radius: 3px;
            transition: height 0.05s;
            min-height: 3px;
        }
        .vb-audio-viz.inaktiv .vb-audio-bar { background: #cbd5e1; height: 3px !important; }

        .vb-timer {
            font-size: 1.5rem;
            font-weight: 700;
            color: #334155;
            font-variant-numeric: tabular-nums;
        }

        .vb-transcript {
            max-height: 400px;
            overflow-y: auto;
            padding: 16px;
        }
        .vb-msg {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            animation: vb-fadein 0.3s;
        }
        @keyframes vb-fadein { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }

        .vb-msg-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 0.85rem;
        }
        .vb-msg.bot .vb-msg-icon { background: #dbeafe; color: #2563eb; }
        .vb-msg.anrufer .vb-msg-icon { background: #dcfce7; color: #16a34a; }
        .vb-msg.system .vb-msg-icon { background: #f1f5f9; color: #64748b; }

        .vb-msg-content {
            flex: 1;
        }
        .vb-msg-rolle {
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748b;
            margin-bottom: 2px;
        }
        .vb-msg-text {
            font-size: 0.95rem;
            color: #1e293b;
            line-height: 1.4;
        }
        .vb-msg.system .vb-msg-text { color: #64748b; font-style: italic; font-size: 0.85rem; }

        .vb-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        .vb-info-item {
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            text-align: center;
        }
        .vb-info-label { font-size: 0.75rem; color: #64748b; }
        .vb-info-value { font-size: 1.1rem; font-weight: 700; color: #1e293b; }

        .vb-zusammenfassung {
            margin-top: 16px;
            padding: 16px;
            background: #eff6ff;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }
        .vb-zusammenfassung h4 { margin: 0 0 8px; color: #1e40af; font-size: 0.9rem; }
        .vb-zusammenfassung p { margin: 0; color: #334155; font-size: 0.9rem; line-height: 1.5; }
    </style>
</head>
<body>
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-logo"><h2>MED Rezeption</h2><small>Praxisverwaltung</small></div>
        <nav class="sidebar-nav">
            <a href="dashboard.html"><i class="fa-solid fa-chart-pie nav-icon"></i> Dashboard</a>
            <a href="patienten.html"><i class="fa-solid fa-users nav-icon"></i> Patienten</a>
            <a href="aerzte.html"><i class="fa-solid fa-user-doctor nav-icon"></i> Aerzte</a>
            <a href="termine.html"><i class="fa-solid fa-calendar-days nav-icon"></i> Termine</a>
            <a href="wartezimmer.html"><i class="fa-solid fa-couch nav-icon"></i> Wartezimmer</a>
            <a href="wissensdatenbank.html"><i class="fa-solid fa-book nav-icon"></i> Wissensdatenbank</a>
            <a href="ansagen.html"><i class="fa-solid fa-tower-broadcast nav-icon"></i> Ansagen Generator</a>
            <a href="auswertung.html"><i class="fa-solid fa-chart-line nav-icon"></i> Auswertungen</a>
            <a href="standort.html"><i class="fa-solid fa-building nav-icon"></i> Standort &amp; ACD</a>
            <a href="callflow.html"><i class="fa-solid fa-diagram-project nav-icon"></i> Callflow Editor</a>
            <a href="voicebot.html"><i class="fa-solid fa-robot nav-icon"></i> Voicebot</a>
            <a href="agenten.html"><i class="fa-solid fa-headset nav-icon"></i> Agenten</a>
            <a href="softphone.html"><i class="fa-solid fa-phone nav-icon"></i> Softphone</a>
            <a href="voicebot-live.html" class="active"><i class="fa-solid fa-microphone nav-icon"></i> Voicebot Live</a>
            <a href="uebersetzung.html"><i class="fa-solid fa-language nav-icon"></i> Uebersetzer</a>
            <a href="benutzer.html"><i class="fa-solid fa-user-gear nav-icon"></i> Benutzer</a>
        </nav>
        <div class="sidebar-footer"><button id="btn-demo-reset" type="button">Demo zuruecksetzen</button></div>
    </aside>
    <div class="main-wrapper">
        <header class="topbar">
            <button id="menu-toggle" type="button"><i class="fa-solid fa-bars"></i></button>
            <h1><i class="fa-solid fa-microphone"></i> Voicebot Live</h1>
            <div class="topbar-right">
                <div class="vb-live-status getrennt" id="vb-status">
                    <i class="fa-solid fa-circle"></i>
                    <span id="vb-status-text">Getrennt</span>
                </div>
            </div>
        </header>
        <main>
            <div class="vb-live-container">
                <!-- Anruf-Panel -->
                <section class="card">
                    <div class="vb-call-panel">
                        <div style="display:flex;flex-wrap:wrap;gap:16px;justify-content:center;margin-bottom:16px">
                            <div style="flex:1;min-width:200px;max-width:360px">
                                <label for="vb-branche" style="display:block;margin-bottom:6px;font-weight:600;color:#334155"><i class="fa-solid fa-building"></i> Branche</label>
                                <select id="vb-branche" class="vb-branche-select">
                                    <option value="arztpraxis">Arztpraxis</option>
                                    <option value="zahnarzt">Zahnarztpraxis</option>
                                    <option value="anwalt">Rechtsanwaltskanzlei</option>
                                    <option value="steuerberater">Steuerberatung</option>
                                    <option value="friseur">Friseursalon</option>
                                    <option value="werkstatt">KFZ-Werkstatt</option>
                                    <option value="tierarzt">Tierarztpraxis</option>
                                    <option value="allgemein">Allgemeines Buero</option>
                                </select>
                            </div>
                            <div style="flex:1;min-width:200px;max-width:360px">
                                <label for="vb-stimme" style="display:block;margin-bottom:6px;font-weight:600;color:#334155"><i class="fa-solid fa-microphone-lines"></i> Stimme</label>
                                <select id="vb-stimme" class="vb-branche-select">
                                    <option value="seraphina">Seraphina — Warm, natuerlich (Premium)</option>
                                    <option value="florian">Florian — Professionell, klar (Premium)</option>
                                    <option value="katja">Katja — Freundlich, klassisch</option>
                                    <option value="conrad">Conrad — Sachlich, kompetent</option>
                                    <option value="amala">Amala — Sanft, einfuehlsam</option>
                                    <option value="killian">Killian — Dynamisch, jung</option>
                                    <option value="louisa">Louisa — Herzlich, vertrauensvoll</option>
                                    <option value="ralf">Ralf — Ruhig, gelassen</option>
                                </select>
                            </div>
                            <div style="flex:1;min-width:200px;max-width:360px">
                                <label for="vb-hintergrund" style="display:block;margin-bottom:6px;font-weight:600;color:#334155"><i class="fa-solid fa-volume-low"></i> Hintergrund</label>
                                <select id="vb-hintergrund" class="vb-branche-select">
                                    <option value="buero">Buero — Leises Ambiente</option>
                                    <option value="praxis">Arztpraxis — Ruhige Atmosphaere</option>
                                    <option value="ruhig">Sehr ruhig — Minimales Rauschen</option>
                                    <option value="keine">Kein Hintergrund — Stille</option>
                                </select>
                            </div>
                        </div>

                        <div class="vb-audio-viz inaktiv" id="vb-viz">
                            <div class="vb-audio-bar"></div>
                            <div class="vb-audio-bar"></div>
                            <div class="vb-audio-bar"></div>
                            <div class="vb-audio-bar"></div>
                            <div class="vb-audio-bar"></div>
                            <div class="vb-audio-bar"></div>
                            <div class="vb-audio-bar"></div>
                            <div class="vb-audio-bar"></div>
                            <div class="vb-audio-bar"></div>
                            <div class="vb-audio-bar"></div>
                            <div class="vb-audio-bar"></div>
                            <div class="vb-audio-bar"></div>
                            <div class="vb-audio-bar"></div>
                            <div class="vb-audio-bar"></div>
                            <div class="vb-audio-bar"></div>
                            <div class="vb-audio-bar"></div>
                        </div>

                        <div class="vb-timer" id="vb-timer">00:00</div>

                        <div style="margin-top: 20px;">
                            <button type="button" class="vb-call-btn anrufen" id="btn-anrufen" title="Anruf starten">
                                <i class="fa-solid fa-phone"></i>
                            </button>
                            <button type="button" class="vb-call-btn auflegen" id="btn-auflegen" title="Auflegen" hidden>
                                <i class="fa-solid fa-phone-slash"></i>
                            </button>
                            <span class="vb-call-label" id="vb-call-label">Anruf starten</span>
                        </div>
                    </div>
                </section>

                <!-- Info-Grid -->
                <div class="vb-info-grid" id="vb-info-grid" hidden>
                    <div class="vb-info-item">
                        <div class="vb-info-label">Nachrichten</div>
                        <div class="vb-info-value" id="vb-info-msgs">0</div>
                    </div>
                    <div class="vb-info-item">
                        <div class="vb-info-label">Erkannte Woerter</div>
                        <div class="vb-info-value" id="vb-info-words">0</div>
                    </div>
                </div>

                <!-- Transcript -->
                <section class="card" id="vb-transcript-card" hidden>
                    <h2><i class="fa-solid fa-comments"></i> Gespraechsverlauf</h2>
                    <div class="vb-transcript" id="vb-transcript"></div>
                    <div id="vb-zusammenfassung-bereich"></div>
                </section>
            </div>
        </main>
    </div>

    <script>
    (function() {
        "use strict";

        // --- Elemente ---
        var btnAnrufen = document.getElementById("btn-anrufen");
        var btnAuflegen = document.getElementById("btn-auflegen");
        var brancheSelect = document.getElementById("vb-branche");
        var statusEl = document.getElementById("vb-status");
        var statusText = document.getElementById("vb-status-text");
        var timerEl = document.getElementById("vb-timer");
        var callLabel = document.getElementById("vb-call-label");
        var vizEl = document.getElementById("vb-viz");
        var vizBars = vizEl.querySelectorAll(".vb-audio-bar");
        var transcriptEl = document.getElementById("vb-transcript");
        var transcriptCard = document.getElementById("vb-transcript-card");
        var infoGrid = document.getElementById("vb-info-grid");
        var infoMsgs = document.getElementById("vb-info-msgs");
        var infoWords = document.getElementById("vb-info-words");
        var zusammenfassungBereich = document.getElementById("vb-zusammenfassung-bereich");
        var stimmeSelect = document.getElementById("vb-stimme");
        var hintergrundSelect = document.getElementById("vb-hintergrund");

        // --- State ---
        var ws = null;
        var audioContext = null;
        var mediaStream = null;
        var scriptNode = null;
        var timerInterval = null;
        var timerSekunden = 0;
        var nachrichtenCount = 0;
        var woerterCount = 0;
        var istAktiv = false;
        var SOURCE_RATE = 48000;
        var TARGET_RATE = 16000;

        // --- Status-Anzeige ---
        function setStatus(typ, text) {
            statusEl.className = "vb-live-status " + typ;
            statusText.textContent = text;
        }

        // --- Timer ---
        function timerStarten() {
            timerSekunden = 0;
            timerEl.textContent = "00:00";
            timerInterval = setInterval(function() {
                timerSekunden++;
                var m = Math.floor(timerSekunden / 60);
                var s = timerSekunden % 60;
                timerEl.textContent = (m < 10 ? "0" : "") + m + ":" + (s < 10 ? "0" : "") + s;
            }, 1000);
        }

        function timerStoppen() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        // --- Audio-Visualisierung ---
        function vizAktualisieren(audioData) {
            if (!audioData || audioData.length === 0) {
                vizEl.classList.add("inaktiv");
                return;
            }
            vizEl.classList.remove("inaktiv");

            var chunkSize = Math.floor(audioData.length / vizBars.length);
            for (var i = 0; i < vizBars.length; i++) {
                var sum = 0;
                for (var j = 0; j < chunkSize; j++) {
                    sum += Math.abs(audioData[i * chunkSize + j] || 0);
                }
                var avg = sum / chunkSize;
                var h = Math.max(3, Math.min(48, avg * 300));
                vizBars[i].style.height = h + "px";
            }
        }

        function vizReset() {
            vizEl.classList.add("inaktiv");
            for (var i = 0; i < vizBars.length; i++) {
                vizBars[i].style.height = "3px";
            }
        }

        // --- Transcript ---
        function msgHinzufuegen(rolle, text) {
            transcriptCard.hidden = false;
            nachrichtenCount++;
            infoGrid.hidden = false;
            infoMsgs.textContent = nachrichtenCount;

            var icon, rolleText;
            if (rolle === "bot") {
                icon = "fa-robot";
                rolleText = "Voicebot";
            } else if (rolle === "anrufer") {
                icon = "fa-user";
                rolleText = "Sie";
                woerterCount += text.split(/\s+/).length;
                infoWords.textContent = woerterCount;
            } else {
                icon = "fa-info-circle";
                rolleText = "System";
            }

            var div = document.createElement("div");
            div.className = "vb-msg " + rolle;
            div.innerHTML =
                '<div class="vb-msg-icon"><i class="fa-solid ' + icon + '"></i></div>' +
                '<div class="vb-msg-content">' +
                    '<div class="vb-msg-rolle">' + rolleText + '</div>' +
                    '<div class="vb-msg-text">' + escapeHtml(text) + '</div>' +
                '</div>';
            transcriptEl.appendChild(div);
            transcriptEl.scrollTop = transcriptEl.scrollHeight;
        }

        function escapeHtml(str) {
            var div = document.createElement("div");
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        // --- Audio-Resampling: Browser-Rate -> 16kHz ---
        function downsample(buffer, fromRate, toRate) {
            if (fromRate === toRate) return buffer;
            var ratio = fromRate / toRate;
            var newLength = Math.round(buffer.length / ratio);
            var result = new Float32Array(newLength);
            for (var i = 0; i < newLength; i++) {
                var pos = i * ratio;
                var idx = Math.floor(pos);
                var frac = pos - idx;
                if (idx + 1 < buffer.length) {
                    result[i] = buffer[idx] * (1 - frac) + buffer[idx + 1] * frac;
                } else {
                    result[i] = buffer[idx];
                }
            }
            return result;
        }

        // --- Float32 -> Int16 PCM ---
        function float32ToInt16(buffer) {
            var buf = new Int16Array(buffer.length);
            for (var i = 0; i < buffer.length; i++) {
                var s = Math.max(-1, Math.min(1, buffer[i]));
                buf[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
            }
            return buf.buffer;
        }

        // --- WAV-Audio abspielen ---
        function audioAbspielen(wavBytes) {
            if (!audioContext) return;
            var arrayBuffer = wavBytes instanceof ArrayBuffer ? wavBytes : wavBytes.buffer.slice(wavBytes.byteOffset, wavBytes.byteOffset + wavBytes.byteLength);

            audioContext.decodeAudioData(arrayBuffer.slice(0), function(audioBuffer) {
                var source = audioContext.createBufferSource();
                source.buffer = audioBuffer;
                source.connect(audioContext.destination);
                source.start(0);
                setStatus("spricht", "Bot spricht...");
                source.onended = function() {
                    if (istAktiv) {
                        setStatus("verbunden", "Verbunden — Sprechen Sie...");
                    }
                };
            }, function(err) {
                console.warn("Audio-Decode Fehler:", err);
            });
        }

        // --- WebSocket-URL ermitteln ---
        function wsUrl(kanalId) {
            var proto = location.protocol === "https:" ? "wss:" : "ws:";
            var host = location.host;
            return proto + "//" + host + "/ws/voicebot/" + kanalId;
        }

        // --- Anruf starten ---
        function anrufStarten() {
            if (istAktiv) return;

            // UI aktualisieren
            btnAnrufen.hidden = true;
            btnAuflegen.hidden = false;
            callLabel.textContent = "Auflegen";
            brancheSelect.disabled = true;
            stimmeSelect.disabled = true;
            hintergrundSelect.disabled = true;
            setStatus("verbindet", "Verbinde...");
            transcriptEl.innerHTML = "";
            zusammenfassungBereich.innerHTML = "";
            nachrichtenCount = 0;
            woerterCount = 0;
            infoMsgs.textContent = "0";
            infoWords.textContent = "0";

            var kanalId = "webrtc-" + Date.now();
            var branche = brancheSelect.value;
            var stimme = stimmeSelect.value;
            var hintergrund = hintergrundSelect.value;

            // AudioContext erstellen
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            SOURCE_RATE = audioContext.sampleRate;

            // Mikrofon anfordern (erfordert HTTPS oder localhost)
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                setStatus("getrennt", "HTTPS erforderlich");
                msgHinzufuegen("system", "Mikrofon-Zugriff erfordert HTTPS. Bitte mit https:// aufrufen oder Chrome-Flag setzen: chrome://flags/#unsafely-treat-insecure-origin-as-secure");
                btnAnrufen.hidden = false;
                btnAuflegen.hidden = true;
                callLabel.textContent = "Anruf starten";
                brancheSelect.disabled = false;
                stimmeSelect.disabled = false;
                hintergrundSelect.disabled = false;
                return;
            }
            navigator.mediaDevices.getUserMedia({ audio: true, video: false })
                .then(function(stream) {
                    mediaStream = stream;

                    // WebSocket verbinden
                    ws = new WebSocket(wsUrl(kanalId));
                    ws.binaryType = "arraybuffer";

                    ws.onopen = function() {
                        istAktiv = true;
                        setStatus("verbunden", "Verbunden");
                        timerStarten();
                        msgHinzufuegen("system", "Verbindung hergestellt — Branche: " + brancheSelect.options[brancheSelect.selectedIndex].text);

                        // Start-Nachricht mit Branche, Stimme und Hintergrund senden
                        ws.send(JSON.stringify({
                            typ: "start",
                            branche: branche,
                            stimme: stimme,
                            hintergrund: hintergrund
                        }));

                        // Audio-Streaming starten
                        audioStreamStarten(stream);
                    };

                    ws.onmessage = function(event) {
                        if (typeof event.data === "string") {
                            var msg = JSON.parse(event.data);

                            if (msg.typ === "begruessung") {
                                msgHinzufuegen("bot", msg.text);
                            } else if (msg.typ === "antwort") {
                                if (msg.erkannt) {
                                    msgHinzufuegen("anrufer", msg.erkannt);
                                }
                                msgHinzufuegen("bot", msg.text);
                            } else if (msg.typ === "beendet") {
                                msgHinzufuegen("system", "Gespraech beendet (" + msg.nachrichten + " Nachrichten)");
                                if (msg.zusammenfassung) {
                                    zusammenfassungBereich.innerHTML =
                                        '<div class="vb-zusammenfassung">' +
                                        '<h4><i class="fa-solid fa-clipboard-list"></i> Zusammenfassung</h4>' +
                                        '<p>' + escapeHtml(msg.zusammenfassung) + '</p>' +
                                        '</div>';
                                }
                                anrufBeenden();
                            } else if (msg.typ === "ansage") {
                                msgHinzufuegen("bot", msg.text);
                            }
                        } else {
                            // Binary = WAV Audio vom Bot
                            audioAbspielen(event.data);
                        }
                    };

                    ws.onerror = function() {
                        msgHinzufuegen("system", "Verbindungsfehler");
                        anrufBeenden();
                    };

                    ws.onclose = function() {
                        if (istAktiv) {
                            msgHinzufuegen("system", "Verbindung getrennt");
                            anrufBeenden();
                        }
                    };
                })
                .catch(function(err) {
                    console.error("Mikrofon-Fehler:", err);
                    msgHinzufuegen("system", "Mikrofon-Zugriff verweigert: " + err.message);
                    setStatus("getrennt", "Mikrofon verweigert");
                    btnAnrufen.hidden = false;
                    btnAuflegen.hidden = true;
                    callLabel.textContent = "Anruf starten";
                    brancheSelect.disabled = false;
                    stimmeSelect.disabled = false;
                    hintergrundSelect.disabled = false;
                });
        }

        // --- Audio-Stream zum WebSocket ---
        function audioStreamStarten(stream) {
            var source = audioContext.createMediaStreamSource(stream);

            // ScriptProcessorNode fuer Audio-Chunks (4096 Samples pro Chunk)
            scriptNode = audioContext.createScriptProcessor(4096, 1, 1);

            scriptNode.onaudioprocess = function(event) {
                if (!istAktiv || !ws || ws.readyState !== WebSocket.OPEN) return;

                var inputData = event.inputBuffer.getChannelData(0);

                // Visualisierung aktualisieren
                vizAktualisieren(inputData);

                // Downsample auf 16kHz
                var resampled = downsample(inputData, SOURCE_RATE, TARGET_RATE);

                // Float32 -> Int16 PCM
                var pcmData = float32ToInt16(resampled);

                // An WebSocket senden
                ws.send(pcmData);
            };

            source.connect(scriptNode);
            scriptNode.connect(audioContext.destination);
        }

        // --- Anruf beenden ---
        function anrufBeenden() {
            istAktiv = false;
            timerStoppen();

            // WebSocket schliessen
            if (ws) {
                if (ws.readyState === WebSocket.OPEN) {
                    try {
                        ws.send(JSON.stringify({ typ: "beenden" }));
                    } catch(e) { /* ignore */ }
                }
                ws.close();
                ws = null;
            }

            // Audio stoppen
            if (scriptNode) {
                scriptNode.disconnect();
                scriptNode = null;
            }
            if (mediaStream) {
                mediaStream.getTracks().forEach(function(track) { track.stop(); });
                mediaStream = null;
            }
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }

            // UI aktualisieren
            vizReset();
            setStatus("getrennt", "Getrennt");
            btnAnrufen.hidden = false;
            btnAuflegen.hidden = true;
            callLabel.textContent = "Anruf starten";
            brancheSelect.disabled = false;
            stimmeSelect.disabled = false;
            hintergrundSelect.disabled = false;
        }

        // --- Event-Listener ---
        btnAnrufen.addEventListener("click", anrufStarten);
        btnAuflegen.addEventListener("click", function() {
            anrufBeenden();
        });

        // Sidebar Toggle
        var menuToggle = document.getElementById("menu-toggle");
        var sidebar = document.getElementById("sidebar");
        if (menuToggle && sidebar) {
            menuToggle.addEventListener("click", function() {
                sidebar.classList.toggle("collapsed");
            });
        }
    })();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MED Rezeption - Komplette Demo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

:root {
    --primary: #0891b2;
    --primary-dark: #0e7490;
    --sidebar-bg: #0f172a;
    --sidebar-text: #94a3b8;
    --sidebar-active: #22d3ee;
    --success: #22c55e;
    --warning: #f59e0b;
    --danger: #ef4444;
    --info: #06b6d4;
    --bg: #f0f9ff;
    --card: #ffffff;
    --text: #0f172a;
    --text-muted: #64748b;
    --border: #e0f2fe;
    --radius: 8px;
}

body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    display: flex;
    min-height: 100vh;
}

/* ===== Sidebar ===== */

.sidebar {
    width: 240px;
    background: var(--sidebar-bg);
    color: var(--sidebar-text);
    display: flex;
    flex-direction: column;
    position: fixed;
    top: 0;
    left: 0;
    bottom: 0;
    z-index: 100;
    transition: transform 0.3s;
}

.sidebar-logo {
    padding: 1.25rem 1rem;
    border-bottom: 1px solid rgba(255,255,255,0.08);
    text-align: center;
}

.sidebar-logo h2 {
    color: #fff;
    font-size: 1.2rem;
    margin-bottom: 0.15rem;
}

.sidebar-logo small {
    color: var(--sidebar-text);
    font-size: 0.75rem;
}

.sidebar-nav {
    flex: 1;
    padding: 0.75rem 0;
    overflow-y: auto;
}

.sidebar-nav a {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.65rem 1.25rem;
    color: var(--sidebar-text);
    text-decoration: none;
    font-size: 0.9rem;
    transition: all 0.15s;
    border-left: 3px solid transparent;
}

.sidebar-nav a:hover {
    color: #fff;
    background: rgba(255,255,255,0.06);
}

.sidebar-nav a.active {
    color: #fff;
    background: rgba(59,130,246,0.15);
    border-left-color: var(--sidebar-active);
}

.sidebar-nav .nav-icon {
    font-size: 1.1rem;
    width: 1.5rem;
    text-align: center;
}

.sidebar-footer {
    padding: 1rem;
    border-top: 1px solid rgba(255,255,255,0.08);
}

.sidebar-footer button {
    width: 100%;
    padding: 0.5rem;
    background: rgba(255,255,255,0.08);
    color: var(--sidebar-text);
    border: none;
    border-radius: var(--radius);
    font-size: 0.8rem;
    cursor: pointer;
}

.sidebar-footer button:hover {
    background: rgba(255,255,255,0.15);
    color: #fff;
}

/* ===== Main Content ===== */

.main-wrapper {
    flex: 1;
    margin-left: 240px;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
}

.topbar {
    background: var(--card);
    border-bottom: 1px solid var(--border);
    padding: 0.75rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 50;
}

.topbar h1 {
    font-size: 1.25rem;
    color: var(--text);
}

.topbar-right {
    display: flex;
    align-items: center;
    gap: 1rem;
    font-size: 0.85rem;
    color: var(--text-muted);
}

#menu-toggle {
    display: none;
    background: none;
    border: none;
    font-size: 1.4rem;
    color: var(--text);
    cursor: pointer;
    padding: 0.25rem;
}

main {
    flex: 1;
    padding: 1.5rem;
}

/* ===== Cards ===== */

.card {
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    padding: 1.5rem;
    margin-bottom: 1.25rem;
    border: 1px solid var(--border);
}

.card h2 {
    font-size: 1.1rem;
    margin-bottom: 1rem;
}

.card h3 {
    font-size: 1rem;
    margin-bottom: 0.75rem;
}

/* ===== Stat Cards (Dashboard) ===== */

.stat-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 1rem;
    margin-bottom: 1.5rem;
}

.stat-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1.25rem;
    text-align: center;
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
}

.stat-card .stat-icon {
    font-size: 1.8rem;
    margin-bottom: 0.5rem;
}

.stat-card .stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary);
    line-height: 1;
}

.stat-card .stat-label {
    color: var(--text-muted);
    font-size: 0.85rem;
    margin-top: 0.25rem;
}

/* ===== Forms ===== */

.form-group {
    margin-bottom: 1rem;
}

.form-row {
    display: flex;
    gap: 1rem;
}

.form-row .form-group {
    flex: 1;
}

label {
    display: block;
    margin-bottom: 0.3rem;
    font-weight: 600;
    font-size: 0.85rem;
    color: var(--text-muted);
}

input, select, textarea {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    font-size: 0.95rem;
    font-family: inherit;
    background: #fff;
    transition: border-color 0.15s;
}

input:focus, select:focus, textarea:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(8,145,178,0.12);
}

fieldset {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1rem;
    margin-bottom: 1rem;
}

legend {
    font-weight: 600;
    padding: 0 0.5rem;
    font-size: 0.9rem;
}

/* ===== Buttons ===== */

button {
    padding: 0.55rem 1.25rem;
    background: var(--primary);
    color: white;
    border: none;
    border-radius: var(--radius);
    font-size: 0.9rem;
    font-family: inherit;
    cursor: pointer;
    transition: background 0.15s;
}

button:hover {
    background: var(--primary-dark);
}

.button-gruppe {
    display: flex;
    gap: 0.5rem;
    margin-top: 0.5rem;
}

.btn-secondary {
    background: #64748b;
}

.btn-secondary:hover {
    background: #475569;
}

#btn-abbrechen, #btn-patient-abbrechen, #btn-arzt-abbrechen,
#btn-termin-abbrechen, #btn-agent-abbrechen {
    background: #64748b;
}

#btn-abbrechen:hover, #btn-patient-abbrechen:hover, #btn-arzt-abbrechen:hover,
#btn-termin-abbrechen:hover, #btn-agent-abbrechen:hover {
    background: #475569;
}

/* ===== Alerts ===== */

.ergebnis, .erfolg-meldung {
    margin-top: 1rem;
    padding: 0.75rem 1rem;
    background: #dcfce7;
    border: 1px solid #86efac;
    border-radius: var(--radius);
    color: #166534;
    font-size: 0.9rem;
}

.fehler, .fehler-meldung {
    margin-top: 1rem;
    padding: 0.75rem 1rem;
    background: #fef2f2;
    border: 1px solid #fca5a5;
    border-radius: var(--radius);
    color: #991b1b;
    font-size: 0.9rem;
}

/* ===== Tables ===== */

.table-container {
    overflow-x: auto;
}

table {
    width: 100%;
    border-collapse: collapse;
}

th, td {
    text-align: left;
    padding: 0.6rem 0.75rem;
    border-bottom: 1px solid var(--border);
    font-size: 0.9rem;
}

th {
    background: #f8fafc;
    font-weight: 600;
    color: var(--text-muted);
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.03em;
}

tbody tr:hover {
    background: #f8fafc;
}

.aktionen {
    white-space: nowrap;
}

/* ===== Action Buttons (Table) ===== */

.btn-bearbeiten, .btn-loeschen {
    padding: 0.25rem 0.6rem;
    font-size: 0.8rem;
    border-radius: 4px;
}

.btn-bearbeiten {
    background: #f59e0b;
    color: #fff;
}

.btn-bearbeiten:hover {
    background: #d97706;
}

.btn-loeschen {
    background: var(--danger);
    color: white;
}

.btn-loeschen:hover {
    background: #dc2626;
}

/* ===== Section Layout ===== */

section + section, .card + .card {
    margin-top: 1.25rem;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.section-header h2 {
    margin-bottom: 0;
}

.verlauf-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.verlauf-header .btn-loeschen {
    padding: 0.25rem 0.75rem;
    font-size: 0.8rem;
}

/* ===== Search ===== */

.suche-box {
    position: relative;
    margin-bottom: 1rem;
}

.suche-box input {
    padding-left: 2.25rem;
}

.suche-box::before {
    content: "\1F50D";
    position: absolute;
    left: 0.75rem;
    top: 50%;
    transform: translateY(-50%);
    font-size: 0.85rem;
}

/* ===== Status Badges ===== */

.status-badge {
    display: inline-block;
    padding: 0.15rem 0.5rem;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 600;
}

.status-geplant { background: #e2e8f0; color: #475569; }
.status-bestaetigt { background: #dcfce7; color: #166534; }
.status-abgesagt { background: #fef2f2; color: #991b1b; }
.status-abgeschlossen { background: #cffafe; color: #155e75; }

.badge {
    background: var(--primary);
    color: white;
    padding: 0.2rem 0.6rem;
    border-radius: 999px;
    font-size: 0.8rem;
    font-weight: 600;
}

.badge-rot { background: var(--danger); }

/* ===== Wartezimmer Karten ===== */

.warte-karte {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1rem;
    margin-bottom: 0.75rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: box-shadow 0.15s;
}

.warte-karte:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.warte-karte.wartend {
    border-left: 4px solid var(--warning);
}

.warte-karte.aufgerufen {
    border-left: 4px solid var(--success);
    background: #f0fdf4;
}

.warte-info h3 {
    margin-bottom: 0.25rem;
    font-size: 1rem;
}

.warte-info p {
    color: var(--text-muted);
    font-size: 0.85rem;
}

.warte-aktionen {
    display: flex;
    gap: 0.5rem;
}

.btn-aufrufen {
    background: var(--success);
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
}

.btn-aufrufen:hover {
    background: #16a34a;
}

.btn-fertig {
    background: var(--info);
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
}

.btn-fertig:hover {
    background: #0891b2;
}

.wartezeit {
    font-weight: 600;
    color: #92400e;
}

/* ===== Dashboard Wartezimmer Mini ===== */

.warte-mini {
    padding: 0.5rem 0.75rem;
    border-left: 3px solid var(--warning);
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    border-radius: 0 4px 4px 0;
    background: #fefce8;
}

.warte-mini.aufgerufen {
    border-left-color: var(--success);
    background: #f0fdf4;
}

/* ===== Agenten Board ===== */

.agenten-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.agent-karte {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1rem;
    background: var(--card);
    transition: box-shadow 0.15s;
}

.agent-karte:hover {
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
}

.agent-karte .agent-status-punkt {
    display: inline-block;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-right: 0.5rem;
}

.agent-karte .agent-status-punkt.online { background: var(--success); }
.agent-karte .agent-status-punkt.offline { background: #94a3b8; }
.agent-karte .agent-status-punkt.pause { background: var(--warning); }
.agent-karte .agent-status-punkt.besetzt { background: var(--info); }
.agent-karte .agent-status-punkt.im_gespraech { background: var(--info); box-shadow: 0 0 0 3px rgba(6,182,212,0.25); }
.agent-karte .agent-status-punkt.azu { background: #dc2626; }
.agent-karte .agent-status-punkt.meeting { background: #7c3aed; }
.agent-karte .agent-status-punkt.at_chris { background: #0369a1; }

.agent-karte h3 {
    margin-bottom: 0.25rem;
    font-size: 0.95rem;
}

.agent-karte p {
    color: var(--text-muted);
    font-size: 0.85rem;
    margin-bottom: 0.15rem;
}

.agent-karte .agent-aktionen {
    display: flex;
    gap: 0.25rem;
    margin-top: 0.5rem;
    flex-wrap: wrap;
}

.agent-karte .agent-aktionen button {
    padding: 0.2rem 0.5rem;
    font-size: 0.75rem;
}

.agent-karte .agent-aktionen .btn-online { background: var(--success); }
.agent-karte .agent-aktionen .btn-online:hover { background: #16a34a; }
.agent-karte .agent-aktionen .btn-im_gespraech { background: var(--info); }
.agent-karte .agent-aktionen .btn-im_gespraech:hover { background: #0891b2; }
.agent-karte .agent-aktionen .btn-pause { background: var(--warning); color: #000; }
.agent-karte .agent-aktionen .btn-pause:hover { background: #d97706; }
.agent-karte .agent-aktionen .btn-azu { background: #dc2626; }
.agent-karte .agent-aktionen .btn-azu:hover { background: #b91c1c; }
.agent-karte .agent-aktionen .btn-meeting { background: #7c3aed; }
.agent-karte .agent-aktionen .btn-meeting:hover { background: #6d28d9; }
.agent-karte .agent-aktionen .btn-at_chris { background: #0369a1; }
.agent-karte .agent-aktionen .btn-at_chris:hover { background: #075985; }
.agent-karte .agent-aktionen .btn-offline { background: #94a3b8; }
.agent-karte .agent-aktionen .btn-offline:hover { background: #64748b; }

/* ===== Anruf Karten ===== */

.anruf-karte {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 0.75rem 1rem;
    margin-bottom: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-left: 4px solid var(--info);
}

.anruf-karte.klingelt {
    border-left-color: var(--warning);
    background: #fffbeb;
}

.anruf-karte.verbunden {
    border-left-color: var(--success);
    background: #f0fdf4;
}

/* ===== Softphone ===== */

.softphone-panel {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1.5rem;
    margin-bottom: 1rem;
    background: var(--card);
}

.softphone-panel h3 {
    margin-bottom: 1rem;
}

.sip-status {
    padding: 0.5rem 1rem;
    border-radius: var(--radius);
    font-weight: 600;
    text-align: center;
    margin-bottom: 1rem;
    font-size: 0.9rem;
}

.sip-status.online { background: #dcfce7; color: #166534; }
.sip-status.offline { background: #fef2f2; color: #991b1b; }
.sip-status.verbindend { background: #fef3c7; color: #92400e; }

.dialpad {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
    max-width: 250px;
    margin: 1rem auto;
}

.dialpad-taste {
    padding: 0.8rem;
    font-size: 1.2rem;
    background: #f8fafc;
    color: var(--text);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    cursor: pointer;
    transition: background 0.15s;
}

.dialpad-taste:hover {
    background: #e2e8f0;
}

.anruf-buttons {
    justify-content: center;
    margin-top: 1rem;
}

.btn-anrufen { background: var(--success); padding: 0.6rem 2rem; }
.btn-anrufen:hover { background: #16a34a; }
.btn-auflegen { background: var(--danger); padding: 0.6rem 2rem; }
.btn-auflegen:hover { background: #dc2626; }
.btn-annehmen { background: var(--success); padding: 0.6rem 2rem; }
.btn-annehmen:hover { background: #16a34a; }

#anruf-info { text-align: center; }
#anruf-gegenstelle { font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem; }
#anruf-timer { font-size: 2rem; font-family: 'Courier New', monospace; color: var(--primary); margin-bottom: 0.5rem; }
#anruf-status-anzeige { color: var(--text-muted); }

/* ===== 404 ===== */

#fehler-seite {
    text-align: center;
    padding: 3rem 1rem;
}

#fehler-seite h2 {
    font-size: 2rem;
    margin-bottom: 1rem;
    color: var(--danger);
}

#fehler-seite p {
    margin-bottom: 2rem;
    color: var(--text-muted);
}

.btn-zurueck {
    display: inline-block;
    padding: 0.6rem 1.5rem;
    background: var(--primary);
    color: white;
    text-decoration: none;
    border-radius: var(--radius);
}

.btn-zurueck:hover { background: var(--primary-dark); }

#benutzer-suche, #patient-suche {
    margin-bottom: 0;
}

/* ===== Chat Widget ===== */

#chat-toggle {
    position: fixed;
    bottom: 1.5rem;
    right: 1.5rem;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: var(--primary);
    color: #fff;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(8,145,178,0.4);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: transform 0.15s;
    padding: 0;
}

#chat-toggle:hover {
    transform: scale(1.1);
    background: var(--primary-dark);
}

#chat-fenster {
    display: none;
    flex-direction: column;
    position: fixed;
    bottom: 5.5rem;
    right: 1.5rem;
    width: 340px;
    height: 420px;
    background: var(--card);
    border-radius: 12px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.15);
    z-index: 1001;
    border: 1px solid var(--border);
    overflow: hidden;
}

.chat-header {
    background: var(--primary);
    color: #fff;
    padding: 0.75rem 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
    font-size: 0.9rem;
}

.chat-header button {
    background: none;
    border: none;
    color: #fff;
    font-size: 1.2rem;
    cursor: pointer;
    padding: 0;
}

#chat-nachrichten {
    flex: 1;
    overflow-y: auto;
    padding: 0.75rem;
}

.chat-msg {
    padding: 0.5rem 0.75rem;
    margin-bottom: 0.5rem;
    border-radius: 12px;
    font-size: 0.85rem;
    max-width: 85%;
    line-height: 1.4;
    word-wrap: break-word;
}

.chat-msg-bot {
    background: #f1f5f9;
    color: var(--text);
    border-bottom-left-radius: 4px;
}

.chat-msg-user {
    background: var(--primary);
    color: #fff;
    margin-left: auto;
    border-bottom-right-radius: 4px;
}

.chat-eingabe {
    display: flex;
    border-top: 1px solid var(--border);
    padding: 0.5rem;
    gap: 0.5rem;
}

.chat-eingabe input {
    flex: 1;
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 0.4rem 0.75rem;
    font-size: 0.85rem;
}

.chat-eingabe button {
    border-radius: 50%;
    width: 36px;
    height: 36px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
}

/* ===== Dashboard Grid ===== */

.dashboard-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.25rem;
}

/* ===== Responsive ===== */

@media (max-width: 900px) {
    .dashboard-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .sidebar {
        transform: translateX(-100%);
    }

    .sidebar.open {
        transform: translateX(0);
    }

    .main-wrapper {
        margin-left: 0;
    }

    #menu-toggle {
        display: block;
    }

    main {
        padding: 1rem;
    }

    .form-row {
        flex-direction: column;
        gap: 0;
    }

    .stat-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    th, td {
        padding: 0.4rem;
        font-size: 0.8rem;
    }

    .warte-karte {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.75rem;
    }

    #chat-fenster {
        width: calc(100% - 2rem);
        right: 1rem;
        bottom: 5rem;
    }
}

@media (max-width: 480px) {
    .stat-grid {
        grid-template-columns: 1fr 1fr;
    }

    .agenten-grid {
        grid-template-columns: 1fr;
    }
}

/* ===== Callflow Editor ===== */

.callflow-layout {
    display: grid;
    grid-template-columns: 200px 1fr 280px;
    gap: 1rem;
    min-height: 500px;
}

.callflow-toolbar h3, .callflow-properties h3 {
    font-size: 0.9rem;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.callflow-baustein-liste {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.callflow-baustein {
    padding: 0.5rem 0.75rem;
    font-size: 0.8rem;
    background: #f1f5f9;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    cursor: grab;
    text-align: left;
    color: #334155;
    transition: all 0.15s ease;
}

.callflow-baustein:hover {
    background: #e0e7ff;
    border-color: #818cf8;
    color: #4338ca;
    transform: translateX(4px);
    box-shadow: none;
}

.callflow-canvas {
    overflow: auto;
    background: #f8fafc;
    background-image: radial-gradient(circle, #e2e8f0 1px, transparent 1px);
    background-size: 20px 20px;
    min-height: 500px;
    position: relative;
}

.callflow-flow {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 1.5rem;
    gap: 0;
}

.callflow-node {
    width: 280px;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    background: #fff;
    cursor: pointer;
    transition: all 0.2s ease;
    overflow: hidden;
}

.callflow-node:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-color: #818cf8;
}

.callflow-node.selected {
    border-color: #4f46e5;
    box-shadow: 0 0 0 3px rgba(79,70,229,0.15);
}

.callflow-node-header {
    padding: 0.5rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #fff;
}

.callflow-node-header.typ-start { background: #4f46e5; }
.callflow-node-header.typ-ansage { background: #0891b2; }
.callflow-node-header.typ-dtmf { background: #7c3aed; }
.callflow-node-header.typ-voicebot { background: #059669; }
.callflow-node-header.typ-warteschlange { background: #d97706; }
.callflow-node-header.typ-transfer { background: #0891b2; }
.callflow-node-header.typ-bedingung { background: #dc2626; }
.callflow-node-header.typ-aufnahme { background: #7c3aed; }
.callflow-node-header.typ-ende { background: #64748b; }

.callflow-node-body {
    padding: 0.625rem 0.75rem;
    font-size: 0.8rem;
    color: #475569;
}

.callflow-node-body .node-detail {
    margin-bottom: 0.25rem;
}

.callflow-node-body .node-detail small {
    color: #94a3b8;
}

.callflow-pfeil {
    display: flex;
    flex-direction: column;
    align-items: center;
    color: #94a3b8;
    font-size: 1.25rem;
    padding: 0.25rem 0;
}

.callflow-pfeil .pfeil-label {
    font-size: 0.65rem;
    background: #f1f5f9;
    padding: 0.1rem 0.5rem;
    border-radius: 4px;
    margin-bottom: 0.15rem;
    color: #64748b;
    font-weight: 600;
}

.callflow-zweig {
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
}

.callflow-zweig-spalte {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0;
}

.callflow-add-btn {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #e0e7ff;
    color: #4f46e5;
    border: 2px dashed #818cf8;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    cursor: pointer;
    margin: 0.5rem 0;
    padding: 0;
}

.callflow-add-btn:hover {
    background: #4f46e5;
    color: #fff;
    border-style: solid;
    transform: scale(1.1);
}

#callflow-props-inhalt .form-group { margin-bottom: 0.75rem; }

.text-muted { color: #94a3b8; font-size: 0.85rem; }

.btn-sm {
    padding: 0.375rem 0.75rem;
    font-size: 0.8rem;
}

.btn-success-sm {
    background: #10b981;
}
.btn-success-sm:hover {
    background: #059669;
    box-shadow: 0 4px 12px rgba(16,185,129,0.3);
}

/* ===== Voicebot ===== */

.voicebot-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.25rem;
}

.status-indicator {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.3rem 0.75rem;
    border-radius: 999px;
    font-size: 0.8rem;
    font-weight: 600;
}

.status-online {
    color: #059669;
    background: rgba(16,185,129,0.1);
}

.status-online i {
    font-size: 0.5rem;
    animation: pulse-dot 2s infinite;
}

@keyframes pulse-dot {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
}

.voicebot-test-chat {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 1rem;
    min-height: 200px;
    max-height: 350px;
    overflow-y: auto;
    margin-bottom: 1rem;
}

.vb-chat-msg {
    padding: 0.5rem 0.75rem;
    margin-bottom: 0.5rem;
    border-radius: 8px;
    font-size: 0.85rem;
    max-width: 80%;
}

.vb-msg-bot {
    background: #e0e7ff;
    color: #3730a3;
}

.vb-msg-anrufer {
    background: #dcfce7;
    color: #166534;
    margin-left: auto;
}

.vb-msg-system {
    background: #fef3c7;
    color: #92400e;
    font-style: italic;
    font-size: 0.8rem;
    text-align: center;
    margin: 0 auto;
}

.voicebot-test-eingabe {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.vb-dtmf-tasten {
    display: flex;
    gap: 0.375rem;
}

.vb-dtmf {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    background: #f1f5f9;
    border: 1px solid #e2e8f0;
    color: #334155;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.vb-dtmf:hover {
    background: #4f46e5;
    color: #fff;
    border-color: #4f46e5;
    transform: scale(1.05);
}

.voicebot-anruf-eintrag {
    padding: 0.75rem;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.voicebot-anruf-eintrag .anruf-info {
    font-size: 0.85rem;
}

.voicebot-anruf-eintrag .anruf-info strong {
    display: block;
    margin-bottom: 0.15rem;
}

.voicebot-anruf-eintrag .anruf-ergebnis {
    font-size: 0.75rem;
    padding: 0.2rem 0.5rem;
    border-radius: 999px;
    font-weight: 600;
}

.ergebnis-termin { background: #dcfce7; color: #166534; }
.ergebnis-rezept { background: #e0e7ff; color: #3730a3; }
.ergebnis-transfer { background: #fef3c7; color: #92400e; }

/* ===== Uebersetzer ===== */

.uebersetzer-layout {
    display: flex;
    gap: 1rem;
    align-items: flex-start;
}

.uebersetzer-spalte {
    flex: 1;
}

.uebersetzer-mitte {
    display: flex;
    align-items: center;
    padding-top: 2rem;
}

.uebersetzer-mitte button {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
}

.uebersetzer-ausgabe {
    background: #f8fafc;
    border: 1.5px solid #e2e8f0;
    border-radius: 8px;
    padding: 0.75rem;
    min-height: 130px;
    font-size: 0.9rem;
    color: #334155;
    line-height: 1.6;
}

.phrasen-kategorien {
    display: flex;
    gap: 0.375rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
}

.phrasen-kat {
    padding: 0.375rem 0.75rem;
    font-size: 0.75rem;
    border-radius: 999px;
    background: #f1f5f9;
    border: 1px solid #e2e8f0;
    color: #475569;
    cursor: pointer;
    font-weight: 600;
}

.phrasen-kat:hover, .phrasen-kat.active {
    background: #4f46e5;
    color: #fff;
    border-color: #4f46e5;
    box-shadow: none;
    transform: none;
}

.phrasen-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 0.75rem;
}

.phrase-card {
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 0.75rem;
    cursor: pointer;
    transition: all 0.15s ease;
}

.phrase-card:hover {
    border-color: #818cf8;
    background: #f5f3ff;
}

.phrase-card .phrase-de {
    font-weight: 600;
    font-size: 0.85rem;
    margin-bottom: 0.375rem;
    color: #0f172a;
}

.phrase-card .phrase-uebersetzt {
    font-size: 0.825rem;
    color: #4f46e5;
}

.phrase-card .phrase-actions {
    margin-top: 0.5rem;
    display: flex;
    gap: 0.375rem;
}

.phrase-card .phrase-actions button {
    padding: 0.2rem 0.5rem;
    font-size: 0.7rem;
    border-radius: 6px;
}

/* ===== Voice Chat (Mikrofon) ===== */

#chat-mikrofon {
    border-radius: 50%;
    width: 36px;
    height: 36px;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.875rem;
    flex-shrink: 0;
    background: #f1f5f9;
    color: #475569;
    border: 1px solid #e2e8f0;
}

#chat-mikrofon:hover {
    background: #ef4444;
    color: #fff;
    border-color: #ef4444;
    box-shadow: none;
}

#chat-mikrofon.recording {
    background: #ef4444;
    color: #fff;
    border-color: #ef4444;
    animation: pulse-recording 1s infinite;
}

@keyframes pulse-recording {
    0%, 100% { box-shadow: 0 0 0 0 rgba(239,68,68,0.4); }
    50% { box-shadow: 0 0 0 8px rgba(239,68,68,0); }
}

#btn-ue-mikrofon.recording {
    background: #ef4444;
    color: #fff;
    animation: pulse-recording 1s infinite;
}

/* ===== Simulation ===== */

#simulation-ablauf {
    background: #0f172a;
    color: #a5f3fc;
    border-radius: 8px;
    padding: 1rem;
    font-family: 'Courier New', monospace;
    font-size: 0.8rem;
    min-height: 120px;
    max-height: 300px;
    overflow-y: auto;
    margin-bottom: 1rem;
    line-height: 1.6;
}

.sim-zeile {
    margin-bottom: 0.25rem;
}

.sim-zeile-system { color: #fcd34d; }
.sim-zeile-audio { color: #a5f3fc; }
.sim-zeile-eingabe { color: #86efac; }
.sim-zeile-aktion { color: #c4b5fd; }

/* ===== ACD Modus-Auswahl ===== */

.acd-modus-auswahl {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
}

.acd-modus-karte {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem 1.25rem;
    border: 2px solid var(--border);
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
    background: #fff;
}

.acd-modus-karte:hover {
    border-color: #818cf8;
    background: #f8f7ff;
}

.acd-modus-karte.selected {
    border-color: #4f46e5;
    background: #eef2ff;
    box-shadow: 0 0 0 3px rgba(79,70,229,0.12);
}

.acd-modus-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.3rem;
    flex-shrink: 0;
    background: #f1f5f9;
    color: #64748b;
}

.acd-modus-karte.selected .acd-modus-icon {
    background: #4f46e5;
    color: #fff;
}

.acd-modus-karte[data-modus="alle_annehmen"] .acd-modus-icon { background: #dcfce7; color: #16a34a; }
.acd-modus-karte[data-modus="alle_annehmen"].selected .acd-modus-icon { background: #16a34a; color: #fff; }
.acd-modus-karte[data-modus="klingeln_dann_bot"] .acd-modus-icon { background: #fef3c7; color: #d97706; }
.acd-modus-karte[data-modus="klingeln_dann_bot"].selected .acd-modus-icon { background: #d97706; color: #fff; }
.acd-modus-karte[data-modus="bot_direkt"] .acd-modus-icon { background: #e0e7ff; color: #4f46e5; }
.acd-modus-karte[data-modus="bot_direkt"].selected .acd-modus-icon { background: #4f46e5; color: #fff; }

.acd-modus-info { flex: 1; }
.acd-modus-info h3 { font-size: 0.95rem; margin-bottom: 0.2rem; color: var(--text); }
.acd-modus-info p { font-size: 0.8rem; color: var(--text-muted); line-height: 1.4; }

.acd-modus-check {
    font-size: 1.3rem;
    color: #e2e8f0;
    flex-shrink: 0;
}

.acd-modus-karte.selected .acd-modus-check { color: #4f46e5; }
.acd-modus-karte[data-modus="alle_annehmen"].selected .acd-modus-check { color: #16a34a; }
.acd-modus-karte[data-modus="klingeln_dann_bot"].selected .acd-modus-check { color: #d97706; }
.acd-modus-karte[data-modus="bot_direkt"].selected .acd-modus-check { color: #4f46e5; }

/* ===== Zeitplan-Tabelle ===== */

.zeitplan-tabelle-wrapper {
    overflow-x: auto;
    margin-bottom: 0.5rem;
}

.zeitplan-tabelle {
    width: 100%;
    border-collapse: collapse;
}

.zeitplan-tabelle th {
    background: #f8fafc;
    font-weight: 600;
    color: var(--text-muted);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.03em;
    padding: 0.5rem 0.5rem;
    text-align: center;
    border-bottom: 2px solid var(--border);
}

.zeitplan-tabelle td {
    padding: 0.5rem 0.4rem;
    text-align: center;
    border-bottom: 1px solid var(--border);
    font-size: 0.85rem;
}

.zeitplan-tabelle td:first-child {
    font-weight: 600;
    text-align: left;
    padding-left: 0.75rem;
    white-space: nowrap;
}

.zeitplan-tabelle input[type="time"] {
    width: 110px;
    padding: 0.3rem 0.4rem;
    font-size: 0.8rem;
    border-radius: 6px;
}

.zeitplan-tabelle select {
    width: 140px;
    padding: 0.3rem 0.4rem;
    font-size: 0.8rem;
    border-radius: 6px;
}

.zeitplan-tabelle input[type="checkbox"] {
    width: auto;
    accent-color: #4f46e5;
    transform: scale(1.2);
}

.zeitplan-tag-inaktiv td {
    opacity: 0.4;
}

.zeitplan-tag-inaktiv td:first-child,
.zeitplan-tag-inaktiv td:nth-child(2) {
    opacity: 1;
}

/* ===== ACD Live-Status ===== */

.acd-live-status {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
}

.acd-live-box {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1rem;
    background: #f8fafc;
}

.acd-live-box h3 {
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.acd-live-box .live-wert {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--primary);
}

.acd-live-modus {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.3rem 0.75rem;
    border-radius: 999px;
    font-size: 0.8rem;
    font-weight: 600;
}

.acd-live-modus.modus-alle { background: #dcfce7; color: #166534; }
.acd-live-modus.modus-klingeln { background: #fef3c7; color: #92400e; }
.acd-live-modus.modus-bot { background: #e0e7ff; color: #3730a3; }

/* ===== Responsive Callflow / Voicebot / Uebersetzer / ACD ===== */

@media (max-width: 900px) {
    .callflow-layout {
        grid-template-columns: 1fr;
    }
    .callflow-toolbar {
        flex-direction: row;
        flex-wrap: wrap;
    }
    .callflow-baustein-liste {
        flex-direction: row;
        flex-wrap: wrap;
    }
    .callflow-properties {
        order: -1;
    }
    .voicebot-grid {
        grid-template-columns: 1fr;
    }
    .uebersetzer-layout {
        flex-direction: column;
    }
    .uebersetzer-mitte {
        transform: rotate(90deg);
        padding: 0;
        align-self: center;
    }
    .acd-live-status {
        grid-template-columns: 1fr;
    }
    .zeitplan-tabelle select,
    .zeitplan-tabelle input[type="time"] {
        width: 100px;
        font-size: 0.75rem;
    }
}

/* ===== Dashboard Rollen-Buttons ===== */
.dashboard-rolle-btn {
    padding: 0.5rem 1rem;
    border-radius: var(--radius);
    border: 2px solid var(--border);
    background: var(--card);
    color: var(--text-muted);
    font-weight: 600;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
}
.dashboard-rolle-btn:hover {
    border-color: var(--primary);
    color: var(--primary);
}
.dashboard-rolle-btn.aktiv {
    border-color: var(--primary);
    background: var(--primary);
    color: #fff;
}

/* ===== Wissensdatenbank + Ansagen Styles ===== */
.kb-artikel-card {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1rem;
    margin-bottom: 0.75rem;
    background: var(--card);
}
.ans-liste-item {
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1rem;
    margin-bottom: 0.75rem;
    background: var(--card);
    display: flex;
    align-items: center;
    gap: 1rem;
}


/* ===== SPA Styles ===== */
.spa-page { display: none; }
.spa-page.active { display: block; }
.spa-nav-link.active {
    background: var(--primary) !important;
    color: #fff !important;
}
#spa-guard {
    position: fixed;
    inset: 0;
    z-index: 9999;
    background: var(--sidebar-bg);
}
#spa-guard.hidden { display: none; }
.spa-rolle-select {
    width: 100%;
    padding: 0.5rem;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    font-size: 0.85rem;
    margin: 0.5rem 0;
}
    </style>
</head>
<body>

<!-- ===== GUARD/LOGIN OVERLAY ===== -->
<div id="spa-guard">
<div class="guard-container">
        <div class="guard-card">
            <div class="guard-header">
                <div class="guard-icon"><i class="fa-solid fa-building-shield"></i></div>
                <h1 id="guard-titel">MED Rezeption</h1>
                <p id="guard-untertitel">Verwaltungssystem</p>
            </div>
            <div class="guard-body">
                <form id="guard-form">
                    <div id="guard-fehler" class="guard-fehler" hidden>
                        <i class="fa-solid fa-circle-exclamation"></i>
                        <span id="guard-fehler-text">Falsche Zugangsdaten.</span>
                    </div>
                    <div class="form-group">
                        <label for="guard-benutzer"><i class="fa-solid fa-user"></i> Benutzername</label>
                        <input type="text" id="guard-benutzer" value="admin" autocomplete="username" required>
                    </div>
                    <div class="form-group">
                        <label for="guard-passwort"><i class="fa-solid fa-lock"></i> Passwort</label>
                        <input type="password" id="guard-passwort" value="demo" autocomplete="current-password" required>
                    </div>
                    <div class="form-row-inline">
                        <label><input type="checkbox" id="guard-merken" checked> Angemeldet bleiben</label>
                    </div>
                    <button type="submit" class="btn-guard"><i class="fa-solid fa-right-to-bracket"></i> Anmelden</button>
                </form>
            </div>
            <div class="guard-footer">
                <div class="guard-demo-info">
                    <strong><i class="fa-solid fa-info-circle"></i> Demo-Zugangsdaten</strong>
                    <code>admin</code> / <code>teamleitung</code> / <code>standortleitung</code> / <code>agent</code><br>
                    Passwort: <code>demo</code>
                </div>
            </div>
        </div>
    </div>
    <div class="guard-easter" style="position:fixed;bottom:3rem;left:0;right:0;text-align:center;color:#67e8f9;font-size:0.9rem;font-style:italic;opacity:1;z-index:1;letter-spacing:0.05em;">niemand hat die absicht einen ai agent zu entwickeln</div>
    <div class="guard-version">MED Rezeption v1.0 MVP</div>
    <script>
    (function() {
        var GUELTIGE_BENUTZER = {
            "admin":           { passwort: "demo", name: "Administrator",    rolle: "admin" },
            "teamleitung":     { passwort: "demo", name: "Frank Weber",      rolle: "teamleitung" },
            "standortleitung": { passwort: "demo", name: "Dr. Sabine Gross", rolle: "standortleitung" },
            "agent":           { passwort: "demo", name: "Lisa Meier",       rolle: "agent" }
        };

        // Check ob Portal-Zutrittscode eingegeben wurde
        if (!sessionStorage.getItem("med_portal_ok")) {
            window.location.href = "portal.html";
            return;
        }

        // Check ob bereits eingeloggt
        if (sessionStorage.getItem("med_guard_auth") || localStorage.getItem("med_guard_auth")) {
            window.location.href = "index.html";
            return;
        }

        var form = document.getElementById("guard-form");
        form.addEventListener("submit", function(e) {
            e.preventDefault();
            var benutzer = document.getElementById("guard-benutzer").value.trim().toLowerCase();
            var passwort = document.getElementById("guard-passwort").value;
            var merken   = document.getElementById("guard-merken").checked;
            var fehlerEl = document.getElementById("guard-fehler");
            var fehlerText = document.getElementById("guard-fehler-text");

            var konto = GUELTIGE_BENUTZER[benutzer];
            if (!konto || konto.passwort !== passwort) {
                fehlerEl.hidden = false;
                fehlerText.textContent = "Ungueltiger Benutzername oder Passwort.";
                document.getElementById("guard-passwort").value = "";
                document.getElementById("guard-passwort").focus();
                return;
            }

            var authData = JSON.stringify({
                benutzer: benutzer,
                name: konto.name,
                rolle: konto.rolle,
                zeitpunkt: new Date().toISOString()
            });

            if (merken) {
                localStorage.setItem("med_guard_auth", authData);
            } else {
                sessionStorage.setItem("med_guard_auth", authData);
            }

            window.location.href = "index.html";
        });
    })();
    </script>
</div>

<!-- ===== MAIN APP ===== -->
<aside class="sidebar" id="sidebar">
    <div class="sidebar-logo"><h2>MED Rezeption</h2><small>Praxisverwaltung</small></div>
    <div style="padding:0 0.75rem">
        <label style="font-size:0.7rem;color:var(--sidebar-text);text-transform:uppercase;letter-spacing:1px">Rolle</label>
        <select class="spa-rolle-select" id="spa-rolle-select" onchange="spaRolleWechseln(this.value)">
            <option value="admin">Admin</option>
            <option value="teamleitung">Teamleiter</option>
            <option value="standortleitung">Standortleitung</option>
            <option value="agent">Agent</option>
        </select>
    </div>
    <nav class="sidebar-nav" id="spa-nav">
        <a href="#" class="spa-nav-link" data-page="dashboard"><i class="fa-solid fa-chart-pie nav-icon"></i> Dashboard</a>
            <a href="#" class="spa-nav-link" data-page="patienten"><i class="fa-solid fa-users nav-icon"></i> Patienten</a>
            <a href="#" class="spa-nav-link" data-page="aerzte"><i class="fa-solid fa-user-doctor nav-icon"></i> Aerzte</a>
            <a href="#" class="spa-nav-link" data-page="termine"><i class="fa-solid fa-calendar-days nav-icon"></i> Termine</a>
            <a href="#" class="spa-nav-link" data-page="wartezimmer"><i class="fa-solid fa-couch nav-icon"></i> Wartezimmer</a>
            <a href="#" class="spa-nav-link" data-page="wissensdatenbank"><i class="fa-solid fa-book nav-icon"></i> Wissensdatenbank</a>
            <a href="#" class="spa-nav-link" data-page="ansagen"><i class="fa-solid fa-tower-broadcast nav-icon"></i> Ansagen Generator</a>
            <a href="#" class="spa-nav-link" data-page="auswertung"><i class="fa-solid fa-chart-line nav-icon"></i> Auswertungen</a>
            <a href="#" class="spa-nav-link" data-page="standort"><i class="fa-solid fa-building nav-icon"></i> Standort &amp; ACD</a>
            <a href="#" class="spa-nav-link" data-page="callflow"><i class="fa-solid fa-diagram-project nav-icon"></i> Callflow Editor</a>
            <a href="#" class="spa-nav-link" data-page="voicebot"><i class="fa-solid fa-robot nav-icon"></i> Voicebot</a>
            <a href="#" class="spa-nav-link" data-page="agenten"><i class="fa-solid fa-headset nav-icon"></i> Agenten</a>
            <a href="#" class="spa-nav-link" data-page="softphone"><i class="fa-solid fa-phone nav-icon"></i> Softphone</a>
            <a href="#" class="spa-nav-link" data-page="uebersetzung"><i class="fa-solid fa-language nav-icon"></i> Uebersetzer</a>
            <a href="#" class="spa-nav-link" data-page="benutzer"><i class="fa-solid fa-user-gear nav-icon"></i> Benutzer</a>
    </nav>
    <div class="sidebar-footer"><button id="btn-demo-reset" type="button">Demo zuruecksetzen</button></div>
</aside>
<div class="main-wrapper">
    <header class="topbar">
        <button id="menu-toggle" type="button"><i class="fa-solid fa-bars"></i></button>
        <h1 id="spa-page-title">Dashboard</h1>
        <div class="topbar-right" id="guard-info-bereich">Demo-Modus</div>
    </header>
    <main>
        <div class="spa-page active" id="spa-dashboard" data-title="Dashboard">
            <div id="dashboard"><!-- Wird rollenbasiert von app.js befuellt --></div>
        </div>

        <div class="spa-page" id="spa-patienten" data-title="Patienten">
            <section id="patient-formular" class="card">
                <h2 id="patient-formular-titel">Patient anlegen</h2>
                <form id="patient-form">
                    <input type="hidden" id="patient-id">
                    <div class="form-row">
                        <div class="form-group"><label for="patient-vorname">Vorname</label><input type="text" id="patient-vorname" required></div>
                        <div class="form-group"><label for="patient-nachname">Nachname</label><input type="text" id="patient-nachname" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label for="patient-geburtsdatum">Geburtsdatum</label><input type="date" id="patient-geburtsdatum" required></div>
                        <div class="form-group"><label for="patient-krankenkasse">Krankenkasse</label><input type="text" id="patient-krankenkasse" required></div>
                    </div>
                    <div class="form-group"><label for="patient-versicherungsnummer">Versicherungsnummer</label><input type="text" id="patient-versicherungsnummer" required></div>
                    <div class="form-row">
                        <div class="form-group"><label for="patient-telefon">Telefon</label><input type="tel" id="patient-telefon"></div>
                        <div class="form-group"><label for="patient-email">E-Mail</label><input type="email" id="patient-email"></div>
                    </div>
                    <fieldset><legend>Adresse</legend>
                        <div class="form-group"><label for="patient-strasse">Strasse</label><input type="text" id="patient-strasse"></div>
                        <div class="form-row">
                            <div class="form-group"><label for="patient-plz">PLZ</label><input type="text" id="patient-plz" maxlength="5"></div>
                            <div class="form-group"><label for="patient-stadt">Stadt</label><input type="text" id="patient-stadt"></div>
                        </div>
                    </fieldset>
                    <div class="button-gruppe">
                        <button type="submit" id="btn-patient-speichern">Speichern</button>
                        <button type="button" id="btn-patient-abbrechen" hidden>Abbrechen</button>
                    </div>
                </form>
                <div id="patient-erfolg" class="ergebnis" hidden></div>
                <div id="patient-fehler" class="fehler" hidden></div>
            </section>
            <section class="card">
                <h2>Patientenliste</h2>
                <div class="suche-box"><input type="text" id="patient-suche" placeholder="Patient suchen..."></div>
                <div class="table-container">
                    <table id="patienten-tabelle">
                        <thead><tr><th>Name</th><th>Geburtsdatum</th><th>Vers.-Nr.</th><th>Krankenkasse</th><th>Telefon</th><th>Aktionen</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>
        </div>

        <div class="spa-page" id="spa-aerzte" data-title="Aerzte">
            <section id="arzt-formular" class="card">
                <h2 id="arzt-formular-titel">Arzt anlegen</h2>
                <form id="arzt-form">
                    <input type="hidden" id="arzt-id">
                    <div class="form-row">
                        <div class="form-group"><label for="arzt-titel">Titel</label><input type="text" id="arzt-titel" placeholder="Dr. / Prof. Dr."></div>
                        <div class="form-group"><label for="arzt-fachrichtung">Fachrichtung</label><input type="text" id="arzt-fachrichtung" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label for="arzt-vorname">Vorname</label><input type="text" id="arzt-vorname" required></div>
                        <div class="form-group"><label for="arzt-nachname">Nachname</label><input type="text" id="arzt-nachname" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label for="arzt-telefon">Telefon</label><input type="tel" id="arzt-telefon"></div>
                        <div class="form-group"><label for="arzt-email">E-Mail</label><input type="email" id="arzt-email"></div>
                    </div>
                    <div class="button-gruppe">
                        <button type="submit" id="btn-arzt-speichern">Speichern</button>
                        <button type="button" id="btn-arzt-abbrechen" hidden>Abbrechen</button>
                    </div>
                </form>
                <div id="arzt-erfolg" class="ergebnis" hidden></div>
                <div id="arzt-fehler" class="fehler" hidden></div>
            </section>
            <section class="card">
                <h2>Aerzteliste</h2>
                <div class="table-container">
                    <table id="aerzte-tabelle">
                        <thead><tr><th>Name</th><th>Fachrichtung</th><th>Telefon</th><th>E-Mail</th><th>Aktionen</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>
        </div>

        <div class="spa-page" id="spa-termine" data-title="Termine">
            <section id="termin-formular" class="card">
                <h2 id="termin-formular-titel">Termin anlegen</h2>
                <form id="termin-form">
                    <input type="hidden" id="termin-id">
                    <div class="form-row">
                        <div class="form-group"><label for="termin-patient">Patient</label><select id="termin-patient" required><option value="">-- Patient waehlen --</option></select></div>
                        <div class="form-group"><label for="termin-arzt">Arzt</label><select id="termin-arzt" required><option value="">-- Arzt waehlen --</option></select></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label for="termin-datum">Datum</label><input type="date" id="termin-datum" required></div>
                        <div class="form-group"><label for="termin-uhrzeit">Uhrzeit</label><input type="time" id="termin-uhrzeit" required></div>
                        <div class="form-group"><label for="termin-dauer">Dauer (Min.)</label><input type="number" id="termin-dauer" value="15" min="5" max="120"></div>
                    </div>
                    <div class="form-group"><label for="termin-grund">Grund</label><input type="text" id="termin-grund" placeholder="z.B. Vorsorge, Kontrolle..."></div>
                    <div class="button-gruppe">
                        <button type="submit" id="btn-termin-speichern">Speichern</button>
                        <button type="button" id="btn-termin-abbrechen" hidden>Abbrechen</button>
                    </div>
                </form>
                <div id="termin-erfolg" class="ergebnis" hidden></div>
                <div id="termin-fehler" class="fehler" hidden></div>
            </section>
            <section class="card">
                <div class="section-header">
                    <h2>Terminliste</h2>
                    <div class="form-group" style="margin-bottom:0"><input type="date" id="termin-filter-datum" title="Nach Datum filtern"></div>
                </div>
                <div class="table-container">
                    <table id="termine-tabelle">
                        <thead><tr><th>Datum</th><th>Uhrzeit</th><th>Patient</th><th>Arzt</th><th>Grund</th><th>Status</th><th>Aktionen</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>
        </div>

        <div class="spa-page" id="spa-wartezimmer" data-title="Wartezimmer">
            <section class="card">
                <h2>Patient einchecken</h2>
                <form id="checkin-form">
                    <div class="form-row">
                        <div class="form-group"><label for="checkin-patient">Patient</label><select id="checkin-patient" required><option value="">-- Patient waehlen --</option></select></div>
                        <div class="form-group"><label for="checkin-termin">Termin</label><select id="checkin-termin"><option value="">-- Ohne Termin --</option></select></div>
                    </div>
                    <button type="submit">Einchecken</button>
                </form>
                <div id="checkin-erfolg" class="ergebnis" hidden></div>
                <div id="checkin-fehler" class="fehler" hidden></div>
            </section>
            <section class="card">
                <h2>Wartende Patienten</h2>
                <div id="wartezimmer-liste"></div>
            </section>
        </div>

        <div class="spa-page" id="spa-wissensdatenbank" data-title="Wissensdatenbank">
            <!-- Suche + Filter -->
            <div class="card" style="margin-bottom:1.5rem">
                <div style="display:flex;gap:1rem;align-items:center;flex-wrap:wrap">
                    <div style="flex:1;min-width:200px;position:relative">
                        <i class="fa-solid fa-magnifying-glass" style="position:absolute;left:0.8rem;top:50%;transform:translateY(-50%);color:var(--text-muted)"></i>
                        <input type="text" id="kb-suche" placeholder="Wissensdatenbank durchsuchen..." style="padding-left:2.2rem;width:100%">
                    </div>
                    <select id="kb-kategorie-filter" style="min-width:160px">
                        <option value="">Alle Kategorien</option>
                        <option value="telefonie">Telefonie &amp; ACD</option>
                        <option value="patienten">Patienten</option>
                        <option value="termine">Termine</option>
                        <option value="abrechnung">Abrechnung</option>
                        <option value="praxisablauf">Praxisablauf</option>
                        <option value="notfall">Notfall</option>
                        <option value="technik">Technik</option>
                    </select>
                    <button type="button" id="btn-kb-neu" class="btn-primary"><i class="fa-solid fa-plus"></i> Neuer Artikel</button>
                </div>
            </div>

            <!-- Statistik-Leiste -->
            <div class="stat-grid" style="margin-bottom:1.5rem">
                <div class="stat-card">
                    <div class="stat-icon bg-primary"><i class="fa-solid fa-file-lines"></i></div>
                    <div class="stat-content">
                        <div class="stat-value" id="kb-stat-artikel">0</div>
                        <div class="stat-label">Artikel</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-success"><i class="fa-solid fa-folder"></i></div>
                    <div class="stat-content">
                        <div class="stat-value" id="kb-stat-kategorien">0</div>
                        <div class="stat-label">Kategorien</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-warning"><i class="fa-solid fa-eye"></i></div>
                    <div class="stat-content">
                        <div class="stat-value" id="kb-stat-aufrufe">0</div>
                        <div class="stat-label">Aufrufe (30 Tage)</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-info"><i class="fa-solid fa-robot"></i></div>
                    <div class="stat-content">
                        <div class="stat-value" id="kb-stat-bot">0</div>
                        <div class="stat-label">Bot-Antworten</div>
                    </div>
                </div>
            </div>

            <!-- Artikel-Formular (hidden) -->
            <div class="card" id="kb-formular-bereich" hidden style="margin-bottom:1.5rem">
                <h2 id="kb-formular-titel"><i class="fa-solid fa-pen"></i> Neuen Artikel erstellen</h2>
                <form id="kb-formular" style="display:flex;flex-direction:column;gap:1rem;margin-top:1rem">
                    <div class="form-group">
                        <label for="kb-titel">Titel</label>
                        <input type="text" id="kb-titel" placeholder="z.B. Wie stelle ich den Voicebot ein?" required>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
                        <div class="form-group">
                            <label for="kb-kat">Kategorie</label>
                            <select id="kb-kat" required>
                                <option value="telefonie">Telefonie &amp; ACD</option>
                                <option value="patienten">Patienten</option>
                                <option value="termine">Termine</option>
                                <option value="abrechnung">Abrechnung</option>
                                <option value="praxisablauf">Praxisablauf</option>
                                <option value="notfall">Notfall</option>
                                <option value="technik">Technik</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="kb-tags">Tags (kommagetrennt)</label>
                            <input type="text" id="kb-tags" placeholder="z.B. voicebot, einrichtung, telefon">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="kb-inhalt">Inhalt</label>
                        <textarea id="kb-inhalt" rows="8" placeholder="Artikelinhalt eingeben... Markdown wird unterstuetzt." required style="font-family:monospace;font-size:0.9rem"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="kb-bot-antwort">Bot-Kurzantwort (fuer KI-Assistent)</label>
                        <textarea id="kb-bot-antwort" rows="3" placeholder="Kurze Antwort die der Voicebot/Chat-Bot geben soll..."></textarea>
                    </div>
                    <div style="display:flex;gap:0.5rem">
                        <button type="submit" class="btn-primary"><i class="fa-solid fa-save"></i> Speichern</button>
                        <button type="button" id="btn-kb-abbrechen" style="background:var(--text-muted)"><i class="fa-solid fa-xmark"></i> Abbrechen</button>
                    </div>
                    <div id="kb-erfolg" class="ergebnis" hidden></div>
                </form>
            </div>

            <!-- Artikel-Liste -->
            <div class="card">
                <h2><i class="fa-solid fa-list"></i> Artikel</h2>
                <div id="kb-artikel-liste" style="margin-top:1rem"></div>
            </div>
        </div>

        <div class="spa-page" id="spa-ansagen" data-title="Ansagen Generator">
            <!-- Statistik -->
            <div class="stat-grid" style="margin-bottom:1.5rem">
                <div class="stat-card">
                    <div class="stat-icon bg-primary"><i class="fa-solid fa-volume-high"></i></div>
                    <div class="stat-content">
                        <div class="stat-value" id="ans-stat-gesamt">0</div>
                        <div class="stat-label">Ansagen</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-success"><i class="fa-solid fa-circle-check"></i></div>
                    <div class="stat-content">
                        <div class="stat-value" id="ans-stat-aktiv">0</div>
                        <div class="stat-label">Aktiv</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-warning"><i class="fa-solid fa-language"></i></div>
                    <div class="stat-content">
                        <div class="stat-value" id="ans-stat-sprachen">3</div>
                        <div class="stat-label">Sprachen</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-info"><i class="fa-solid fa-microphone"></i></div>
                    <div class="stat-content">
                        <div class="stat-value" id="ans-stat-stimmen">6</div>
                        <div class="stat-label">KI-Stimmen</div>
                    </div>
                </div>
            </div>

            <!-- Generator -->
            <div class="card" style="margin-bottom:1.5rem">
                <h2><i class="fa-solid fa-wand-magic-sparkles"></i> Ansage erstellen</h2>
                <form id="ans-formular" style="margin-top:1rem">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem">
                        <div class="form-group">
                            <label for="ans-typ">Ansage-Typ</label>
                            <select id="ans-typ">
                                <option value="begruessung">Begruessung</option>
                                <option value="warteschleife">Warteschleife</option>
                                <option value="abwesenheit">Abwesenheit / AB</option>
                                <option value="oeffnungszeiten">Oeffnungszeiten</option>
                                <option value="notfall">Notfall-Hinweis</option>
                                <option value="feiertag">Feiertags-Ansage</option>
                                <option value="weiterleitung">Weiterleitung</option>
                                <option value="ivr_menue">IVR-Menue (Auswahl)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ans-name">Name der Ansage</label>
                            <input type="text" id="ans-name" placeholder="z.B. Begruessung Hauptnummer">
                        </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem;margin-top:1rem">
                        <div class="form-group">
                            <label for="ans-sprache">Sprache</label>
                            <select id="ans-sprache">
                                <option value="de">Deutsch</option>
                                <option value="en">Englisch</option>
                                <option value="tr">Tuerkisch</option>
                                <option value="ar">Arabisch</option>
                                <option value="ru">Russisch</option>
                                <option value="fr">Franzoesisch</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ans-stimme">KI-Stimme</label>
                            <select id="ans-stimme">
                                <option value="anna">Anna (weiblich, freundlich)</option>
                                <option value="thomas">Thomas (maennlich, sachlich)</option>
                                <option value="sophie">Sophie (weiblich, warm)</option>
                                <option value="markus">Markus (maennlich, professionell)</option>
                                <option value="lena">Lena (weiblich, jung)</option>
                                <option value="oliver">Oliver (maennlich, ruhig)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="ans-tempo">Sprechtempo</label>
                            <select id="ans-tempo">
                                <option value="langsam">Langsam</option>
                                <option value="normal" selected>Normal</option>
                                <option value="schnell">Schnell</option>
                            </select>
                        </div>
                    </div>

                    <!-- Vorlagen-Buttons -->
                    <div style="margin-top:1rem">
                        <label style="font-weight:600;margin-bottom:0.5rem;display:block"><i class="fa-solid fa-clipboard-list"></i> Schnell-Vorlagen:</label>
                        <div style="display:flex;flex-wrap:wrap;gap:0.5rem" id="ans-vorlagen">
                            <button type="button" class="ans-vorlage-btn" data-vorlage="begruessung_standard" style="padding:0.4rem 0.8rem;border-radius:6px;font-size:0.8rem;background:var(--bg);border:1px solid var(--border);cursor:pointer"><i class="fa-solid fa-hand-wave"></i> Standard-Begruessung</button>
                            <button type="button" class="ans-vorlage-btn" data-vorlage="warteschleife_standard" style="padding:0.4rem 0.8rem;border-radius:6px;font-size:0.8rem;background:var(--bg);border:1px solid var(--border);cursor:pointer"><i class="fa-solid fa-clock"></i> Warteschleife</button>
                            <button type="button" class="ans-vorlage-btn" data-vorlage="ab_standard" style="padding:0.4rem 0.8rem;border-radius:6px;font-size:0.8rem;background:var(--bg);border:1px solid var(--border);cursor:pointer"><i class="fa-solid fa-voicemail"></i> Anrufbeantworter</button>
                            <button type="button" class="ans-vorlage-btn" data-vorlage="oeffnungszeiten_standard" style="padding:0.4rem 0.8rem;border-radius:6px;font-size:0.8rem;background:var(--bg);border:1px solid var(--border);cursor:pointer"><i class="fa-solid fa-clock"></i> Oeffnungszeiten</button>
                            <button type="button" class="ans-vorlage-btn" data-vorlage="notfall_standard" style="padding:0.4rem 0.8rem;border-radius:6px;font-size:0.8rem;background:var(--bg);border:1px solid var(--border);cursor:pointer"><i class="fa-solid fa-triangle-exclamation"></i> Notfall</button>
                            <button type="button" class="ans-vorlage-btn" data-vorlage="ivr_menue" style="padding:0.4rem 0.8rem;border-radius:6px;font-size:0.8rem;background:var(--bg);border:1px solid var(--border);cursor:pointer"><i class="fa-solid fa-list-ol"></i> IVR-Menue</button>
                            <button type="button" class="ans-vorlage-btn" data-vorlage="feiertag_standard" style="padding:0.4rem 0.8rem;border-radius:6px;font-size:0.8rem;background:var(--bg);border:1px solid var(--border);cursor:pointer"><i class="fa-solid fa-tree"></i> Feiertag</button>
                        </div>
                    </div>

                    <div class="form-group" style="margin-top:1rem">
                        <label for="ans-text">Ansagetext</label>
                        <textarea id="ans-text" rows="5" placeholder="Geben Sie den Ansagetext ein oder waehlen Sie eine Vorlage..." required style="font-size:0.95rem;line-height:1.6"></textarea>
                        <small style="color:var(--text-muted)">Variablen: {praxis_name}, {oeffnungszeiten}, {notfall_nummer}, {datum}</small>
                    </div>

                    <!-- Audio-Vorschau -->
                    <div id="ans-vorschau-bereich" style="margin-top:1rem;padding:1rem;background:var(--bg);border-radius:8px" hidden>
                        <div style="display:flex;align-items:center;gap:1rem">
                            <button type="button" id="btn-ans-play" style="width:48px;height:48px;border-radius:50%;background:var(--primary);display:flex;align-items:center;justify-content:center;border:none;cursor:pointer">
                                <i class="fa-solid fa-play" style="color:#fff;font-size:1.2rem" id="ans-play-icon"></i>
                            </button>
                            <div style="flex:1">
                                <div style="height:4px;background:var(--border);border-radius:2px;overflow:hidden">
                                    <div id="ans-progress" style="height:100%;width:0%;background:var(--primary);border-radius:2px;transition:width 0.1s"></div>
                                </div>
                                <div style="display:flex;justify-content:space-between;margin-top:0.3rem;font-size:0.75rem;color:var(--text-muted)">
                                    <span id="ans-zeit-aktuell">0:00</span>
                                    <span id="ans-zeit-gesamt">0:00</span>
                                </div>
                            </div>
                            <span id="ans-stimme-label" style="font-size:0.8rem;color:var(--text-muted)"></span>
                        </div>
                    </div>

                    <div style="display:flex;gap:0.5rem;margin-top:1rem">
                        <button type="button" id="btn-ans-generieren" class="btn-primary"><i class="fa-solid fa-wand-magic-sparkles"></i> KI-Text generieren</button>
                        <button type="button" id="btn-ans-vorhoeren" style="background:var(--info)"><i class="fa-solid fa-volume-high"></i> Vorhoeren</button>
                        <button type="submit" style="background:var(--success)"><i class="fa-solid fa-save"></i> Ansage speichern</button>
                    </div>
                    <div id="ans-erfolg" class="ergebnis" hidden></div>
                </form>
            </div>

            <!-- Gespeicherte Ansagen -->
            <div class="card">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <h2><i class="fa-solid fa-list"></i> Gespeicherte Ansagen</h2>
                    <div style="display:flex;gap:0.5rem">
                        <select id="ans-filter-typ" style="font-size:0.85rem;padding:0.3rem 0.6rem">
                            <option value="">Alle Typen</option>
                            <option value="begruessung">Begruessung</option>
                            <option value="warteschleife">Warteschleife</option>
                            <option value="abwesenheit">Abwesenheit</option>
                            <option value="oeffnungszeiten">Oeffnungszeiten</option>
                            <option value="notfall">Notfall</option>
                            <option value="ivr_menue">IVR-Menue</option>
                        </select>
                    </div>
                </div>
                <div id="ans-liste" style="margin-top:1rem"></div>
            </div>
        </div>

        <div class="spa-page" id="spa-auswertung" data-title="Auswertungen">
            <!-- Zeitraum-Filter -->
            <div class="card" style="margin-bottom:1.5rem">
                <div style="display:flex;gap:1rem;align-items:center;flex-wrap:wrap">
                    <div class="form-group" style="margin:0">
                        <label for="aw-zeitraum" style="font-size:0.8rem;margin-bottom:0.25rem">Zeitraum</label>
                        <select id="aw-zeitraum">
                            <option value="heute">Heute</option>
                            <option value="woche" selected>Diese Woche</option>
                            <option value="monat">Dieser Monat</option>
                            <option value="quartal">Quartal</option>
                            <option value="jahr">Dieses Jahr</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin:0">
                        <label for="aw-von" style="font-size:0.8rem;margin-bottom:0.25rem">Von</label>
                        <input type="date" id="aw-von">
                    </div>
                    <div class="form-group" style="margin:0">
                        <label for="aw-bis" style="font-size:0.8rem;margin-bottom:0.25rem">Bis</label>
                        <input type="date" id="aw-bis">
                    </div>
                    <div class="form-group" style="margin:0">
                        <label for="aw-standort" style="font-size:0.8rem;margin-bottom:0.25rem">Standort</label>
                        <select id="aw-standort">
                            <option value="">Alle Standorte</option>
                            <option value="hauptpraxis">Hauptpraxis</option>
                            <option value="filiale1">Filiale Nord</option>
                            <option value="filiale2">Filiale Sued</option>
                        </select>
                    </div>
                    <button type="button" id="btn-aw-aktualisieren" class="btn-primary" style="margin-top:auto"><i class="fa-solid fa-rotate"></i> Aktualisieren</button>
                    <button type="button" id="btn-aw-export" style="margin-top:auto;background:var(--success)"><i class="fa-solid fa-file-csv"></i> CSV Export</button>
                </div>
            </div>

            <!-- KPI Uebersicht -->
            <div class="stat-grid" style="margin-bottom:1.5rem">
                <div class="stat-card">
                    <div class="stat-icon bg-primary"><i class="fa-solid fa-phone"></i></div>
                    <div class="stat-content">
                        <div class="stat-value" id="aw-anrufe-gesamt">0</div>
                        <div class="stat-label">Anrufe gesamt</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-success"><i class="fa-solid fa-phone-volume"></i></div>
                    <div class="stat-content">
                        <div class="stat-value" id="aw-angenommen">0</div>
                        <div class="stat-label">Angenommen</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-danger"><i class="fa-solid fa-phone-slash"></i></div>
                    <div class="stat-content">
                        <div class="stat-value" id="aw-verpasst">0</div>
                        <div class="stat-label">Verpasst</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-info"><i class="fa-solid fa-robot"></i></div>
                    <div class="stat-content">
                        <div class="stat-value" id="aw-voicebot">0</div>
                        <div class="stat-label">Voicebot erledigt</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-warning"><i class="fa-solid fa-clock"></i></div>
                    <div class="stat-content">
                        <div class="stat-value" id="aw-wartezeit">0s</div>
                        <div class="stat-label">Avg. Wartezeit</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon" style="background:#7c3aed"><i class="fa-solid fa-stopwatch"></i></div>
                    <div class="stat-content">
                        <div class="stat-value" id="aw-gespraechsdauer">0s</div>
                        <div class="stat-label">Avg. Gespraechsdauer</div>
                    </div>
                </div>
            </div>

            <!-- Anrufverlauf Chart (CSS-basiert) -->
            <div class="card" style="margin-bottom:1.5rem">
                <h2><i class="fa-solid fa-chart-bar"></i> Anrufverlauf</h2>
                <div id="aw-chart-anrufe" style="margin-top:1rem;display:flex;align-items:flex-end;gap:4px;height:200px;padding:0 0.5rem;border-bottom:2px solid var(--border)"></div>
                <div id="aw-chart-labels" style="display:flex;gap:4px;padding:0.5rem 0.5rem 0;font-size:0.7rem;color:var(--text-muted)"></div>
                <div style="display:flex;gap:1.5rem;margin-top:0.75rem;font-size:0.8rem;color:var(--text-muted)">
                    <span><span style="display:inline-block;width:12px;height:12px;border-radius:3px;background:var(--primary);vertical-align:middle"></span> Angenommen</span>
                    <span><span style="display:inline-block;width:12px;height:12px;border-radius:3px;background:var(--danger);vertical-align:middle"></span> Verpasst</span>
                    <span><span style="display:inline-block;width:12px;height:12px;border-radius:3px;background:var(--info);vertical-align:middle"></span> Voicebot</span>
                </div>
            </div>

            <!-- Zwei-Spalten: Agenten-Performance + Kosten -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:1.5rem">
                <!-- Agenten-Performance -->
                <div class="card">
                    <h2><i class="fa-solid fa-headset"></i> Agenten-Performance</h2>
                    <table style="width:100%;margin-top:1rem;font-size:0.85rem" id="aw-agenten-tabelle">
                        <thead>
                            <tr>
                                <th>Agent</th>
                                <th>Anrufe</th>
                                <th>Avg. Dauer</th>
                                <th>Erreichbarkeit</th>
                                <th>Bewertung</th>
                            </tr>
                        </thead>
                        <tbody id="aw-agenten-body"></tbody>
                    </table>
                </div>

                <!-- Kosten -->
                <div class="card">
                    <h2><i class="fa-solid fa-euro-sign"></i> Kosten &amp; Ersparnis</h2>
                    <div id="aw-kosten-bereich" style="margin-top:1rem"></div>
                </div>
            </div>

            <!-- Zwei-Spalten: Top Anrufgruende + Erreichbarkeit-Verlauf -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:1.5rem">
                <!-- Top Anrufgruende -->
                <div class="card">
                    <h2><i class="fa-solid fa-list-ol"></i> Top Anrufgruende</h2>
                    <div id="aw-anrufgruende" style="margin-top:1rem"></div>
                </div>

                <!-- Erreichbarkeit nach Tageszeit -->
                <div class="card">
                    <h2><i class="fa-solid fa-clock"></i> Erreichbarkeit nach Tageszeit</h2>
                    <div id="aw-tageszeit" style="margin-top:1rem"></div>
                </div>
            </div>

            <!-- Einzelverbindungsnachweis -->
            <div class="card">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <h2><i class="fa-solid fa-list"></i> Einzelverbindungsnachweis (EVN)</h2>
                    <div style="display:flex;gap:0.5rem">
                        <input type="text" id="aw-evn-suche" placeholder="Suchen..." style="font-size:0.85rem;width:200px">
                        <select id="aw-evn-filter" style="font-size:0.85rem">
                            <option value="">Alle</option>
                            <option value="angenommen">Angenommen</option>
                            <option value="verpasst">Verpasst</option>
                            <option value="voicebot">Voicebot</option>
                            <option value="weiterleitung">Weiterleitung</option>
                        </select>
                    </div>
                </div>
                <table style="width:100%;margin-top:1rem;font-size:0.85rem">
                    <thead>
                        <tr>
                            <th>Datum/Zeit</th>
                            <th>Rufnummer</th>
                            <th>Richtung</th>
                            <th>Agent</th>
                            <th>Dauer</th>
                            <th>Status</th>
                            <th>Kosten</th>
                        </tr>
                    </thead>
                    <tbody id="aw-evn-body"></tbody>
                </table>
                <div id="aw-evn-paging" style="display:flex;justify-content:space-between;align-items:center;margin-top:1rem;font-size:0.85rem"></div>
            </div>
        </div>

        <div class="spa-page" id="spa-standort" data-title="Standort &amp; ACD">
            <!-- ===== Branchen-Konfiguration ===== -->
            <section class="card" id="branche-auswahl">
                <h2><i class="fa-solid fa-briefcase"></i> Branche &amp; Buero-Typ</h2>
                <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1rem">Waehlen Sie Ihre Branche. Alle Texte, der KI-Assistent und der Voicebot passen sich automatisch an.</p>
                <div class="form-row">
                    <div class="form-group">
                        <label for="branche-select">Branche</label>
                        <select id="branche-select"></select>
                    </div>
                    <div class="form-group">
                        <label for="branche-firmenname">Firmenname (optional)</label>
                        <input type="text" id="branche-firmenname" placeholder="z.B. Praxis Dr. Mueller, Kanzlei Schmidt, Salon Anna...">
                    </div>
                </div>
                <div id="branche-vorschau" style="background:var(--bg);padding:0.75rem;border-radius:8px;margin:0.5rem 0 1rem"></div>
                <button type="button" id="btn-branche-speichern"><i class="fa-solid fa-save"></i> Branche speichern</button>
                <div id="branche-erfolg" class="ergebnis" hidden></div>
            </section>

            <!-- ===== Standort-Info ===== -->
            <section class="card">
                <h2><i class="fa-solid fa-location-dot"></i> Standort-Informationen</h2>
                <form id="standort-info-form">
                    <div class="form-row">
                        <div class="form-group"><label for="standort-name">Standortname</label><input type="text" id="standort-name" value="MED Rezeption Berlin Mitte"></div>
                        <div class="form-group"><label for="standort-telefon">Hauptnummer</label><input type="tel" id="standort-telefon" value="030-123 456 0"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label for="standort-strasse">Adresse</label><input type="text" id="standort-strasse" value="Friedrichstr. 100, 10117 Berlin"></div>
                        <div class="form-group"><label for="standort-notfall">Notfall-Nebenstelle</label><input type="text" id="standort-notfall" value="200"></div>
                    </div>
                    <button type="submit"><i class="fa-solid fa-save"></i> Standort speichern</button>
                </form>
                <div id="standort-info-erfolg" class="ergebnis" hidden></div>
            </section>

            <!-- ===== ACD Konfiguration ===== -->
            <section class="card">
                <h2><i class="fa-solid fa-shuffle"></i> ACD-Anrufverteilung</h2>
                <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1rem">Legen Sie fest, wie eingehende Anrufe am Standort verteilt werden. Die Zeitsteuerung unten ueberschreibt den Standard-Modus fuer bestimmte Tage und Uhrzeiten.</p>

                <div class="form-group">
                    <label><i class="fa-solid fa-sliders"></i> Standard ACD-Modus</label>
                </div>
                <div class="acd-modus-auswahl" id="acd-modus-auswahl">
                    <div class="acd-modus-karte selected" data-modus="alle_annehmen">
                        <div class="acd-modus-icon"><i class="fa-solid fa-phone-volume"></i></div>
                        <div class="acd-modus-info">
                            <h3>Alle Anrufe annehmen</h3>
                            <p>Anrufe klingeln bei allen verfuegbaren Agenten und Standortleitung. Kein Bot.</p>
                        </div>
                        <div class="acd-modus-check"><i class="fa-solid fa-circle-check"></i></div>
                    </div>
                    <div class="acd-modus-karte" data-modus="klingeln_dann_bot">
                        <div class="acd-modus-icon"><i class="fa-solid fa-bell"></i></div>
                        <div class="acd-modus-info">
                            <h3>3x Klingeln, dann Bot</h3>
                            <p>Es klingelt dreimal bei den Agenten. Nimmt niemand ab, uebernimmt der Voicebot.</p>
                        </div>
                        <div class="acd-modus-check"><i class="fa-solid fa-circle-check"></i></div>
                    </div>
                    <div class="acd-modus-karte" data-modus="bot_direkt">
                        <div class="acd-modus-icon"><i class="fa-solid fa-robot"></i></div>
                        <div class="acd-modus-info">
                            <h3>Bot nimmt direkt an</h3>
                            <p>Alle Anrufe werden sofort vom Voicebot angenommen und verarbeitet.</p>
                        </div>
                        <div class="acd-modus-check"><i class="fa-solid fa-circle-check"></i></div>
                    </div>
                </div>

                <div class="form-row" style="margin-top:1rem">
                    <div class="form-group">
                        <label for="acd-klingelanzahl">Klingelanzahl (bei "Klingeln dann Bot")</label>
                        <input type="number" id="acd-klingelanzahl" value="3" min="1" max="10">
                    </div>
                    <div class="form-group">
                        <label for="acd-klingel-timeout">Klingel-Timeout (Sekunden)</label>
                        <input type="number" id="acd-klingel-timeout" value="15" min="5" max="60">
                    </div>
                    <div class="form-group">
                        <label for="acd-verteilung">Verteilungsstrategie</label>
                        <select id="acd-verteilung">
                            <option value="alle_gleichzeitig">Alle gleichzeitig klingeln</option>
                            <option value="rundlauf">Rundlauf (Round Robin)</option>
                            <option value="laengste_pause">Laengste Pause zuerst</option>
                            <option value="wenigste_anrufe">Wenigste Anrufe zuerst</option>
                        </select>
                    </div>
                </div>
                <button type="button" id="btn-acd-speichern"><i class="fa-solid fa-save"></i> ACD-Modus speichern</button>
                <div id="acd-modus-erfolg" class="ergebnis" hidden></div>
            </section>

            <!-- ===== Zeitsteuerung ===== -->
            <section class="card">
                <h2><i class="fa-solid fa-clock"></i> Zeitsteuerung (ACD pro Tag &amp; Uhrzeit)</h2>
                <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1rem">Definieren Sie fuer jeden Wochentag individuelle ACD-Regeln. Ausserhalb der definierten Zeiten gilt der Standard-Modus.</p>

                <div class="zeitplan-tabelle-wrapper">
                    <table class="zeitplan-tabelle" id="zeitplan-tabelle">
                        <thead>
                            <tr>
                                <th>Tag</th>
                                <th>Aktiv</th>
                                <th>Von</th>
                                <th>Bis</th>
                                <th>ACD-Modus</th>
                                <th>Pause Von</th>
                                <th>Pause Bis</th>
                                <th>Pause-Modus</th>
                            </tr>
                        </thead>
                        <tbody id="zeitplan-body">
                            <!-- Wird per JS generiert -->
                        </tbody>
                    </table>
                </div>
                <div class="button-gruppe" style="margin-top:1rem">
                    <button type="button" id="btn-zeitplan-speichern"><i class="fa-solid fa-save"></i> Zeitplan speichern</button>
                    <button type="button" id="btn-zeitplan-reset" class="btn-secondary"><i class="fa-solid fa-rotate-right"></i> Standard wiederherstellen</button>
                </div>
                <div id="zeitplan-erfolg" class="ergebnis" hidden></div>
            </section>

            <!-- ===== Aktueller ACD-Status ===== -->
            <section class="card">
                <h2><i class="fa-solid fa-signal"></i> Aktueller ACD-Status (Live)</h2>
                <div class="acd-live-status" id="acd-live-status">
                    <!-- Wird per JS generiert -->
                </div>
            </section>

            <!-- ===== Standortleitung ===== -->
            <section class="card">
                <h2><i class="fa-solid fa-user-tie"></i> Standortleitung &amp; Teamleiter</h2>
                <p style="color:var(--text-muted);font-size:0.85rem;margin-bottom:1rem">Standortleitung und Teamleiter verfuegen ueber die gleichen Telefonfunktionen wie Agenten: Nebenstelle, SIP, Warteschlangen-Zuweisung und Status-Steuerung.</p>

                <form id="standortleitung-form">
                    <input type="hidden" id="sl-id">
                    <div class="form-row">
                        <div class="form-group"><label for="sl-name">Name</label><input type="text" id="sl-name" required></div>
                        <div class="form-group"><label for="sl-rolle">Rolle</label>
                            <select id="sl-rolle">
                                <option value="standortleitung">Standortleitung</option>
                                <option value="teamleiter">Teamleiter</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label for="sl-nebenstelle">Nebenstelle</label><input type="text" id="sl-nebenstelle" required placeholder="z.B. 300"></div>
                        <div class="form-group"><label for="sl-sip-passwort">SIP-Passwort</label><input type="password" id="sl-sip-passwort" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label for="sl-warteschlange">Warteschlange</label>
                            <select id="sl-warteschlange">
                                <option value="rezeption">Rezeption</option>
                                <option value="terminvergabe">Terminvergabe</option>
                                <option value="dringend">Dringend</option>
                                <option value="allgemein">Allgemein</option>
                                <option value="alle">Alle Warteschlangen</option>
                            </select>
                        </div>
                        <div class="form-group"><label for="sl-telefon">Mobilnummer (optional)</label><input type="tel" id="sl-telefon" placeholder="z.B. 0170-1234567"></div>
                    </div>
                    <div class="form-group"><label for="sl-email">E-Mail</label><input type="email" id="sl-email" placeholder="leitung@praxis.de"></div>
                    <div class="button-gruppe">
                        <button type="submit" id="btn-sl-speichern">Speichern</button>
                        <button type="button" id="btn-sl-abbrechen" hidden>Abbrechen</button>
                    </div>
                </form>
                <div id="sl-erfolg" class="ergebnis" hidden></div>
                <div id="sl-fehler" class="fehler" hidden></div>
            </section>

            <!-- ===== Standortleitung-Board (wie Agenten) ===== -->
            <section class="card">
                <h2>Standortleitung &amp; Teamleiter - Board</h2>
                <div class="agenten-grid" id="standortleitung-karten">
                    <!-- Wird per JS generiert -->
                </div>
            </section>

            <!-- ===== Statistiken ===== -->
            <section class="card">
                <h2><i class="fa-solid fa-chart-bar"></i> ACD-Statistiken (heute)</h2>
                <div class="stat-grid">
                    <div class="stat-card">
                        <div class="stat-icon bg-primary"><i class="fa-solid fa-phone-volume"></i></div>
                        <div class="stat-content">
                            <div class="stat-value" id="acd-stat-anrufe">0</div>
                            <div class="stat-label">Eingehende Anrufe</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon bg-success"><i class="fa-solid fa-phone-flip"></i></div>
                        <div class="stat-content">
                            <div class="stat-value" id="acd-stat-angenommen">0</div>
                            <div class="stat-label">Angenommen</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon bg-info"><i class="fa-solid fa-robot"></i></div>
                        <div class="stat-content">
                            <div class="stat-value" id="acd-stat-bot">0</div>
                            <div class="stat-label">Bot bearbeitet</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon bg-danger"><i class="fa-solid fa-phone-slash"></i></div>
                        <div class="stat-content">
                            <div class="stat-value" id="acd-stat-verpasst">0</div>
                            <div class="stat-label">Verpasst</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon bg-warning"><i class="fa-solid fa-clock"></i></div>
                        <div class="stat-content">
                            <div class="stat-value" id="acd-stat-wartezeit">0s</div>
                            <div class="stat-label">Avg. Wartezeit</div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <div class="spa-page" id="spa-callflow" data-title="Callflow Editor">
            <div class="callflow-layout">
                <div class="callflow-toolbar card">
                    <h3><i class="fa-solid fa-puzzle-piece"></i> Bausteine</h3>
                    <div class="callflow-baustein-liste">
                        <button class="callflow-baustein" data-typ="ansage" type="button"><i class="fa-solid fa-volume-high"></i> Ansage</button>
                        <button class="callflow-baustein" data-typ="dtmf" type="button"><i class="fa-solid fa-dial-pad fa-hashtag"></i> DTMF-Menue</button>
                        <button class="callflow-baustein" data-typ="voicebot" type="button"><i class="fa-solid fa-robot"></i> Voicebot</button>
                        <button class="callflow-baustein" data-typ="warteschlange" type="button"><i class="fa-solid fa-users-line"></i> Warteschlange</button>
                        <button class="callflow-baustein" data-typ="transfer" type="button"><i class="fa-solid fa-phone-arrow-right fa-right-left"></i> Transfer</button>
                        <button class="callflow-baustein" data-typ="bedingung" type="button"><i class="fa-solid fa-code-branch"></i> Bedingung</button>
                        <button class="callflow-baustein" data-typ="aufnahme" type="button"><i class="fa-solid fa-microphone"></i> Aufnahme</button>
                        <button class="callflow-baustein" data-typ="ende" type="button"><i class="fa-solid fa-phone-slash"></i> Auflegen</button>
                    </div>
                </div>
                <div class="callflow-canvas card" id="callflow-canvas">
                    <div class="callflow-flow" id="callflow-flow">
                        <!-- Nodes werden per JS geladen -->
                    </div>
                </div>
                <div class="callflow-properties card" id="callflow-properties">
                    <h3><i class="fa-solid fa-sliders"></i> Eigenschaften</h3>
                    <div id="callflow-props-inhalt">
                        <p class="text-muted">Klicken Sie auf einen Baustein um ihn zu bearbeiten.</p>
                    </div>
                </div>
            </div>
            <div id="callflow-simulation" class="card" hidden>
                <h2><i class="fa-solid fa-play-circle"></i> Simulation</h2>
                <div id="simulation-ablauf"></div>
                <div class="button-gruppe">
                    <button id="btn-sim-schritt" type="button"><i class="fa-solid fa-forward-step"></i> Naechster Schritt</button>
                    <button id="btn-sim-dtmf" type="button"><i class="fa-solid fa-hashtag"></i> DTMF Eingabe</button>
                    <button id="btn-sim-stop" type="button" class="btn-secondary"><i class="fa-solid fa-stop"></i> Stopp</button>
                </div>
            </div>
        </div>

        <div class="spa-page" id="spa-voicebot" data-title="Voicebot">
            <div class="stat-grid">
                <div class="stat-card">
                    <div class="stat-icon bg-primary"><i class="fa-solid fa-phone-volume"></i></div>
                    <div class="stat-content">
                        <div class="stat-value" id="vb-stat-anrufe">47</div>
                        <div class="stat-label">Anrufe heute</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-success"><i class="fa-solid fa-calendar-check"></i></div>
                    <div class="stat-content">
                        <div class="stat-value" id="vb-stat-termine">12</div>
                        <div class="stat-label">Termine gebucht</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-info"><i class="fa-solid fa-prescription"></i></div>
                    <div class="stat-content">
                        <div class="stat-value" id="vb-stat-rezepte">8</div>
                        <div class="stat-label">Rezept-Anfragen</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon bg-warning"><i class="fa-solid fa-right-left"></i></div>
                    <div class="stat-content">
                        <div class="stat-value" id="vb-stat-transfers">27</div>
                        <div class="stat-label">Weiterleitungen</div>
                    </div>
                </div>
            </div>

            <div class="voicebot-grid">
                <section class="card">
                    <h2><i class="fa-solid fa-gear"></i> Voicebot Konfiguration</h2>
                    <form id="voicebot-config-form">
                        <div class="form-group">
                            <label for="vb-begruessung">Begruessung</label>
                            <textarea id="vb-begruessung" rows="3">Willkommen bei der Arztpraxis MED Rezeption. Druecken Sie 1 fuer Terminvergabe, 2 fuer Rezeptbestellung, 3 fuer die Rezeption.</textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="vb-sprache">Sprache</label>
                                <select id="vb-sprache">
                                    <option value="de-DE" selected>Deutsch</option>
                                    <option value="en-US">English</option>
                                    <option value="tr-TR">Tuerkisch</option>
                                    <option value="ar-SA">Arabisch</option>
                                    <option value="ru-RU">Russisch</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="vb-stimme">Stimme</label>
                                <select id="vb-stimme">
                                    <option value="weiblich" selected>Weiblich</option>
                                    <option value="maennlich">Maennlich</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="vb-max-versuche">Max. Wiederholungen</label>
                                <input type="number" id="vb-max-versuche" value="2" min="1" max="5">
                            </div>
                            <div class="form-group">
                                <label for="vb-timeout">Timeout (Sek.)</label>
                                <input type="number" id="vb-timeout" value="8" min="3" max="30">
                            </div>
                        </div>
                        <h3>DTMF-Menue Zuordnung</h3>
                        <div class="form-group">
                            <label>Taste 1</label>
                            <select id="vb-taste1">
                                <option value="termin" selected>Terminvergabe (Voicebot)</option>
                                <option value="warteschlange">Warteschlange</option>
                                <option value="transfer">Transfer zu Nebenstelle</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Taste 2</label>
                            <select id="vb-taste2">
                                <option value="rezept" selected>Rezeptbestellung (Voicebot)</option>
                                <option value="warteschlange">Warteschlange</option>
                                <option value="transfer">Transfer zu Nebenstelle</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Taste 3</label>
                            <select id="vb-taste3">
                                <option value="transfer" selected>Transfer Rezeption</option>
                                <option value="warteschlange">Warteschlange</option>
                                <option value="termin">Terminvergabe (Voicebot)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Taste 0</label>
                            <select id="vb-taste0">
                                <option value="warteschlange" selected>Warteschlange Rezeption</option>
                                <option value="transfer">Transfer</option>
                            </select>
                        </div>
                        <div class="button-gruppe">
                            <button type="submit"><i class="fa-solid fa-save"></i> Konfiguration speichern</button>
                            <button type="button" id="btn-vb-test" class="btn-success-sm"><i class="fa-solid fa-vial"></i> Voicebot testen</button>
                        </div>
                    </form>
                    <div id="vb-config-erfolg" class="ergebnis" hidden></div>
                </section>

                <section class="card">
                    <h2><i class="fa-solid fa-clock-rotate-left"></i> Letzte Voicebot-Anrufe</h2>
                    <div id="voicebot-anrufe-liste">
                        <!-- wird per JS geladen -->
                    </div>
                </section>
            </div>

            <section class="card" id="voicebot-test-bereich" hidden>
                <h2><i class="fa-solid fa-vial"></i> Voicebot Test-Dialog</h2>
                <div class="voicebot-test-chat" id="vb-test-chat">
                    <!-- Test-Dialog wird hier gerendert -->
                </div>
                <div class="voicebot-test-eingabe">
                    <div class="vb-dtmf-tasten">
                        <button type="button" class="vb-dtmf" data-dtmf="1">1</button>
                        <button type="button" class="vb-dtmf" data-dtmf="2">2</button>
                        <button type="button" class="vb-dtmf" data-dtmf="3">3</button>
                        <button type="button" class="vb-dtmf" data-dtmf="0">0</button>
                    </div>
                    <button type="button" id="btn-vb-test-reset"><i class="fa-solid fa-rotate-right"></i> Neustart</button>
                </div>
            </section>
        </div>

        <div class="spa-page" id="spa-agenten" data-title="Agenten">
            <section id="agent-formular" class="card">
                <h2 id="agent-formular-titel">Agent anlegen</h2>
                <form id="agent-form">
                    <input type="hidden" id="agent-id">
                    <div class="form-row">
                        <div class="form-group"><label for="agent-name">Name</label><input type="text" id="agent-name" required></div>
                        <div class="form-group"><label for="agent-nebenstelle">Nebenstelle</label><input type="text" id="agent-nebenstelle" required></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label for="agent-sip-passwort">SIP-Passwort</label><input type="password" id="agent-sip-passwort" required></div>
                        <div class="form-group"><label for="agent-rolle">Rolle</label><select id="agent-rolle"><option value="rezeption">Rezeption</option><option value="arzt">Arzt</option><option value="verwaltung">Verwaltung</option><option value="teamleiter">Teamleiter</option><option value="standortleitung">Standortleitung</option></select></div>
                    </div>
                    <div class="form-group"><label for="agent-warteschlange">Warteschlange</label><select id="agent-warteschlange"><option value="rezeption">Rezeption</option><option value="terminvergabe">Terminvergabe</option><option value="dringend">Dringend</option><option value="allgemein">Allgemein</option></select></div>
                    <div class="button-gruppe">
                        <button type="submit" id="btn-agent-speichern">Speichern</button>
                        <button type="button" id="btn-agent-abbrechen" hidden>Abbrechen</button>
                    </div>
                </form>
                <div id="agent-erfolg" class="ergebnis" hidden></div>
                <div id="agent-fehler" class="fehler" hidden></div>
            </section>
            <section class="card">
                <h2>Agenten-Board</h2>
                <div class="agenten-grid" id="agenten-karten"></div>
            </section>
            <section class="card">
                <div class="section-header">
                    <h2>Aktive Anrufe</h2>
                    <span class="badge badge-rot" id="anrufe-aktiv-badge">0 aktiv</span>
                </div>
                <div id="aktive-anrufe-liste"></div>
            </section>
            <section class="card">
                <h2>Anrufprotokoll</h2>
                <div class="table-container">
                    <table id="anrufe-tabelle">
                        <thead><tr><th>Zeit</th><th>Anrufer</th><th>Agent</th><th>Queue</th><th>Typ</th><th>Status</th><th>Dauer</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>
        </div>

        <div class="spa-page" id="spa-softphone" data-title="Softphone">
            <div style="max-width:400px;margin:0 auto">
                <section class="softphone-panel">
                    <h3>SIP-Verbindung</h3>
                    <div id="sip-status" class="sip-status offline">Nicht verbunden</div>
                    <form id="sip-form">
                        <div class="form-group"><label for="sip-server">SIP-Server</label><input type="text" id="sip-server" value="sip.praxis-demo.de"></div>
                        <div class="form-group"><label for="sip-benutzer">Benutzer</label><input type="text" id="sip-benutzer" value="100"></div>
                        <div class="form-group"><label for="sip-passwort">Passwort</label><input type="password" id="sip-passwort" value="demo123"></div>
                        <button type="submit" id="btn-sip-verbinden">Verbinden</button>
                        <button type="button" id="btn-sip-trennen" hidden>Trennen</button>
                    </form>
                </section>
                <section class="softphone-panel">
                    <h3>Waehlfeld</h3>
                    <div class="form-group"><input type="text" id="wahlnummer" placeholder="Nummer eingeben..." style="text-align:center;font-size:1.3rem"></div>
                    <div class="dialpad">
                        <button type="button" class="dialpad-taste" data-dtmf="1">1</button>
                        <button type="button" class="dialpad-taste" data-dtmf="2">2</button>
                        <button type="button" class="dialpad-taste" data-dtmf="3">3</button>
                        <button type="button" class="dialpad-taste" data-dtmf="4">4</button>
                        <button type="button" class="dialpad-taste" data-dtmf="5">5</button>
                        <button type="button" class="dialpad-taste" data-dtmf="6">6</button>
                        <button type="button" class="dialpad-taste" data-dtmf="7">7</button>
                        <button type="button" class="dialpad-taste" data-dtmf="8">8</button>
                        <button type="button" class="dialpad-taste" data-dtmf="9">9</button>
                        <button type="button" class="dialpad-taste" data-dtmf="*">*</button>
                        <button type="button" class="dialpad-taste" data-dtmf="0">0</button>
                        <button type="button" class="dialpad-taste" data-dtmf="#">#</button>
                    </div>
                    <div class="button-gruppe anruf-buttons">
                        <button type="button" id="btn-anrufen" class="btn-anrufen">Anrufen</button>
                        <button type="button" id="btn-auflegen" class="btn-auflegen" hidden>Auflegen</button>
                        <button type="button" id="btn-annehmen" class="btn-annehmen" hidden>Annehmen</button>
                    </div>
                </section>
                <section class="softphone-panel" id="anruf-info" hidden>
                    <div id="anruf-gegenstelle"></div>
                    <div id="anruf-timer">00:00</div>
                    <div id="anruf-status-anzeige"></div>
                </section>
            </div>
        </div>

        <div class="spa-page" id="spa-uebersetzung" data-title="Uebersetzer">
            <section class="card">
                <h2><i class="fa-solid fa-comments"></i> Echtzeit-Uebersetzung</h2>
                <div class="uebersetzer-layout">
                    <div class="uebersetzer-spalte">
                        <div class="form-group">
                            <label for="ue-sprache-von">Von</label>
                            <select id="ue-sprache-von">
                                <option value="de" selected>Deutsch</option>
                                <option value="en">Englisch</option>
                                <option value="tr">Tuerkisch</option>
                                <option value="ar">Arabisch</option>
                                <option value="ru">Russisch</option>
                                <option value="pl">Polnisch</option>
                            </select>
                        </div>
                        <textarea id="ue-eingabe" rows="5" placeholder="Text eingeben oder Mikrofon nutzen..."></textarea>
                        <div class="button-gruppe">
                            <button type="button" id="btn-ue-mikrofon"><i class="fa-solid fa-microphone"></i> Sprechen</button>
                            <button type="button" id="btn-ue-uebersetzen"><i class="fa-solid fa-arrows-rotate"></i> Uebersetzen</button>
                        </div>
                    </div>
                    <div class="uebersetzer-mitte">
                        <button type="button" id="btn-ue-tauschen" title="Sprachen tauschen"><i class="fa-solid fa-right-left"></i></button>
                    </div>
                    <div class="uebersetzer-spalte">
                        <div class="form-group">
                            <label for="ue-sprache-nach">Nach</label>
                            <select id="ue-sprache-nach">
                                <option value="de">Deutsch</option>
                                <option value="en" selected>Englisch</option>
                                <option value="tr">Tuerkisch</option>
                                <option value="ar">Arabisch</option>
                                <option value="ru">Russisch</option>
                                <option value="pl">Polnisch</option>
                            </select>
                        </div>
                        <div id="ue-ausgabe" class="uebersetzer-ausgabe">Uebersetzung erscheint hier...</div>
                        <div class="button-gruppe">
                            <button type="button" id="btn-ue-vorlesen"><i class="fa-solid fa-volume-high"></i> Vorlesen</button>
                            <button type="button" id="btn-ue-kopieren"><i class="fa-solid fa-copy"></i> Kopieren</button>
                        </div>
                    </div>
                </div>
            </section>

            <section class="card">
                <h2><i class="fa-solid fa-book-medical"></i> Medizinische Schnell-Phrasen</h2>
                <div class="form-group">
                    <label for="ue-phrasen-sprache">Zielsprache</label>
                    <select id="ue-phrasen-sprache">
                        <option value="en">Englisch</option>
                        <option value="tr">Tuerkisch</option>
                        <option value="ar">Arabisch</option>
                        <option value="ru">Russisch</option>
                        <option value="pl">Polnisch</option>
                    </select>
                </div>
                <div class="phrasen-kategorien">
                    <button type="button" class="phrasen-kat active" data-kat="begruessung">Begruessung</button>
                    <button type="button" class="phrasen-kat" data-kat="anamnese">Anamnese</button>
                    <button type="button" class="phrasen-kat" data-kat="schmerzen">Schmerzen</button>
                    <button type="button" class="phrasen-kat" data-kat="behandlung">Behandlung</button>
                    <button type="button" class="phrasen-kat" data-kat="termin">Termin</button>
                    <button type="button" class="phrasen-kat" data-kat="rezept">Rezept</button>
                </div>
                <div id="phrasen-liste" class="phrasen-grid">
                    <!-- Phrasen werden per JS geladen -->
                </div>
            </section>

            <section class="card">
                <h2><i class="fa-solid fa-clock-rotate-left"></i> Uebersetzungs-Verlauf</h2>
                <div class="table-container">
                    <table id="ue-verlauf-tabelle">
                        <thead><tr><th>Original</th><th>Uebersetzung</th><th>Sprachen</th><th>Zeit</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>
        </div>

        <div class="spa-page" id="spa-benutzer" data-title="Benutzer">
            <section id="benutzer-formular" class="card">
                <h2 id="formular-titel">Benutzer anlegen</h2>
                <form id="benutzer-form">
                    <input type="hidden" id="benutzer-id">
                    <div class="form-row">
                        <div class="form-group"><label for="name">Name</label><input type="text" id="name" required></div>
                        <div class="form-group"><label for="email">E-Mail</label><input type="email" id="email" required></div>
                    </div>
                    <div class="form-group"><label for="alter">Alter</label><input type="number" id="alter" min="0" max="150" required></div>
                    <fieldset><legend>Adresse</legend>
                        <div class="form-group"><label for="strasse">Strasse</label><input type="text" id="strasse"></div>
                        <div class="form-row">
                            <div class="form-group"><label for="plz">PLZ</label><input type="text" id="plz" maxlength="5" pattern="[0-9]{5}"></div>
                            <div class="form-group"><label for="stadt">Stadt</label><input type="text" id="stadt"></div>
                        </div>
                    </fieldset>
                    <div class="button-gruppe">
                        <button type="submit" id="btn-speichern">Speichern</button>
                        <button type="button" id="btn-abbrechen" hidden>Abbrechen</button>
                    </div>
                </form>
                <div id="benutzer-erfolg" class="ergebnis" hidden></div>
                <div id="benutzer-fehler" class="fehler" hidden></div>
            </section>
            <section class="card">
                <h2>Benutzerliste</h2>
                <div class="suche-box"><input type="text" id="benutzer-suche" placeholder="Benutzer suchen..."></div>
                <div class="table-container">
                    <table id="benutzer-tabelle">
                        <thead><tr><th>ID</th><th>Name</th><th>E-Mail</th><th>Alter</th><th>Stadt</th><th>Aktionen</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </section>
            <section id="rechner" class="card">
                <h2>Rechner</h2>
                <form id="rechner-form">
                    <div class="form-row">
                        <div class="form-group"><label for="zahl-a">Zahl A</label><input type="number" id="zahl-a" step="any" required></div>
                        <div class="form-group"><label for="operation">Operation</label>
                            <select id="operation" required>
                                <option value="addieren">+ Addieren</option>
                                <option value="subtrahieren">- Subtrahieren</option>
                                <option value="multiplizieren">&times; Multiplizieren</option>
                                <option value="dividieren">&divide; Dividieren</option>
                            </select>
                        </div>
                        <div class="form-group"><label for="zahl-b">Zahl B</label><input type="number" id="zahl-b" step="any" required></div>
                    </div>
                    <button type="submit">Berechnen</button>
                </form>
                <div id="ergebnis" class="ergebnis" hidden><strong>Ergebnis:</strong> <span id="ergebnis-wert"></span></div>
                <div id="fehler" class="fehler" hidden></div>
                <div style="margin-top:1.5rem">
                    <div class="verlauf-header"><h3>Verlauf</h3><button id="btn-verlauf-loeschen" class="btn-loeschen" type="button">Loeschen</button></div>
                    <table id="verlauf-tabelle"><thead><tr><th>Rechnung</th><th>Ergebnis</th><th>Zeit</th></tr></thead><tbody></tbody></table>
                </div>
            </section>
        </div>

    </main>
</div>

<!-- Chat Widget -->
<button id="chat-toggle" type="button"><i class="fa-solid fa-comment-dots"></i></button>
<div id="chat-fenster">
    <div class="chat-header"><span><i class="fa-solid fa-robot"></i> Praxis-Assistent</span><button id="chat-schliessen" type="button"><i class="fa-solid fa-xmark"></i></button></div>
    <div id="chat-nachrichten"></div>
    <div class="chat-eingabe">
        <input id="chat-input" type="text" placeholder="Frage stellen oder sprechen...">
        <button id="chat-mikrofon" type="button" title="Sprechen"><i class="fa-solid fa-microphone"></i></button>
        <button id="chat-senden" type="button"><i class="fa-solid fa-paper-plane"></i></button>
    </div>
</div>

<script>
/** MED Rezeption Frontend-Logik - Demo & Live-Version */

var API_BASE = "/api";

// ===== Branchen-Konfiguration (Office-Typen) =====

var BRANCHEN = {
    arztpraxis: { label: "Arztpraxis", buero_name: "Praxis", verwaltung: "Praxisverwaltung", assistent: "Praxis-Assistent", kunden: "Patienten", mitarbeiter: "Aerzte", dienste: ["Terminvergabe", "Rezeptbestellung", "Weiterleitung an Rezeption"], notfall: "Bei Notfaellen rufen Sie 112 an.", spezial: "Keine medizinischen Diagnosen oder Behandlungsratschlaege." },
    zahnarzt: { label: "Zahnarztpraxis", buero_name: "Praxis", verwaltung: "Praxisverwaltung", assistent: "Praxis-Assistent", kunden: "Patienten", mitarbeiter: "Zahnaerzte", dienste: ["Terminvergabe", "Rezeptbestellung", "Weiterleitung"], notfall: "Bei Notfaellen rufen Sie 112 an.", spezial: "" },
    anwalt: { label: "Rechtsanwaltskanzlei", buero_name: "Kanzlei", verwaltung: "Kanzleiverwaltung", assistent: "Kanzlei-Assistent", kunden: "Mandanten", mitarbeiter: "Anwaelte", dienste: ["Terminvergabe", "Dokumentenanfrage", "Weiterleitung"], notfall: "", spezial: "Keine Rechtsberatung erteilen." },
    steuerberater: { label: "Steuerberatungsbuero", buero_name: "Buero", verwaltung: "Bueroverwaltung", assistent: "Buero-Assistent", kunden: "Mandanten", mitarbeiter: "Steuerberater", dienste: ["Terminvergabe", "Dokumentenanfrage", "Weiterleitung"], notfall: "", spezial: "" },
    friseur: { label: "Friseursalon", buero_name: "Salon", verwaltung: "Salonverwaltung", assistent: "Salon-Assistent", kunden: "Kunden", mitarbeiter: "Friseure", dienste: ["Terminvergabe", "Weiterleitung"], notfall: "", spezial: "" },
    werkstatt: { label: "KFZ-Werkstatt", buero_name: "Werkstatt", verwaltung: "Werkstattverwaltung", assistent: "Werkstatt-Assistent", kunden: "Kunden", mitarbeiter: "Mechaniker", dienste: ["Terminvergabe", "Statusabfrage", "Weiterleitung"], notfall: "Pannen: ADAC 0800-5 10 11 12", spezial: "" },
    tierarzt: { label: "Tierarztpraxis", buero_name: "Praxis", verwaltung: "Praxisverwaltung", assistent: "Praxis-Assistent", kunden: "Tierhalter", mitarbeiter: "Tieraerzte", dienste: ["Terminvergabe", "Weiterleitung"], notfall: "Tier-Notfall: Sofort vorbeikommen.", spezial: "" },
    allgemein: { label: "Allgemeines Buero", buero_name: "Buero", verwaltung: "Bueroverwaltung", assistent: "Buero-Assistent", kunden: "Kunden", mitarbeiter: "Mitarbeiter", dienste: ["Terminvergabe", "Weiterleitung"], notfall: "", spezial: "" }
};

var MED_BRANCHE_KEY = "arztpraxis";
var MED_BRANCHE = BRANCHEN.arztpraxis;
var MED_FIRMEN_NAME = "";

function brancheLaden() {
    try {
        var gespeichert = localStorage.getItem("med_branche");
        if (gespeichert) {
            var daten = JSON.parse(gespeichert);
            MED_BRANCHE_KEY = daten.key || "arztpraxis";
            MED_FIRMEN_NAME = daten.firmen_name || "";
            MED_BRANCHE = BRANCHEN[MED_BRANCHE_KEY] || BRANCHEN.arztpraxis;
        }
    } catch (e) {}
}

function brancheSpeichern(key, firmenName) {
    MED_BRANCHE_KEY = key;
    MED_BRANCHE = BRANCHEN[key] || BRANCHEN.arztpraxis;
    MED_FIRMEN_NAME = firmenName || "";
    localStorage.setItem("med_branche", JSON.stringify({ key: key, firmen_name: firmenName }));
    brancheAnwenden();
}

function brancheAnwenden() {
    var b = MED_BRANCHE;
    var name = MED_FIRMEN_NAME || b.label;

    // Sidebar-Titel
    var sidebarTitel = document.querySelectorAll(".sidebar h2");
    for (var i = 0; i < sidebarTitel.length; i++) {
        sidebarTitel[i].textContent = name;
    }
    var sidebarSub = document.querySelectorAll(".sidebar small");
    for (var j = 0; j < sidebarSub.length; j++) {
        sidebarSub[j].textContent = b.verwaltung;
    }

    // Chat-Assistent Label
    var chatHeaders = document.querySelectorAll(".chat-header span");
    for (var k = 0; k < chatHeaders.length; k++) {
        chatHeaders[k].innerHTML = '<i class="fa-solid fa-robot"></i> ' + escapeHtmlSafe(b.assistent);
    }

    // Seiten-Titel
    if (document.title.indexOf("MED Rezeption") !== -1 || document.title.indexOf(b.label) !== -1) {
        document.title = document.title.replace(/MED Rezeption|[\w\-]+praxis|[\w\-]+kanzlei|[\w\-]+buero|[\w\-]+salon|[\w\-]+werkstatt/gi, name);
    }
}

// ===== Modus-Erkennung (Demo / Live) =====

var MED_MODUS = "demo"; // "demo" = localStorage, "live" = Backend + LLM
var MED_LLM_VERFUEGBAR = false;

function modusPruefen() {
    // Pruefe ob Backend + LLM erreichbar ist
    try {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", API_BASE + "/llm/status", true);
        xhr.timeout = 3000;
        xhr.onload = function () {
            if (xhr.status === 200) {
                try {
                    var daten = JSON.parse(xhr.responseText);
                    if (daten.verfuegbar) {
                        MED_MODUS = "live";
                        MED_LLM_VERFUEGBAR = true;
                        modusAnzeigeAktualisieren();
                    }
                } catch (e) {}
            }
        };
        xhr.send();
    } catch (e) {}
}

function modusAnzeigeAktualisieren() {
    var badges = document.querySelectorAll(".topbar-right");
    for (var i = 0; i < badges.length; i++) {
        var badge = badges[i];
        if (badge.textContent.trim() === "Demo-Modus") {
            badge.innerHTML = '<span class="badge badge-gruen"><i class="fa-solid fa-circle" style="font-size:0.5rem"></i> Live-Modus (KI aktiv)</span>';
        }
    }
}

// ===== Guard / Auth Check =====

function guardPruefen() {
    // Portal-Check: Zutrittscode muss eingegeben sein
    if (!sessionStorage.getItem("med_portal_ok")) {
        window.location.href = "portal.html";
        return null;
    }
    var auth = sessionStorage.getItem("med_guard_auth") || localStorage.getItem("med_guard_auth");
    if (!auth) {
        window.location.href = "guard.html";
        return null;
    }
    try {
        return JSON.parse(auth);
    } catch (e) {
        window.location.href = "guard.html";
        return null;
    }
}

function guardAbmelden() {
    sessionStorage.removeItem("med_guard_auth");
    localStorage.removeItem("med_guard_auth");
    sessionStorage.removeItem("med_portal_ok");
    window.location.href = "portal.html";
}

// Rollen-Konfiguration: Wer darf was sehen
var ALLE_SEITEN = ["index.html","patienten.html","aerzte.html","termine.html","wartezimmer.html","wissensdatenbank.html","ansagen.html","auswertung.html","agenten.html","softphone.html","voicebot.html","callflow.html","uebersetzung.html","standort.html","benutzer.html"];
var ROLLEN = {
    admin:           { label: "Admin",           icon: "fa-user-gear",   farbe: "#dc2626", seiten: ALLE_SEITEN },
    standortleitung: { label: "Standortleitung", icon: "fa-building",    farbe: "#7c3aed", seiten: ALLE_SEITEN },
    teamleitung:     { label: "Teamleitung",     icon: "fa-users-gear",  farbe: "#0891b2", seiten: ALLE_SEITEN },
    agent:           { label: "Agent",            icon: "fa-headset",     farbe: "#059669", seiten: ALLE_SEITEN }
};

function guardInfoAnzeigen() {
    var auth = sessionStorage.getItem("med_guard_auth") || localStorage.getItem("med_guard_auth");
    if (!auth) return;
    try {
        var daten = JSON.parse(auth);
        var rolle = ROLLEN[daten.rolle] || ROLLEN.agent;

        // Topbar: Name + Rolle + Abmelden
        var topbar = document.querySelector(".topbar-right");
        if (topbar) {
            topbar.innerHTML = '<span style="margin-right:0.5rem"><i class="fa-solid ' + rolle.icon + '" style="color:' + rolle.farbe + '"></i> ' +
                escapeHtmlSafe(daten.name) + ' <small style="background:' + rolle.farbe + ';color:#fff;padding:0.1rem 0.4rem;border-radius:4px;font-size:0.7rem">' + escapeHtmlSafe(rolle.label) + '</small></span>' +
                '<button type="button" id="btn-abmelden" style="padding:0.3rem 0.7rem;font-size:0.8rem;background:#64748b;border-radius:6px">' +
                '<i class="fa-solid fa-right-from-bracket"></i> Abmelden</button>';
            var btn = document.getElementById("btn-abmelden");
            if (btn) btn.addEventListener("click", guardAbmelden);
        }

        // Sidebar: Nur erlaubte Seiten anzeigen
        rollenSidebarAnpassen(daten.rolle);

        // Seitenzugriff pruefen
        rollenSeitePruefen(daten.rolle);
    } catch (e) {}
}

function rollenSidebarAnpassen(rolleKey) {
    var rolle = ROLLEN[rolleKey];
    if (!rolle) return;
    var erlaubteSeiten = rolle.seiten;

    var links = document.querySelectorAll(".sidebar a");
    for (var i = 0; i < links.length; i++) {
        var href = links[i].getAttribute("href");
        if (!href) continue;
        // Seite aus href extrahieren (z.B. "patienten.html")
        var seite = href.split("/").pop().split("?")[0];
        if (erlaubteSeiten.indexOf(seite) === -1) {
            links[i].style.display = "none";
        }
    }
}

function rollenSeitePruefen(rolleKey) {
    var rolle = ROLLEN[rolleKey];
    if (!rolle) return;
    var erlaubteSeiten = rolle.seiten;

    // Aktuelle Seite ermitteln
    var aktuelleSeite = window.location.pathname.split("/").pop() || "index.html";
    if (aktuelleSeite === "") aktuelleSeite = "index.html";

    // Ist diese Seite fuer die Rolle erlaubt?
    if (erlaubteSeiten.indexOf(aktuelleSeite) === -1) {
        // Zurueck zum Dashboard
        window.location.href = "index.html";
    }
}

function escapeHtmlSafe(text) {
    if (!text) return "";
    return String(text).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}

// ===== localStorage Helfer =====

function dbLaden(schluessel) {
    try {
        var daten = localStorage.getItem("med_" + schluessel);
        return daten ? JSON.parse(daten) : [];
    } catch (e) { return []; }
}

function dbSpeichern(schluessel, daten) {
    localStorage.setItem("med_" + schluessel, JSON.stringify(daten));
}

function dbNaechsteId(schluessel) {
    var liste = dbLaden(schluessel);
    var maxId = 0;
    liste.forEach(function (item) { if (item.id > maxId) maxId = item.id; });
    return maxId + 1;
}

function dbFinden(schluessel, id) {
    var liste = dbLaden(schluessel);
    for (var i = 0; i < liste.length; i++) {
        if (liste[i].id === id) return liste[i];
    }
    return null;
}

function dbLoeschen(schluessel, id) {
    var liste = dbLaden(schluessel);
    var neu = liste.filter(function (item) { return item.id !== id; });
    dbSpeichern(schluessel, neu);
}

function dbAktualisieren(schluessel, id, daten) {
    var liste = dbLaden(schluessel);
    for (var i = 0; i < liste.length; i++) {
        if (liste[i].id === id) {
            Object.keys(daten).forEach(function (k) { liste[i][k] = daten[k]; });
            break;
        }
    }
    dbSpeichern(schluessel, liste);
}

// ===== Demo-Daten =====

function demoDatenLaden() {
    if (localStorage.getItem("med_demo_geladen")) return;

    var patienten = [
        { id: 1, vorname: "Anna", nachname: "Mueller", geburtsdatum: "1985-03-15", versicherungsnummer: "A123456789", krankenkasse: "TK", telefon: "030-1234567", email: "anna.mueller@email.de", strasse: "Berliner Str. 12", plz: "10115", stadt: "Berlin" },
        { id: 2, vorname: "Thomas", nachname: "Schmidt", geburtsdatum: "1970-07-22", versicherungsnummer: "B987654321", krankenkasse: "AOK", telefon: "030-9876543", email: "t.schmidt@email.de", strasse: "Hauptstr. 45", plz: "10827", stadt: "Berlin" },
        { id: 3, vorname: "Maria", nachname: "Weber", geburtsdatum: "1992-11-30", versicherungsnummer: "C456789123", krankenkasse: "Barmer", telefon: "030-5551234", email: "m.weber@email.de", strasse: "Schoenhauser Allee 8", plz: "10435", stadt: "Berlin" },
        { id: 4, vorname: "Klaus", nachname: "Fischer", geburtsdatum: "1955-01-08", versicherungsnummer: "D321654987", krankenkasse: "DAK", telefon: "030-7771234", email: "k.fischer@email.de", strasse: "Kantstr. 99", plz: "10623", stadt: "Berlin" },
        { id: 5, vorname: "Sophie", nachname: "Wagner", geburtsdatum: "2000-05-20", versicherungsnummer: "E654987321", krankenkasse: "IKK", telefon: "030-3334567", email: "s.wagner@email.de", strasse: "Friedrichstr. 200", plz: "10117", stadt: "Berlin" },
    ];

    var aerzte = [
        { id: 1, titel: "Dr.", vorname: "Michael", nachname: "Schneider", fachrichtung: "Allgemeinmedizin", telefon: "030-1110001", email: "dr.schneider@praxis.de" },
        { id: 2, titel: "Dr.", vorname: "Petra", nachname: "Braun", fachrichtung: "Kardiologie", telefon: "030-1110002", email: "dr.braun@praxis.de" },
        { id: 3, titel: "Prof. Dr.", vorname: "Hans", nachname: "Klein", fachrichtung: "Orthopaedie", telefon: "030-1110003", email: "prof.klein@praxis.de" },
    ];

    var heute = new Date().toISOString().split("T")[0];
    var termine = [
        { id: 1, patient_id: 1, arzt_id: 1, datum: heute, uhrzeit: "09:00", dauer_minuten: 30, grund: "Vorsorgeuntersuchung", status: "bestaetigt", patient_name: "Mueller, Anna", arzt_name: "Dr. Michael Schneider" },
        { id: 2, patient_id: 2, arzt_id: 2, datum: heute, uhrzeit: "10:30", dauer_minuten: 20, grund: "Herz-Kontrolle", status: "geplant", patient_name: "Schmidt, Thomas", arzt_name: "Dr. Petra Braun" },
        { id: 3, patient_id: 5, arzt_id: 3, datum: heute, uhrzeit: "14:00", dauer_minuten: 45, grund: "Erstvorstellung Ruecken", status: "geplant", patient_name: "Wagner, Sophie", arzt_name: "Prof. Dr. Hans Klein" },
        { id: 4, patient_id: 3, arzt_id: 1, datum: heute, uhrzeit: "15:30", dauer_minuten: 15, grund: "Rezept abholen", status: "geplant", patient_name: "Weber, Maria", arzt_name: "Dr. Michael Schneider" },
    ];

    var jetzt = new Date();
    var vor20min = new Date(jetzt - 20 * 60000).toISOString();
    var vor5min = new Date(jetzt - 5 * 60000).toISOString();
    var wartezimmer = [
        { id: 1, patient_id: 1, patient_name: "Mueller, Anna", termin_id: 1, termin_uhrzeit: "09:00", termin_grund: "Vorsorgeuntersuchung", arzt_name: "Dr. Michael Schneider", status: "wartend", ankunft_zeit: vor20min },
        { id: 2, patient_id: 2, patient_name: "Schmidt, Thomas", termin_id: 2, termin_uhrzeit: "10:30", termin_grund: "Herz-Kontrolle", arzt_name: "Dr. Petra Braun", status: "aufgerufen", ankunft_zeit: vor5min },
    ];

    var agenten = [
        { id: 1, name: "Lisa Meier", nebenstelle: "100", sip_passwort: "demo123", rolle: "rezeption", warteschlange: "rezeption", status: "online" },
        { id: 2, name: "Peter Schulz", nebenstelle: "101", sip_passwort: "demo456", rolle: "rezeption", warteschlange: "terminvergabe", status: "pause" },
        { id: 3, name: "Dr. Schneider", nebenstelle: "200", sip_passwort: "demo789", rolle: "arzt", warteschlange: "dringend", status: "online" },
    ];

    var benutzer = [
        { id: 1, name: "Admin", email: "admin@praxis.de", alter: 35, strasse: "Praxisstr. 1", plz: "10115", stadt: "Berlin" },
        { id: 2, name: "Lisa Meier", email: "lisa@praxis.de", alter: 28, strasse: "Muellerstr. 5", plz: "10119", stadt: "Berlin" },
        { id: 3, name: "Peter Schulz", email: "peter@praxis.de", alter: 42, strasse: "Torstr. 30", plz: "10119", stadt: "Berlin" },
    ];

    var anrufe = [
        { id: 1, anrufer_nummer: "030-9998877", anrufer_name: "Frau Lehmann", agent_name: "Lisa Meier", warteschlange: "rezeption", typ: "eingehend", status: "beendet", beginn: heute + " 08:15", dauer_sekunden: 180 },
        { id: 2, anrufer_nummer: "030-5554433", anrufer_name: "", agent_name: "Peter Schulz", warteschlange: "terminvergabe", typ: "eingehend", status: "beendet", beginn: heute + " 08:45", dauer_sekunden: 120 },
    ];

    dbSpeichern("patienten", patienten);
    dbSpeichern("aerzte", aerzte);
    dbSpeichern("termine", termine);
    dbSpeichern("wartezimmer", wartezimmer);
    dbSpeichern("agenten", agenten);
    dbSpeichern("benutzer", benutzer);
    dbSpeichern("anrufe", anrufe);
    dbSpeichern("verlauf", []);

    localStorage.setItem("med_demo_geladen", "1");
}

// ===== Rechner =====

function berechnen(a, operation, b) {
    switch (operation) {
        case "addieren": return a + b;
        case "subtrahieren": return a - b;
        case "multiplizieren": return a * b;
        case "dividieren":
            if (b === 0) throw new Error("Division durch Null ist nicht erlaubt");
            return a / b;
        default: throw new Error("Unbekannte Operation: " + operation);
    }
}

async function berechnenApi(a, operation, b) {
    try {
        var response = await fetch(API_BASE + "/berechnen", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ a: a, b: b, operation: operation }),
        });
        var daten = await response.json();
        if (!response.ok) throw new Error(daten.fehler || "Serverfehler");
        return daten.ergebnis;
    } catch (e) {
        var ergebnis = berechnen(a, operation, b);
        var verlauf = dbLaden("verlauf");
        verlauf.unshift({ a: a, b: b, operation: operation, ergebnis: ergebnis, erstellt_am: new Date().toLocaleString("de-DE") });
        if (verlauf.length > 20) verlauf = verlauf.slice(0, 20);
        dbSpeichern("verlauf", verlauf);
        return ergebnis;
    }
}

function initRechner() {
    var form = document.getElementById("rechner-form");
    if (!form) return;

    form.addEventListener("submit", async function (e) {
        e.preventDefault();
        var a = parseFloat(document.getElementById("zahl-a").value);
        var b = parseFloat(document.getElementById("zahl-b").value);
        var op = document.getElementById("operation").value;
        var ergebnisDiv = document.getElementById("ergebnis");
        var fehlerDiv = document.getElementById("fehler");

        try {
            var ergebnis;
            try {
                ergebnis = await berechnenApi(a, op, b);
            } catch (_) {
                ergebnis = berechnen(a, op, b);
            }
            document.getElementById("ergebnis-wert").textContent = ergebnis;
            ergebnisDiv.hidden = false;
            fehlerDiv.hidden = true;
            verlaufAktualisieren();
        } catch (err) {
            fehlerDiv.textContent = err.message;
            fehlerDiv.hidden = false;
            ergebnisDiv.hidden = true;
        }
    });

    initVerlauf();
}

// ===== Benutzer-Validierung =====

function benutzerValidieren(daten) {
    var fehler = [];
    if (!daten.name || daten.name.trim().length === 0) fehler.push("Name ist erforderlich");
    if (!daten.email || !daten.email.includes("@")) fehler.push("Gueltige E-Mail-Adresse ist erforderlich");
    if (daten.alter === undefined || daten.alter < 0 || daten.alter > 150) fehler.push("Alter muss zwischen 0 und 150 liegen");
    if (daten.plz && !/^[0-9]{5}$/.test(daten.plz)) fehler.push("PLZ muss 5 Ziffern haben");
    return fehler;
}

// ===== Patienten-Validierung =====

function patientValidieren(daten) {
    var fehler = [];
    if (!daten.vorname || daten.vorname.trim().length === 0) fehler.push("Vorname ist erforderlich");
    if (!daten.nachname || daten.nachname.trim().length === 0) fehler.push("Nachname ist erforderlich");
    if (!daten.geburtsdatum) fehler.push("Geburtsdatum ist erforderlich");
    if (!daten.versicherungsnummer || daten.versicherungsnummer.trim().length === 0) fehler.push("Versicherungsnummer ist erforderlich");
    if (!daten.krankenkasse || daten.krankenkasse.trim().length === 0) fehler.push("Krankenkasse ist erforderlich");
    return fehler;
}

// ===== Aerzte-Validierung =====

function arztValidieren(daten) {
    var fehler = [];
    if (!daten.vorname || daten.vorname.trim().length === 0) fehler.push("Vorname ist erforderlich");
    if (!daten.nachname || daten.nachname.trim().length === 0) fehler.push("Nachname ist erforderlich");
    if (!daten.fachrichtung || daten.fachrichtung.trim().length === 0) fehler.push("Fachrichtung ist erforderlich");
    return fehler;
}

// ===== Termin-Validierung =====

function terminValidieren(daten) {
    var fehler = [];
    if (!daten.patient_id) fehler.push("Patient ist erforderlich");
    if (!daten.arzt_id) fehler.push("Arzt ist erforderlich");
    if (!daten.datum) fehler.push("Datum ist erforderlich");
    if (!daten.uhrzeit) fehler.push("Uhrzeit ist erforderlich");
    return fehler;
}

// ===== Benutzer API (localStorage) =====

async function benutzerSpeichernApi(daten) {
    var liste = dbLaden("benutzer");
    daten.id = dbNaechsteId("benutzer");
    liste.push(daten);
    dbSpeichern("benutzer", liste);
    return daten;
}

async function benutzerAktualisierenApi(id, daten) {
    dbAktualisieren("benutzer", parseInt(id), daten);
    return daten;
}

async function benutzerLoeschenApi(id) {
    dbLoeschen("benutzer", parseInt(id));
    return { erfolg: true };
}

async function benutzerLadenApi(suche) {
    var liste = dbLaden("benutzer");
    if (suche) {
        var s = suche.toLowerCase();
        liste = liste.filter(function (b) {
            return (b.name && b.name.toLowerCase().includes(s)) ||
                   (b.email && b.email.toLowerCase().includes(s)) ||
                   (b.stadt && b.stadt.toLowerCase().includes(s));
        });
    }
    return liste;
}

// ===== Verlauf =====

async function verlaufLadenApi() {
    return dbLaden("verlauf");
}

async function verlaufLoeschenApi() {
    dbSpeichern("verlauf", []);
    return { erfolg: true };
}

var OP_SYMBOLE = {
    addieren: "+", subtrahieren: "-",
    multiplizieren: "*", dividieren: "/"
};

function initVerlauf() {
    verlaufAktualisieren();
    var btn = document.getElementById("btn-verlauf-loeschen");
    if (btn) {
        btn.addEventListener("click", async function () {
            try { await verlaufLoeschenApi(); verlaufAktualisieren(); } catch (_) {}
        });
    }
}

async function verlaufAktualisieren() {
    try {
        var eintraege = await verlaufLadenApi();
        var tbody = document.querySelector("#verlauf-tabelle tbody");
        if (!tbody) return;
        tbody.innerHTML = "";
        eintraege.forEach(function (e) {
            var tr = document.createElement("tr");
            var symbol = OP_SYMBOLE[e.operation] || e.operation;
            tr.innerHTML =
                "<td>" + e.a + " " + symbol + " " + e.b + "</td>" +
                "<td>" + e.ergebnis + "</td>" +
                "<td>" + escapeHtml(e.erstellt_am || "") + "</td>";
            tbody.appendChild(tr);
        });
    } catch (_) {}
}

// ===== Benutzer-Formular =====

function initBenutzerFormular() {
    var form = document.getElementById("benutzer-form");
    if (!form) return;

    var btnAbbrechen = document.getElementById("btn-abbrechen");
    benutzerListeAktualisieren();

    var suchfeld = document.getElementById("benutzer-suche");
    if (suchfeld) {
        var suchTimer;
        suchfeld.addEventListener("input", function () {
            clearTimeout(suchTimer);
            suchTimer = setTimeout(function () { benutzerListeAktualisieren(suchfeld.value); }, 300);
        });
    }

    if (btnAbbrechen) {
        btnAbbrechen.addEventListener("click", function () { formularZuruecksetzen(); });
    }

    form.addEventListener("submit", async function (e) {
        e.preventDefault();
        var bearbeitenId = document.getElementById("benutzer-id").value;
        var daten = {
            name: document.getElementById("name").value,
            email: document.getElementById("email").value,
            alter: parseInt(document.getElementById("alter").value, 10) || 0,
            strasse: document.getElementById("strasse").value,
            plz: document.getElementById("plz").value,
            stadt: document.getElementById("stadt").value,
        };

        var fehler = benutzerValidieren(daten);
        var erfolgDiv = document.getElementById("benutzer-erfolg");
        var fehlerDiv = document.getElementById("benutzer-fehler");

        if (fehler.length > 0) {
            fehlerDiv.textContent = fehler.join(", ");
            fehlerDiv.hidden = false;
            erfolgDiv.hidden = true;
            return;
        }

        try {
            if (bearbeitenId) {
                await benutzerAktualisierenApi(bearbeitenId, daten);
                erfolgDiv.textContent = "Benutzer aktualisiert!";
            } else {
                await benutzerSpeichernApi(daten);
                erfolgDiv.textContent = "Benutzer erfolgreich gespeichert!";
            }
            erfolgDiv.hidden = false;
            fehlerDiv.hidden = true;
            formularZuruecksetzen();
            benutzerListeAktualisieren();
        } catch (err) {
            fehlerDiv.textContent = err.message;
            fehlerDiv.hidden = false;
            erfolgDiv.hidden = true;
        }
    });
}

function formularZuruecksetzen() {
    var form = document.getElementById("benutzer-form");
    if (form) form.reset();
    document.getElementById("benutzer-id").value = "";
    document.getElementById("formular-titel").textContent = "Benutzer anlegen";
    document.getElementById("btn-speichern").textContent = "Speichern";
    var btnAbbrechen = document.getElementById("btn-abbrechen");
    if (btnAbbrechen) btnAbbrechen.hidden = true;
}

function benutzerBearbeiten(benutzer) {
    document.getElementById("benutzer-id").value = benutzer.id;
    document.getElementById("name").value = benutzer.name;
    document.getElementById("email").value = benutzer.email;
    document.getElementById("alter").value = benutzer.alter;
    document.getElementById("strasse").value = benutzer.strasse || "";
    document.getElementById("plz").value = benutzer.plz || "";
    document.getElementById("stadt").value = benutzer.stadt || "";
    document.getElementById("formular-titel").textContent = "Benutzer bearbeiten";
    document.getElementById("btn-speichern").textContent = "Aktualisieren";
    var btnAbbrechen = document.getElementById("btn-abbrechen");
    if (btnAbbrechen) btnAbbrechen.hidden = false;
    document.getElementById("benutzer-formular").scrollIntoView({ behavior: "smooth" });
}

async function benutzerEntfernen(id) {
    if (!confirm("Benutzer wirklich loeschen?")) return;
    try { await benutzerLoeschenApi(id); benutzerListeAktualisieren(); } catch (err) { alert("Fehler: " + err.message); }
}

async function benutzerListeAktualisieren(suche) {
    try {
        var benutzer = await benutzerLadenApi(suche);
        var tbody = document.querySelector("#benutzer-tabelle tbody");
        if (!tbody) return;
        tbody.innerHTML = "";
        benutzer.forEach(function (b) { benutzerZurTabelle(b); });
    } catch (_) {}
}

function benutzerZurTabelle(daten) {
    var tbody = document.querySelector("#benutzer-tabelle tbody");
    if (!tbody) return;
    var tr = document.createElement("tr");
    tr.setAttribute("data-id", daten.id);
    tr.innerHTML =
        "<td>" + (daten.id || "") + "</td>" +
        "<td>" + escapeHtml(daten.name) + "</td>" +
        "<td>" + escapeHtml(daten.email) + "</td>" +
        "<td>" + daten.alter + "</td>" +
        "<td>" + escapeHtml(daten.stadt || "-") + "</td>" +
        '<td class="aktionen">' +
            '<button class="btn-bearbeiten" title="Bearbeiten">Bearbeiten</button> ' +
            '<button class="btn-loeschen" title="Loeschen">Loeschen</button>' +
        "</td>";
    tr.querySelector(".btn-bearbeiten").addEventListener("click", function () { benutzerBearbeiten(daten); });
    tr.querySelector(".btn-loeschen").addEventListener("click", function () { benutzerEntfernen(daten.id); });
    tbody.appendChild(tr);
}

// ===== Patienten API (localStorage) =====

async function patientenLadenApi(suche) {
    var liste = dbLaden("patienten");
    if (suche) {
        var s = suche.toLowerCase();
        liste = liste.filter(function (p) {
            return (p.vorname + " " + p.nachname).toLowerCase().includes(s) ||
                   (p.versicherungsnummer && p.versicherungsnummer.toLowerCase().includes(s)) ||
                   (p.stadt && p.stadt.toLowerCase().includes(s));
        });
    }
    return liste;
}

async function patientSpeichernApi(daten) {
    var liste = dbLaden("patienten");
    daten.id = dbNaechsteId("patienten");
    liste.push(daten);
    dbSpeichern("patienten", liste);
    return daten;
}

async function patientAktualisierenApi(id, daten) {
    dbAktualisieren("patienten", parseInt(id), daten);
    return daten;
}

async function patientLoeschenApi(id) {
    dbLoeschen("patienten", parseInt(id));
    return { erfolg: true };
}

function initPatienten() {
    var form = document.getElementById("patient-form");
    if (!form) return;

    patientenListeAktualisieren();

    var suchfeld = document.getElementById("patient-suche");
    if (suchfeld) {
        var timer;
        suchfeld.addEventListener("input", function () {
            clearTimeout(timer);
            timer = setTimeout(function () { patientenListeAktualisieren(suchfeld.value); }, 300);
        });
    }

    var btnAbbrechen = document.getElementById("btn-patient-abbrechen");
    if (btnAbbrechen) {
        btnAbbrechen.addEventListener("click", function () { patientFormZuruecksetzen(); });
    }

    form.addEventListener("submit", async function (e) {
        e.preventDefault();
        var editId = document.getElementById("patient-id").value;
        var daten = {
            vorname: document.getElementById("patient-vorname").value,
            nachname: document.getElementById("patient-nachname").value,
            geburtsdatum: document.getElementById("patient-geburtsdatum").value,
            versicherungsnummer: document.getElementById("patient-versicherungsnummer").value,
            krankenkasse: document.getElementById("patient-krankenkasse").value,
            telefon: document.getElementById("patient-telefon").value,
            email: document.getElementById("patient-email").value,
            strasse: document.getElementById("patient-strasse").value,
            plz: document.getElementById("patient-plz").value,
            stadt: document.getElementById("patient-stadt").value,
        };

        var erfolgDiv = document.getElementById("patient-erfolg");
        var fehlerDiv = document.getElementById("patient-fehler");
        var fehler = patientValidieren(daten);
        if (fehler.length > 0) {
            fehlerDiv.textContent = fehler.join(", ");
            fehlerDiv.hidden = false;
            erfolgDiv.hidden = true;
            return;
        }

        try {
            if (editId) {
                await patientAktualisierenApi(editId, daten);
                erfolgDiv.textContent = "Patient aktualisiert!";
            } else {
                await patientSpeichernApi(daten);
                erfolgDiv.textContent = "Patient gespeichert!";
            }
            erfolgDiv.hidden = false;
            fehlerDiv.hidden = true;
            patientFormZuruecksetzen();
            patientenListeAktualisieren();
        } catch (err) {
            fehlerDiv.textContent = err.message;
            fehlerDiv.hidden = false;
            erfolgDiv.hidden = true;
        }
    });
}

function patientFormZuruecksetzen() {
    var form = document.getElementById("patient-form");
    if (form) form.reset();
    document.getElementById("patient-id").value = "";
    document.getElementById("patient-formular-titel").textContent = "Patient anlegen";
    document.getElementById("btn-patient-speichern").textContent = "Speichern";
    var btn = document.getElementById("btn-patient-abbrechen");
    if (btn) btn.hidden = true;
}

function patientBearbeiten(p) {
    document.getElementById("patient-id").value = p.id;
    document.getElementById("patient-vorname").value = p.vorname;
    document.getElementById("patient-nachname").value = p.nachname;
    document.getElementById("patient-geburtsdatum").value = p.geburtsdatum;
    document.getElementById("patient-versicherungsnummer").value = p.versicherungsnummer;
    document.getElementById("patient-krankenkasse").value = p.krankenkasse;
    document.getElementById("patient-telefon").value = p.telefon || "";
    document.getElementById("patient-email").value = p.email || "";
    document.getElementById("patient-strasse").value = p.strasse || "";
    document.getElementById("patient-plz").value = p.plz || "";
    document.getElementById("patient-stadt").value = p.stadt || "";
    document.getElementById("patient-formular-titel").textContent = "Patient bearbeiten";
    document.getElementById("btn-patient-speichern").textContent = "Aktualisieren";
    var btn = document.getElementById("btn-patient-abbrechen");
    if (btn) btn.hidden = false;
    document.getElementById("patient-formular").scrollIntoView({ behavior: "smooth" });
}

async function patientenListeAktualisieren(suche) {
    try {
        var patienten = await patientenLadenApi(suche);
        var tbody = document.querySelector("#patienten-tabelle tbody");
        if (!tbody) return;
        tbody.innerHTML = "";
        patienten.forEach(function (p) {
            var tr = document.createElement("tr");
            tr.innerHTML =
                "<td>" + escapeHtml(p.nachname + ", " + p.vorname) + "</td>" +
                "<td>" + escapeHtml(p.geburtsdatum) + "</td>" +
                "<td>" + escapeHtml(p.versicherungsnummer) + "</td>" +
                "<td>" + escapeHtml(p.krankenkasse) + "</td>" +
                "<td>" + escapeHtml(p.telefon || "-") + "</td>" +
                '<td class="aktionen">' +
                    '<button class="btn-bearbeiten">Bearbeiten</button> ' +
                    '<button class="btn-loeschen">Loeschen</button>' +
                "</td>";
            tr.querySelector(".btn-bearbeiten").addEventListener("click", function () { patientBearbeiten(p); });
            tr.querySelector(".btn-loeschen").addEventListener("click", async function () {
                if (!confirm("Patient wirklich loeschen?")) return;
                try { await patientLoeschenApi(p.id); patientenListeAktualisieren(); } catch (err) { alert(err.message); }
            });
            tbody.appendChild(tr);
        });
    } catch (_) {}
}

// ===== Aerzte API (localStorage) =====

async function aerzteLadenApi() {
    return dbLaden("aerzte");
}

async function arztSpeichernApi(daten) {
    var liste = dbLaden("aerzte");
    daten.id = dbNaechsteId("aerzte");
    liste.push(daten);
    dbSpeichern("aerzte", liste);
    return daten;
}

async function arztAktualisierenApi(id, daten) {
    dbAktualisieren("aerzte", parseInt(id), daten);
    return daten;
}

async function arztLoeschenApi(id) {
    dbLoeschen("aerzte", parseInt(id));
    return { erfolg: true };
}

function initAerzte() {
    var form = document.getElementById("arzt-form");
    if (!form) return;

    aerzteListeAktualisieren();

    var btnAbbrechen = document.getElementById("btn-arzt-abbrechen");
    if (btnAbbrechen) {
        btnAbbrechen.addEventListener("click", function () { arztFormZuruecksetzen(); });
    }

    form.addEventListener("submit", async function (e) {
        e.preventDefault();
        var editId = document.getElementById("arzt-id").value;
        var daten = {
            titel: document.getElementById("arzt-titel").value,
            vorname: document.getElementById("arzt-vorname").value,
            nachname: document.getElementById("arzt-nachname").value,
            fachrichtung: document.getElementById("arzt-fachrichtung").value,
            telefon: document.getElementById("arzt-telefon").value,
            email: document.getElementById("arzt-email").value,
        };

        var erfolgDiv = document.getElementById("arzt-erfolg");
        var fehlerDiv = document.getElementById("arzt-fehler");
        var fehler = arztValidieren(daten);
        if (fehler.length > 0) {
            fehlerDiv.textContent = fehler.join(", ");
            fehlerDiv.hidden = false;
            erfolgDiv.hidden = true;
            return;
        }

        try {
            if (editId) {
                await arztAktualisierenApi(editId, daten);
                erfolgDiv.textContent = "Arzt aktualisiert!";
            } else {
                await arztSpeichernApi(daten);
                erfolgDiv.textContent = "Arzt gespeichert!";
            }
            erfolgDiv.hidden = false;
            fehlerDiv.hidden = true;
            arztFormZuruecksetzen();
            aerzteListeAktualisieren();
        } catch (err) {
            fehlerDiv.textContent = err.message;
            fehlerDiv.hidden = false;
            erfolgDiv.hidden = true;
        }
    });
}

function arztFormZuruecksetzen() {
    var form = document.getElementById("arzt-form");
    if (form) form.reset();
    document.getElementById("arzt-id").value = "";
    document.getElementById("arzt-formular-titel").textContent = "Arzt anlegen";
    document.getElementById("btn-arzt-speichern").textContent = "Speichern";
    var btn = document.getElementById("btn-arzt-abbrechen");
    if (btn) btn.hidden = true;
}

function arztBearbeiten(a) {
    document.getElementById("arzt-id").value = a.id;
    document.getElementById("arzt-titel").value = a.titel || "";
    document.getElementById("arzt-vorname").value = a.vorname;
    document.getElementById("arzt-nachname").value = a.nachname;
    document.getElementById("arzt-fachrichtung").value = a.fachrichtung;
    document.getElementById("arzt-telefon").value = a.telefon || "";
    document.getElementById("arzt-email").value = a.email || "";
    document.getElementById("arzt-formular-titel").textContent = "Arzt bearbeiten";
    document.getElementById("btn-arzt-speichern").textContent = "Aktualisieren";
    var btn = document.getElementById("btn-arzt-abbrechen");
    if (btn) btn.hidden = false;
    document.getElementById("arzt-formular").scrollIntoView({ behavior: "smooth" });
}

async function aerzteListeAktualisieren() {
    try {
        var aerzte = await aerzteLadenApi();
        var tbody = document.querySelector("#aerzte-tabelle tbody");
        if (!tbody) return;
        tbody.innerHTML = "";
        aerzte.forEach(function (a) {
            var vollname = ((a.titel || "") + " " + a.vorname + " " + a.nachname).trim();
            var tr = document.createElement("tr");
            tr.innerHTML =
                "<td>" + escapeHtml(vollname) + "</td>" +
                "<td>" + escapeHtml(a.fachrichtung) + "</td>" +
                "<td>" + escapeHtml(a.telefon || "-") + "</td>" +
                "<td>" + escapeHtml(a.email || "-") + "</td>" +
                '<td class="aktionen">' +
                    '<button class="btn-bearbeiten">Bearbeiten</button> ' +
                    '<button class="btn-loeschen">Loeschen</button>' +
                "</td>";
            tr.querySelector(".btn-bearbeiten").addEventListener("click", function () { arztBearbeiten(a); });
            tr.querySelector(".btn-loeschen").addEventListener("click", async function () {
                if (!confirm("Arzt wirklich loeschen?")) return;
                try { await arztLoeschenApi(a.id); aerzteListeAktualisieren(); } catch (err) { alert(err.message); }
            });
            tbody.appendChild(tr);
        });
    } catch (_) {}
}

// ===== Termine API (localStorage) =====

async function termineLadenApi(datum) {
    var liste = dbLaden("termine");
    if (datum) {
        liste = liste.filter(function (t) { return t.datum === datum; });
    }
    return liste;
}

async function terminSpeichernApi(daten) {
    var liste = dbLaden("termine");
    daten.id = dbNaechsteId("termine");
    var patient = dbFinden("patienten", daten.patient_id);
    var arzt = dbFinden("aerzte", daten.arzt_id);
    daten.patient_name = patient ? patient.nachname + ", " + patient.vorname : "Unbekannt";
    daten.arzt_name = arzt ? ((arzt.titel || "") + " " + arzt.vorname + " " + arzt.nachname).trim() : "Unbekannt";
    daten.status = daten.status || "geplant";
    liste.push(daten);
    dbSpeichern("termine", liste);
    return daten;
}

async function terminAktualisierenApi(id, daten) {
    var patient = dbFinden("patienten", daten.patient_id);
    var arzt = dbFinden("aerzte", daten.arzt_id);
    daten.patient_name = patient ? patient.nachname + ", " + patient.vorname : "Unbekannt";
    daten.arzt_name = arzt ? ((arzt.titel || "") + " " + arzt.vorname + " " + arzt.nachname).trim() : "Unbekannt";
    dbAktualisieren("termine", parseInt(id), daten);
    return daten;
}

async function terminLoeschenApi(id) {
    dbLoeschen("termine", parseInt(id));
    return { erfolg: true };
}

function initTermine() {
    var form = document.getElementById("termin-form");
    if (!form) return;

    terminDropdownsLaden();
    termineListeAktualisieren();

    var datumFilter = document.getElementById("termin-filter-datum");
    if (datumFilter) {
        datumFilter.addEventListener("change", function () { termineListeAktualisieren(datumFilter.value); });
    }

    var btnAbbrechen = document.getElementById("btn-termin-abbrechen");
    if (btnAbbrechen) {
        btnAbbrechen.addEventListener("click", function () { terminFormZuruecksetzen(); });
    }

    form.addEventListener("submit", async function (e) {
        e.preventDefault();
        var editId = document.getElementById("termin-id").value;
        var daten = {
            patient_id: parseInt(document.getElementById("termin-patient").value, 10),
            arzt_id: parseInt(document.getElementById("termin-arzt").value, 10),
            datum: document.getElementById("termin-datum").value,
            uhrzeit: document.getElementById("termin-uhrzeit").value,
            dauer_minuten: parseInt(document.getElementById("termin-dauer").value, 10) || 15,
            grund: document.getElementById("termin-grund").value,
        };

        var erfolgDiv = document.getElementById("termin-erfolg");
        var fehlerDiv = document.getElementById("termin-fehler");
        var fehler = terminValidieren(daten);
        if (fehler.length > 0) {
            fehlerDiv.textContent = fehler.join(", ");
            fehlerDiv.hidden = false;
            erfolgDiv.hidden = true;
            return;
        }

        try {
            if (editId) {
                await terminAktualisierenApi(editId, daten);
                erfolgDiv.textContent = "Termin aktualisiert!";
            } else {
                await terminSpeichernApi(daten);
                erfolgDiv.textContent = "Termin gespeichert!";
            }
            erfolgDiv.hidden = false;
            fehlerDiv.hidden = true;
            terminFormZuruecksetzen();
            termineListeAktualisieren();
        } catch (err) {
            fehlerDiv.textContent = err.message;
            fehlerDiv.hidden = false;
            erfolgDiv.hidden = true;
        }
    });
}

async function terminDropdownsLaden() {
    try {
        var patienten = await patientenLadenApi();
        var sel = document.getElementById("termin-patient");
        if (sel) {
            patienten.forEach(function (p) {
                var opt = document.createElement("option");
                opt.value = p.id;
                opt.textContent = p.nachname + ", " + p.vorname + " (" + p.versicherungsnummer + ")";
                sel.appendChild(opt);
            });
        }
    } catch (_) {}
    try {
        var aerzte = await aerzteLadenApi();
        var sel2 = document.getElementById("termin-arzt");
        if (sel2) {
            aerzte.forEach(function (a) {
                var opt = document.createElement("option");
                opt.value = a.id;
                opt.textContent = ((a.titel || "") + " " + a.vorname + " " + a.nachname).trim() + " - " + a.fachrichtung;
                sel2.appendChild(opt);
            });
        }
    } catch (_) {}
}

function terminFormZuruecksetzen() {
    var form = document.getElementById("termin-form");
    if (form) form.reset();
    document.getElementById("termin-id").value = "";
    document.getElementById("termin-formular-titel").textContent = "Termin anlegen";
    document.getElementById("btn-termin-speichern").textContent = "Speichern";
    var btn = document.getElementById("btn-termin-abbrechen");
    if (btn) btn.hidden = true;
}

function terminBearbeiten(t) {
    document.getElementById("termin-id").value = t.id;
    document.getElementById("termin-patient").value = t.patient_id;
    document.getElementById("termin-arzt").value = t.arzt_id;
    document.getElementById("termin-datum").value = t.datum;
    document.getElementById("termin-uhrzeit").value = t.uhrzeit;
    document.getElementById("termin-dauer").value = t.dauer_minuten;
    document.getElementById("termin-grund").value = t.grund || "";
    document.getElementById("termin-formular-titel").textContent = "Termin bearbeiten";
    document.getElementById("btn-termin-speichern").textContent = "Aktualisieren";
    var btn = document.getElementById("btn-termin-abbrechen");
    if (btn) btn.hidden = false;
    document.getElementById("termin-formular").scrollIntoView({ behavior: "smooth" });
}

var STATUS_KLASSEN = {
    geplant: "status-geplant",
    bestaetigt: "status-bestaetigt",
    abgesagt: "status-abgesagt",
    abgeschlossen: "status-abgeschlossen",
};

async function termineListeAktualisieren(datum) {
    try {
        var termine = await termineLadenApi(datum);
        var tbody = document.querySelector("#termine-tabelle tbody");
        if (!tbody) return;
        tbody.innerHTML = "";
        termine.forEach(function (t) {
            var statusKlasse = STATUS_KLASSEN[t.status] || "status-geplant";
            var tr = document.createElement("tr");
            tr.innerHTML =
                "<td>" + escapeHtml(t.datum) + "</td>" +
                "<td>" + escapeHtml(t.uhrzeit) + "</td>" +
                "<td>" + escapeHtml(t.patient_name) + "</td>" +
                "<td>" + escapeHtml(t.arzt_name) + "</td>" +
                "<td>" + escapeHtml(t.grund || "-") + "</td>" +
                '<td><span class="status-badge ' + statusKlasse + '">' + escapeHtml(t.status) + "</span></td>" +
                '<td class="aktionen">' +
                    '<button class="btn-bearbeiten">Bearbeiten</button> ' +
                    '<button class="btn-loeschen">Loeschen</button>' +
                "</td>";
            tr.querySelector(".btn-bearbeiten").addEventListener("click", function () { terminBearbeiten(t); });
            tr.querySelector(".btn-loeschen").addEventListener("click", async function () {
                if (!confirm("Termin wirklich loeschen?")) return;
                try { await terminLoeschenApi(t.id); termineListeAktualisieren(datum); } catch (err) { alert(err.message); }
            });
            tbody.appendChild(tr);
        });
    } catch (_) {}
}

// ===== Wartezimmer API (localStorage) =====

async function wartezimmerLadenApi() {
    return dbLaden("wartezimmer").filter(function (e) { return e.status !== "fertig"; });
}

async function wartezimmerCheckinApi(daten) {
    var liste = dbLaden("wartezimmer");
    daten.id = dbNaechsteId("wartezimmer");
    daten.status = "wartend";
    daten.ankunft_zeit = new Date().toISOString();
    var patient = dbFinden("patienten", daten.patient_id);
    daten.patient_name = patient ? patient.nachname + ", " + patient.vorname : "Unbekannt";
    if (daten.termin_id) {
        var termin = dbFinden("termine", daten.termin_id);
        if (termin) {
            daten.termin_uhrzeit = termin.uhrzeit;
            daten.termin_grund = termin.grund;
            daten.arzt_name = termin.arzt_name;
        }
    }
    liste.push(daten);
    dbSpeichern("wartezimmer", liste);
    return daten;
}

async function wartezimmerStatusApi(id, status) {
    dbAktualisieren("wartezimmer", parseInt(id), { status: status });
    return { erfolg: true };
}

async function wartezimmerEntfernenApi(id) {
    dbLoeschen("wartezimmer", parseInt(id));
    return { erfolg: true };
}

function initWartezimmer() {
    var form = document.getElementById("checkin-form");
    if (!form) return;

    wartezimmerDropdownsLaden();
    wartezimmerAktualisieren();
    setInterval(wartezimmerAktualisieren, 15000);

    var patientSelect = document.getElementById("checkin-patient");
    if (patientSelect) {
        patientSelect.addEventListener("change", function () { wartezimmerTermineLaden(patientSelect.value); });
    }

    form.addEventListener("submit", async function (e) {
        e.preventDefault();
        var daten = { patient_id: parseInt(document.getElementById("checkin-patient").value, 10) };
        var terminId = document.getElementById("checkin-termin").value;
        if (terminId) daten.termin_id = parseInt(terminId, 10);

        var erfolgDiv = document.getElementById("checkin-erfolg");
        var fehlerDiv = document.getElementById("checkin-fehler");

        try {
            await wartezimmerCheckinApi(daten);
            erfolgDiv.textContent = "Patient eingecheckt!";
            erfolgDiv.hidden = false;
            fehlerDiv.hidden = true;
            form.reset();
            wartezimmerAktualisieren();
        } catch (err) {
            fehlerDiv.textContent = err.message;
            fehlerDiv.hidden = false;
            erfolgDiv.hidden = true;
        }
    });
}

async function wartezimmerDropdownsLaden() {
    try {
        var patienten = await patientenLadenApi();
        var sel = document.getElementById("checkin-patient");
        if (sel) {
            patienten.forEach(function (p) {
                var opt = document.createElement("option");
                opt.value = p.id;
                opt.textContent = p.nachname + ", " + p.vorname;
                sel.appendChild(opt);
            });
        }
    } catch (_) {}
}

async function wartezimmerTermineLaden(patientId) {
    var sel = document.getElementById("checkin-termin");
    if (!sel) return;
    sel.innerHTML = '<option value="">-- Ohne Termin --</option>';
    if (!patientId) return;
    try {
        var heute = new Date().toISOString().split("T")[0];
        var termine = await termineLadenApi(heute);
        termine.forEach(function (t) {
            if (t.patient_id === parseInt(patientId, 10) && t.status !== "abgesagt") {
                var opt = document.createElement("option");
                opt.value = t.id;
                opt.textContent = t.uhrzeit + " - " + (t.grund || "Termin") + " bei " + t.arzt_name;
                sel.appendChild(opt);
            }
        });
    } catch (_) {}
}

function wartezeitBerechnen(ankunftZeit) {
    if (!ankunftZeit) return "";
    var ankunft = new Date(ankunftZeit);
    var jetzt = new Date();
    var diff = Math.floor((jetzt - ankunft) / 60000);
    if (diff < 1) return "gerade eben";
    if (diff < 60) return diff + " Min.";
    return Math.floor(diff / 60) + " Std. " + (diff % 60) + " Min.";
}

async function wartezimmerAktualisieren() {
    try {
        var eintraege = await wartezimmerLadenApi();
        var container = document.getElementById("wartezimmer-liste");
        var badge = document.getElementById("wartezimmer-anzahl");
        if (!container) return;

        var wartend = eintraege.filter(function (e) { return e.status === "wartend"; }).length;
        if (badge) badge.textContent = wartend + " wartend";

        container.innerHTML = "";
        if (eintraege.length === 0) {
            container.innerHTML = '<p style="color:#666;text-align:center;padding:2rem">Keine Patienten im Wartezimmer.</p>';
            return;
        }

        eintraege.forEach(function (e) {
            var karte = document.createElement("div");
            karte.className = "warte-karte " + e.status;
            var info = '<div class="warte-info"><h3>' + escapeHtml(e.patient_name) + '</h3><p>';
            if (e.termin_uhrzeit) info += "Termin: " + escapeHtml(e.termin_uhrzeit);
            if (e.termin_grund) info += " - " + escapeHtml(e.termin_grund);
            if (e.arzt_name) info += " bei " + escapeHtml(e.arzt_name);
            info += '</p><p class="wartezeit">Wartezeit: ' + wartezeitBerechnen(e.ankunft_zeit) + "</p></div>";

            var aktionen = '<div class="warte-aktionen">';
            if (e.status === "wartend") aktionen += '<button class="btn-aufrufen">Aufrufen</button>';
            if (e.status === "aufgerufen") aktionen += '<button class="btn-fertig">Fertig</button>';
            aktionen += '<button class="btn-loeschen">Entfernen</button></div>';

            karte.innerHTML = info + aktionen;

            var btnAufrufen = karte.querySelector(".btn-aufrufen");
            if (btnAufrufen) btnAufrufen.addEventListener("click", async function () {
                try { await wartezimmerStatusApi(e.id, "aufgerufen"); wartezimmerAktualisieren(); } catch (_) {}
            });
            var btnFertig = karte.querySelector(".btn-fertig");
            if (btnFertig) btnFertig.addEventListener("click", async function () {
                try { await wartezimmerStatusApi(e.id, "fertig"); wartezimmerAktualisieren(); } catch (_) {}
            });
            karte.querySelector(".btn-loeschen").addEventListener("click", async function () {
                try { await wartezimmerEntfernenApi(e.id); wartezimmerAktualisieren(); } catch (_) {}
            });

            container.appendChild(karte);
        });
    } catch (_) {}
}

// ===== Agenten API (localStorage) =====

async function agentenLadenApi() {
    return dbLaden("agenten");
}

async function agentSpeichernApi(daten) {
    var liste = dbLaden("agenten");
    daten.id = dbNaechsteId("agenten");
    daten.status = daten.status || "offline";
    liste.push(daten);
    dbSpeichern("agenten", liste);
    return daten;
}

async function agentAktualisierenApi(id, daten) {
    dbAktualisieren("agenten", parseInt(id), daten);
    return daten;
}

async function agentLoeschenApi(id) {
    dbLoeschen("agenten", parseInt(id));
    return { erfolg: true };
}

async function agentStatusSetzenApi(id, status) {
    dbAktualisieren("agenten", parseInt(id), { status: status });
    return { erfolg: true };
}

async function anrufeLadenApi(aktiv) {
    var liste = dbLaden("anrufe");
    if (aktiv) {
        liste = liste.filter(function (a) { return a.status === "klingelt" || a.status === "verbunden"; });
    }
    return liste;
}

function initAgentenBoard() {
    var form = document.getElementById("agent-form");
    if (!form) return;

    agentenBoardAktualisieren();
    aktiveAnrufeAktualisieren();
    anrufprotokollAktualisieren();

    setInterval(function () {
        agentenBoardAktualisieren();
        aktiveAnrufeAktualisieren();
        anrufprotokollAktualisieren();
    }, 10000);

    var btnAbbrechen = document.getElementById("btn-agent-abbrechen");
    if (btnAbbrechen) {
        btnAbbrechen.addEventListener("click", function () { agentFormZuruecksetzen(); });
    }

    form.addEventListener("submit", async function (e) {
        e.preventDefault();
        var editId = document.getElementById("agent-id").value;
        var daten = {
            name: document.getElementById("agent-name").value,
            nebenstelle: document.getElementById("agent-nebenstelle").value,
            sip_passwort: document.getElementById("agent-sip-passwort").value,
            rolle: document.getElementById("agent-rolle").value,
            warteschlange: document.getElementById("agent-warteschlange").value,
        };

        var erfolgDiv = document.getElementById("agent-erfolg");
        var fehlerDiv = document.getElementById("agent-fehler");

        try {
            if (editId) {
                await agentAktualisierenApi(editId, daten);
                erfolgDiv.textContent = "Agent aktualisiert!";
            } else {
                await agentSpeichernApi(daten);
                erfolgDiv.textContent = "Agent gespeichert!";
            }
            erfolgDiv.hidden = false;
            fehlerDiv.hidden = true;
            agentFormZuruecksetzen();
            agentenBoardAktualisieren();
        } catch (err) {
            fehlerDiv.textContent = err.message;
            fehlerDiv.hidden = false;
            erfolgDiv.hidden = true;
        }
    });
}

function agentFormZuruecksetzen() {
    var form = document.getElementById("agent-form");
    if (form) form.reset();
    document.getElementById("agent-id").value = "";
    document.getElementById("agent-formular-titel").textContent = "Agent anlegen";
    document.getElementById("btn-agent-speichern").textContent = "Speichern";
    var btn = document.getElementById("btn-agent-abbrechen");
    if (btn) btn.hidden = true;
}

function agentBearbeiten(a) {
    document.getElementById("agent-id").value = a.id;
    document.getElementById("agent-name").value = a.name;
    document.getElementById("agent-nebenstelle").value = a.nebenstelle;
    document.getElementById("agent-sip-passwort").value = a.sip_passwort;
    document.getElementById("agent-rolle").value = a.rolle;
    document.getElementById("agent-warteschlange").value = a.warteschlange || "rezeption";
    document.getElementById("agent-formular-titel").textContent = "Agent bearbeiten";
    document.getElementById("btn-agent-speichern").textContent = "Aktualisieren";
    var btn = document.getElementById("btn-agent-abbrechen");
    if (btn) btn.hidden = false;
    document.getElementById("agent-formular").scrollIntoView({ behavior: "smooth" });
}

async function agentenBoardAktualisieren() {
    try {
        var agenten = await agentenLadenApi();
        var container = document.getElementById("agenten-karten");
        var badge = document.getElementById("agenten-online-badge");
        if (!container) return;

        var onlineCount = agenten.filter(function (a) { return a.status === "online" || a.status === "im_gespraech"; }).length;
        if (badge) badge.textContent = onlineCount + " online";

        container.innerHTML = "";
        if (agenten.length === 0) {
            container.innerHTML = '<p style="color:#666;text-align:center;padding:2rem">Keine Agenten angelegt.</p>';
            return;
        }

        var STATUS_LABELS = { online: "Verfuegbar", im_gespraech: "Im Gespraech", pause: "Pause", azu: "AZU", meeting: "Meeting", at_chris: "@Chris", offline: "Offline" };
        var STATUS_ICONS = { online: "fa-circle", im_gespraech: "fa-phone", pause: "fa-pause", azu: "fa-graduation-cap", meeting: "fa-users", at_chris: "fa-at", offline: "fa-circle-xmark" };

        agenten.forEach(function (a) {
            var statusLabel = STATUS_LABELS[a.status] || a.status;
            var karte = document.createElement("div");
            karte.className = "agent-karte";
            karte.innerHTML =
                '<h3><span class="agent-status-punkt ' + escapeHtml(a.status) + '"></span>' + escapeHtml(a.name) + '</h3>' +
                '<p>Nebenstelle: ' + escapeHtml(a.nebenstelle) + '</p>' +
                '<p>Rolle: ' + escapeHtml(a.rolle) + ' | Queue: ' + escapeHtml(a.warteschlange || '-') + '</p>' +
                '<p>Status: <strong><i class="fa-solid ' + (STATUS_ICONS[a.status] || 'fa-circle') + '"></i> ' + escapeHtml(statusLabel) + '</strong></p>' +
                '<div class="agent-aktionen">' +
                    '<button class="btn-online" title="Verfuegbar"><i class="fa-solid fa-circle"></i> Frei</button>' +
                    '<button class="btn-im_gespraech" title="Im Gespraech"><i class="fa-solid fa-phone"></i> Gespraech</button>' +
                    '<button class="btn-pause" title="Pause"><i class="fa-solid fa-pause"></i> Pause</button>' +
                    '<button class="btn-azu" title="AZU"><i class="fa-solid fa-graduation-cap"></i> AZU</button>' +
                    '<button class="btn-meeting" title="Meeting"><i class="fa-solid fa-users"></i> Meeting</button>' +
                    '<button class="btn-at_chris" title="@Chris"><i class="fa-solid fa-at"></i> @Chris</button>' +
                    '<button class="btn-offline" title="Offline"><i class="fa-solid fa-circle-xmark"></i> Offline</button>' +
                '</div>' +
                '<div style="display:flex;gap:0.25rem;margin-top:0.25rem">' +
                    '<button class="btn-bearbeiten" style="font-size:0.75rem;padding:0.2rem 0.5rem"><i class="fa-solid fa-pen"></i> Bearbeiten</button>' +
                    '<button class="btn-loeschen" style="font-size:0.75rem;padding:0.2rem 0.5rem;background:var(--danger)"><i class="fa-solid fa-trash"></i> Loeschen</button>' +
                '</div>';

            ["online", "im_gespraech", "pause", "azu", "meeting", "at_chris", "offline"].forEach(function (s) {
                var btn = karte.querySelector(".btn-" + s);
                if (btn) btn.addEventListener("click", async function () {
                    try { await agentStatusSetzenApi(a.id, s); agentenBoardAktualisieren(); } catch (_) {}
                });
            });
            karte.querySelector(".btn-bearbeiten").addEventListener("click", function () { agentBearbeiten(a); });
            karte.querySelector(".btn-loeschen").addEventListener("click", async function () {
                if (!confirm("Agent wirklich loeschen?")) return;
                try { await agentLoeschenApi(a.id); agentenBoardAktualisieren(); } catch (err) { alert(err.message); }
            });

            container.appendChild(karte);
        });
    } catch (_) {}
}

async function aktiveAnrufeAktualisieren() {
    try {
        var anrufe = await anrufeLadenApi(true);
        var container = document.getElementById("aktive-anrufe-liste");
        var badge = document.getElementById("anrufe-aktiv-badge");
        if (!container) return;

        if (badge) badge.textContent = anrufe.length + " aktiv";
        container.innerHTML = "";
        if (anrufe.length === 0) {
            container.innerHTML = '<p style="color:#666;text-align:center;padding:1rem">Keine aktiven Anrufe.</p>';
            return;
        }

        anrufe.forEach(function (a) {
            var karte = document.createElement("div");
            karte.className = "anruf-karte " + a.status;
            karte.innerHTML =
                '<div><strong>' + escapeHtml(a.anrufer_nummer) + '</strong>' +
                (a.anrufer_name ? ' - ' + escapeHtml(a.anrufer_name) : '') +
                '<br><small>Agent: ' + escapeHtml(a.agent_name || '-') +
                ' | Queue: ' + escapeHtml(a.warteschlange || '-') + '</small></div>' +
                '<span class="status-badge status-' + a.status + '">' + escapeHtml(a.status) + '</span>';
            container.appendChild(karte);
        });
    } catch (_) {}
}

async function anrufprotokollAktualisieren() {
    try {
        var anrufe = await anrufeLadenApi(false);
        var tbody = document.querySelector("#anrufe-tabelle tbody");
        if (!tbody) return;
        tbody.innerHTML = "";
        anrufe.forEach(function (a) {
            var tr = document.createElement("tr");
            var dauerText = a.dauer_sekunden > 0
                ? Math.floor(a.dauer_sekunden / 60) + ":" + ("0" + (a.dauer_sekunden % 60)).slice(-2)
                : "-";
            tr.innerHTML =
                "<td>" + escapeHtml(a.beginn || "") + "</td>" +
                "<td>" + escapeHtml(a.anrufer_nummer) + (a.anrufer_name ? " (" + escapeHtml(a.anrufer_name) + ")" : "") + "</td>" +
                "<td>" + escapeHtml(a.agent_name || "-") + "</td>" +
                "<td>" + escapeHtml(a.warteschlange || "-") + "</td>" +
                "<td>" + escapeHtml(a.typ) + "</td>" +
                '<td><span class="status-badge">' + escapeHtml(a.status) + "</span></td>" +
                "<td>" + dauerText + "</td>";
            tbody.appendChild(tr);
        });
    } catch (_) {}
}

// ===== Softphone =====

function initSoftphone() {
    var sipForm = document.getElementById("sip-form");
    if (!sipForm) return;

    var tasten = document.querySelectorAll(".dialpad-taste");
    tasten.forEach(function (taste) {
        taste.addEventListener("click", function () {
            var wahlnummer = document.getElementById("wahlnummer");
            if (wahlnummer) wahlnummer.value += taste.getAttribute("data-dtmf");
        });
    });

    sipForm.addEventListener("submit", function (e) {
        e.preventDefault();
        var statusDiv = document.getElementById("sip-status");
        var benutzer = document.getElementById("sip-benutzer").value;

        statusDiv.className = "sip-status verbindend";
        statusDiv.textContent = "Verbinde...";

        setTimeout(function () {
            statusDiv.className = "sip-status online";
            statusDiv.textContent = "Verbunden als " + benutzer;
            document.getElementById("btn-sip-verbinden").hidden = true;
            document.getElementById("btn-sip-trennen").hidden = false;
        }, 1500);
    });

    document.getElementById("btn-sip-trennen").addEventListener("click", function () {
        var statusDiv = document.getElementById("sip-status");
        statusDiv.className = "sip-status offline";
        statusDiv.textContent = "Nicht verbunden";
        document.getElementById("btn-sip-verbinden").hidden = false;
        document.getElementById("btn-sip-trennen").hidden = true;
        document.getElementById("anruf-info").hidden = true;
    });

    document.getElementById("btn-anrufen").addEventListener("click", function () {
        var nummer = document.getElementById("wahlnummer").value;
        if (!nummer) return;
        document.getElementById("anruf-info").hidden = false;
        document.getElementById("anruf-gegenstelle").textContent = nummer;
        document.getElementById("anruf-status-anzeige").textContent = "Klingelt...";
        document.getElementById("btn-anrufen").hidden = true;
        document.getElementById("btn-auflegen").hidden = false;

        setTimeout(function () {
            document.getElementById("anruf-status-anzeige").textContent = "Verbunden";
            startAnrufTimer();
        }, 2000);
    });

    document.getElementById("btn-auflegen").addEventListener("click", function () {
        stopAnrufTimer();
        document.getElementById("anruf-info").hidden = true;
        document.getElementById("btn-anrufen").hidden = false;
        document.getElementById("btn-auflegen").hidden = true;
        document.getElementById("btn-annehmen").hidden = true;
    });

    document.getElementById("btn-annehmen").addEventListener("click", function () {
        document.getElementById("anruf-status-anzeige").textContent = "Verbunden";
        document.getElementById("btn-annehmen").hidden = true;
        startAnrufTimer();
    });
}

var anrufTimerInterval = null;
var anrufTimerSekunden = 0;

function startAnrufTimer() {
    anrufTimerSekunden = 0;
    var timerDiv = document.getElementById("anruf-timer");
    if (anrufTimerInterval) clearInterval(anrufTimerInterval);
    anrufTimerInterval = setInterval(function () {
        anrufTimerSekunden++;
        var min = Math.floor(anrufTimerSekunden / 60);
        var sec = anrufTimerSekunden % 60;
        if (timerDiv) timerDiv.textContent = ("0" + min).slice(-2) + ":" + ("0" + sec).slice(-2);
    }, 1000);
}

function stopAnrufTimer() {
    if (anrufTimerInterval) { clearInterval(anrufTimerInterval); anrufTimerInterval = null; }
    anrufTimerSekunden = 0;
    var timerDiv = document.getElementById("anruf-timer");
    if (timerDiv) timerDiv.textContent = "00:00";
}

// ===== Dashboard (rollenbasiert) =====

function initDashboard() {
    var container = document.getElementById("dashboard");
    if (!container) return;

    var auth = JSON.parse(sessionStorage.getItem("med_guard_auth") || localStorage.getItem("med_guard_auth") || "{}");
    var rolle = (auth.rolle || "admin").toLowerCase();

    var patienten = dbLaden("patienten");
    var aerzte = dbLaden("aerzte");
    var heute = new Date().toISOString().split("T")[0];
    var termine = dbLaden("termine").filter(function (t) { return t.datum === heute; });
    var wartezimmer = dbLaden("wartezimmer").filter(function (w) { return w.status !== "fertig"; });
    var agenten = dbLaden("agenten");
    var onlineAgenten = agenten.filter(function (a) { return a.status === "online"; });

    // Rollenbasiertes HTML generieren
    var html = "";

    // Rollen-Tabs (nur wenn Admin)
    if (rolle === "admin" || rolle === "administrator") {
        html += '<div style="display:flex;gap:0.5rem;margin-bottom:1.5rem;flex-wrap:wrap">' +
            '<button type="button" class="dashboard-rolle-btn aktiv" onclick="dashboardRolleWechseln(\'admin\',this)"><i class="fa-solid fa-user-gear"></i> Admin</button>' +
            '<button type="button" class="dashboard-rolle-btn" onclick="dashboardRolleWechseln(\'teamleitung\',this)"><i class="fa-solid fa-users-gear"></i> Teamleiter</button>' +
            '<button type="button" class="dashboard-rolle-btn" onclick="dashboardRolleWechseln(\'standortleitung\',this)"><i class="fa-solid fa-building"></i> Standortleitung</button>' +
            '<button type="button" class="dashboard-rolle-btn" onclick="dashboardRolleWechseln(\'agent\',this)"><i class="fa-solid fa-headset"></i> Agent</button>' +
            '</div>';
    }

    // ===== ADMIN Dashboard =====
    html += '<div id="dash-admin" class="dash-view">';
    html += '<h2 style="margin-bottom:1rem"><i class="fa-solid fa-chart-pie"></i> Admin Dashboard</h2>';

    // KPI-Zeile
    html += '<div class="stat-grid" style="margin-bottom:1.5rem">' +
        statCard("fa-users", "bg-primary", patienten.length, "Patienten") +
        statCard("fa-user-doctor", "bg-success", aerzte.length, "Aerzte") +
        statCard("fa-calendar-check", "bg-warning", termine.length, "Termine heute") +
        statCard("fa-couch", "bg-info", wartezimmer.length, "Wartezimmer") +
        statCard("fa-headset", "bg-primary", onlineAgenten.length + "/" + agenten.length, "Agenten online") +
        '</div>';

    // Callcenter Live
    html += '<div class="card" style="margin-bottom:1.5rem"><div style="padding:1rem"><h3 style="margin-bottom:1rem"><i class="fa-solid fa-signal"></i> Callcenter Live</h3>';
    html += '<div class="stat-grid">' +
        statCard("fa-phone-volume", "bg-success", "2", "Aktive Gespraeche") +
        statCard("fa-clock", "bg-warning", "1", "In Warteschleife") +
        statCard("fa-headset", "bg-primary", onlineAgenten.length, "Agenten frei") +
        statCard("fa-robot", "bg-info", "3", "Via Voicebot") +
        '</div>';

    // Agenten-Status
    html += '<h3 style="margin:1rem 0 0.75rem"><i class="fa-solid fa-users"></i> Agenten-Status</h3>';
    html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:0.75rem">';
    agenten.forEach(function (a) {
        var statusFarben = { online: "#22c55e", im_gespraech: "#06b6d4", pause: "#f59e0b", azu: "#dc2626", meeting: "#7c3aed", at_chris: "#0369a1", offline: "#94a3b8" };
        var statusLabels = { online: "Verfuegbar", im_gespraech: "Im Gespraech", pause: "Pause", azu: "AZU", meeting: "Meeting", at_chris: "@Chris", offline: "Offline" };
        var farbe = statusFarben[a.status] || "#94a3b8";
        var statusText = statusLabels[a.status] || a.status;
        html += '<div style="border:1px solid var(--border);border-radius:var(--radius);padding:0.75rem;background:var(--card);display:flex;align-items:center;gap:0.75rem">' +
            '<div style="width:36px;height:36px;border-radius:8px;background:' + farbe + ';display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:0.8rem">' + escapeHtml((a.name || "?").substring(0, 2).toUpperCase()) + '</div>' +
            '<div><div style="font-weight:600;font-size:0.85rem">' + escapeHtml(a.name) + '</div>' +
            '<div style="font-size:0.75rem;color:' + farbe + '">' + statusText + '</div></div>' +
            '</div>';
    });
    html += '</div></div></div>';

    // Termine + Wartezimmer nebeneinander
    html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem">';
    html += '<div class="card"><div style="padding:1rem"><h3><i class="fa-solid fa-calendar-days"></i> Heutige Termine</h3>' +
        '<table style="width:100%;margin-top:0.75rem;font-size:0.85rem"><thead><tr><th>Uhrzeit</th><th>Patient</th><th>Arzt</th><th>Status</th></tr></thead><tbody id="dashboard-termine"></tbody></table></div></div>';
    html += '<div class="card"><div style="padding:1rem"><h3><i class="fa-solid fa-couch"></i> Wartezimmer</h3><div id="dashboard-wartezimmer" style="margin-top:0.75rem"></div></div></div>';
    html += '</div>';
    html += '</div>'; // end dash-admin

    // ===== TEAMLEITER Dashboard =====
    html += '<div id="dash-teamleitung" class="dash-view" style="display:none">';
    html += '<h2 style="margin-bottom:1rem"><i class="fa-solid fa-users-gear"></i> Teamleiter Dashboard</h2>';
    html += '<div class="stat-grid" style="margin-bottom:1.5rem">' +
        statCard("fa-phone", "bg-primary", "47", "Anrufe heute") +
        statCard("fa-check", "bg-success", "42", "Angenommen") +
        statCard("fa-phone-slash", "bg-danger", "5", "Verpasst") +
        statCard("fa-clock", "bg-warning", "12s", "Avg. Wartezeit") +
        statCard("fa-headset", "bg-info", onlineAgenten.length + "/" + agenten.length, "Agenten") +
        '</div>';

    // Agenten-Tabelle
    html += '<div class="card" style="margin-bottom:1.5rem"><div style="padding:1rem"><h3><i class="fa-solid fa-headset"></i> Agenten Uebersicht</h3>' +
        '<table style="width:100%;margin-top:0.75rem;font-size:0.85rem"><thead><tr><th>Agent</th><th>Status</th><th>Queue</th><th>Anrufe</th><th>Avg. Dauer</th></tr></thead><tbody>';
    agenten.forEach(function (a) {
        var statusKlasse = a.status === "online" ? "status-bestaetigt" : a.status === "pause" ? "status-geplant" : "status-abgesagt";
        html += '<tr><td>' + escapeHtml(a.name) + '</td>' +
            '<td><span class="status-badge ' + statusKlasse + '">' + escapeHtml(a.status) + '</span></td>' +
            '<td>' + escapeHtml(a.warteschlange || "Alle") + '</td>' +
            '<td>' + Math.floor(Math.random() * 15 + 3) + '</td>' +
            '<td>' + Math.floor(Math.random() * 200 + 60) + 's</td></tr>';
    });
    html += '</tbody></table></div></div>';

    // Hotlines
    html += '<div class="card"><div style="padding:1rem"><h3><i class="fa-solid fa-tower-broadcast"></i> Hotline Live</h3>' +
        '<div style="margin-top:0.75rem">';
    [{ name: "Allgemein", auslastung: 65 }, { name: "Notfall", auslastung: 20 }, { name: "Rezept", auslastung: 45 }].forEach(function (h) {
        var farbe = h.auslastung > 80 ? "var(--danger)" : h.auslastung > 50 ? "var(--warning)" : "var(--success)";
        html += '<div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:0.5rem">' +
            '<span style="min-width:80px;font-size:0.85rem;font-weight:600">' + h.name + '</span>' +
            '<div style="flex:1;background:var(--bg);border-radius:4px;height:8px;overflow:hidden"><div style="width:' + h.auslastung + '%;height:100%;background:' + farbe + ';border-radius:4px"></div></div>' +
            '<span style="font-size:0.8rem;font-weight:700;min-width:35px;text-align:right">' + h.auslastung + '%</span></div>';
    });
    html += '</div></div></div>';
    html += '</div>'; // end dash-teamleitung

    // ===== STANDORTLEITUNG Dashboard =====
    html += '<div id="dash-standortleitung" class="dash-view" style="display:none">';
    html += '<h2 style="margin-bottom:1rem"><i class="fa-solid fa-building"></i> Standortleitung Dashboard</h2>';
    html += '<div style="background:#fffbeb;border:1px solid #fbbf24;border-radius:var(--radius);padding:0.75rem;margin-bottom:1rem;font-size:0.85rem;color:#92400e"><i class="fa-solid fa-location-dot"></i> Ansicht: <strong>Praxis Dr. Schmidt</strong> &mdash; Nur Daten dieses Standorts</div>';
    html += '<div class="stat-grid" style="margin-bottom:1.5rem">' +
        statCard("fa-phone", "bg-primary", "28", "Anrufe heute") +
        statCard("fa-calendar-check", "bg-success", termine.length, "Termine heute") +
        statCard("fa-envelope", "bg-warning", "7", "Nachrichten offen") +
        statCard("fa-headset", "bg-info", onlineAgenten.length, "Agenten online") +
        '</div>';

    // Postfach
    html += '<div class="card" style="margin-bottom:1.5rem"><div style="padding:1rem"><h3><i class="fa-solid fa-inbox"></i> Postfach</h3>' +
        '<div style="margin-top:0.75rem">';
    [{ von: "Lisa M.", anliegen: "Terminanfrage Hr. Weber", status: "offen", zeit: "14:23" },
     { von: "Tom R.", anliegen: "Rezeptbestellung Ibuprofen", status: "erledigt", zeit: "13:45" },
     { von: "Voicebot", anliegen: "Rueckrufwunsch Fr. Klein", status: "offen", zeit: "12:10" }
    ].forEach(function (n) {
        var badge = n.status === "erledigt" ? 'background:#dcfce7;color:#15803d' : 'background:#fef3c7;color:#92400e';
        html += '<div style="display:flex;align-items:center;gap:0.75rem;padding:0.5rem 0;border-bottom:1px solid var(--border)">' +
            '<div style="flex:1"><strong style="font-size:0.85rem">' + escapeHtml(n.anliegen) + '</strong>' +
            '<div style="font-size:0.75rem;color:var(--text-muted)">Von: ' + escapeHtml(n.von) + '  ' + n.zeit + '</div></div>' +
            '<span style="padding:0.2rem 0.5rem;border-radius:4px;font-size:0.7rem;font-weight:600;' + badge + '">' + escapeHtml(n.status) + '</span></div>';
    });
    html += '</div></div></div>';
    html += '</div>'; // end dash-standortleitung

    // ===== AGENT Dashboard =====
    html += '<div id="dash-agent" class="dash-view" style="display:none">';
    html += '<h2 style="margin-bottom:1rem"><i class="fa-solid fa-headset"></i> Agent Dashboard</h2>';
    html += '<div class="stat-grid" style="margin-bottom:1.5rem">' +
        statCard("fa-phone", "bg-primary", "12", "Meine Anrufe heute") +
        statCard("fa-check", "bg-success", "11", "Angenommen") +
        statCard("fa-clock", "bg-warning", "8s", "Avg. Wartezeit") +
        statCard("fa-stopwatch", "bg-info", "3:42", "Avg. Gespraechsdauer") +
        '</div>';

    // Meine Tickets
    html += '<div class="card" style="margin-bottom:1.5rem"><div style="padding:1rem"><h3><i class="fa-solid fa-ticket"></i> Meine offenen Tickets</h3>' +
        '<div style="margin-top:0.75rem">';
    [{ patient: "Hr. Weber", anliegen: "Terminverschiebung", prio: "mittel" },
     { patient: "Fr. Klein", anliegen: "Rueckruf gewuenscht", prio: "hoch" },
     { patient: "Hr. Braun", anliegen: "Rezeptanfrage", prio: "niedrig" }
    ].forEach(function (t) {
        var prioFarbe = t.prio === "hoch" ? "var(--danger)" : t.prio === "mittel" ? "var(--warning)" : "var(--success)";
        html += '<div style="display:flex;align-items:center;gap:0.75rem;padding:0.5rem 0;border-bottom:1px solid var(--border)">' +
            '<div style="width:8px;height:8px;border-radius:50%;background:' + prioFarbe + '"></div>' +
            '<div style="flex:1"><strong style="font-size:0.85rem">' + escapeHtml(t.patient) + '</strong>' +
            '<div style="font-size:0.75rem;color:var(--text-muted)">' + escapeHtml(t.anliegen) + '</div></div>' +
            '<span style="font-size:0.75rem;color:var(--text-muted)">' + escapeHtml(t.prio) + '</span></div>';
    });
    html += '</div></div></div>';

    // Status-Buttons
    html += '<div class="card"><div style="padding:1rem"><h3><i class="fa-solid fa-circle-dot"></i> Mein Status</h3>' +
        '<div style="display:flex;gap:0.75rem;margin-top:0.75rem">' +
        '<button type="button" style="flex:1;padding:0.6rem 0.4rem;border-radius:var(--radius);border:2px solid #22c55e;background:#f0fdf4;color:#15803d;font-weight:700;cursor:pointer;font-size:0.8rem"><i class="fa-solid fa-circle"></i> Frei</button>' +
        '<button type="button" style="flex:1;padding:0.6rem 0.4rem;border-radius:var(--radius);border:2px solid #06b6d4;background:#ecfeff;color:#0891b2;font-weight:700;cursor:pointer;font-size:0.8rem"><i class="fa-solid fa-phone"></i> Gespraech</button>' +
        '<button type="button" style="flex:1;padding:0.6rem 0.4rem;border-radius:var(--radius);border:2px solid #f59e0b;background:#fffbeb;color:#92400e;font-weight:700;cursor:pointer;font-size:0.8rem"><i class="fa-solid fa-pause"></i> Pause</button>' +
        '<button type="button" style="flex:1;padding:0.6rem 0.4rem;border-radius:var(--radius);border:2px solid #dc2626;background:#fef2f2;color:#dc2626;font-weight:700;cursor:pointer;font-size:0.8rem"><i class="fa-solid fa-graduation-cap"></i> AZU</button>' +
        '<button type="button" style="flex:1;padding:0.6rem 0.4rem;border-radius:var(--radius);border:2px solid #7c3aed;background:#f5f3ff;color:#6d28d9;font-weight:700;cursor:pointer;font-size:0.8rem"><i class="fa-solid fa-users"></i> Meeting</button>' +
        '<button type="button" style="flex:1;padding:0.6rem 0.4rem;border-radius:var(--radius);border:2px solid #0369a1;background:#e0f2fe;color:#0369a1;font-weight:700;cursor:pointer;font-size:0.8rem"><i class="fa-solid fa-at"></i> @Chris</button>' +
        '<button type="button" style="flex:1;padding:0.6rem 0.4rem;border-radius:var(--radius);border:2px solid #94a3b8;background:#f8fafc;color:#64748b;font-weight:700;cursor:pointer;font-size:0.8rem"><i class="fa-solid fa-circle-xmark"></i> Offline</button>' +
        '</div></div></div>';
    html += '</div>'; // end dash-agent

    container.innerHTML = html;

    // Titel setzen
    var titel = document.getElementById("dashboard-titel");
    if (titel) {
        var rollenTitel = { admin: "Admin Dashboard", administrator: "Admin Dashboard", teamleitung: "Teamleiter Dashboard", standortleitung: "Standortleitung", agent: "Agent Dashboard" };
        titel.textContent = rollenTitel[rolle] || "Dashboard";
    }

    // Tabellen fuellen (Admin)
    var termineListe = document.getElementById("dashboard-termine");
    if (termineListe) {
        termineListe.innerHTML = "";
        if (termine.length === 0) {
            termineListe.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#888">Keine Termine heute</td></tr>';
        } else {
            termine.forEach(function (t) {
                var tr = document.createElement("tr");
                var statusKlasse = STATUS_KLASSEN[t.status] || "status-geplant";
                tr.innerHTML =
                    "<td>" + escapeHtml(t.uhrzeit) + "</td>" +
                    "<td>" + escapeHtml(t.patient_name) + "</td>" +
                    "<td>" + escapeHtml(t.arzt_name) + "</td>" +
                    '<td><span class="status-badge ' + statusKlasse + '">' + escapeHtml(t.status) + "</span></td>";
                termineListe.appendChild(tr);
            });
        }
    }

    var warteListe = document.getElementById("dashboard-wartezimmer");
    if (warteListe) {
        warteListe.innerHTML = "";
        if (wartezimmer.length === 0) {
            warteListe.innerHTML = '<p style="color:#888;text-align:center;padding:1rem">Wartezimmer leer</p>';
        } else {
            wartezimmer.forEach(function (w) {
                var div = document.createElement("div");
                div.className = "warte-mini " + w.status;
                div.innerHTML = '<strong>' + escapeHtml(w.patient_name) + '</strong> <span class="status-badge status-' +
                    (w.status === "aufgerufen" ? "bestaetigt" : "geplant") + '">' + escapeHtml(w.status) + '</span>' +
                    '<br><small>' + wartezeitBerechnen(w.ankunft_zeit) + '</small>';
                warteListe.appendChild(div);
            });
        }
    }

    // Richtige View basierend auf Rolle zeigen
    if (rolle !== "admin" && rolle !== "administrator") {
        var map = { teamleitung: "dash-teamleitung", standortleitung: "dash-standortleitung", agent: "dash-agent" };
        var target = map[rolle];
        if (target) {
            document.querySelectorAll(".dash-view").forEach(function (v) { v.style.display = "none"; });
            var el = document.getElementById(target);
            if (el) el.style.display = "block";
        }
    }
}

function statCard(icon, bg, wert, label) {
    return '<div class="stat-card"><div class="stat-icon ' + bg + '"><i class="fa-solid ' + icon + '"></i></div>' +
        '<div class="stat-content"><div class="stat-value">' + wert + '</div><div class="stat-label">' + escapeHtml(label) + '</div></div></div>';
}

// Dashboard-Rolle wechseln (nur Admin kann das)
if (typeof window !== "undefined") {
    window.dashboardRolleWechseln = function (rolle, btn) {
        document.querySelectorAll(".dashboard-rolle-btn").forEach(function (b) { b.classList.remove("aktiv"); });
        if (btn) btn.classList.add("aktiv");
        document.querySelectorAll(".dash-view").forEach(function (v) { v.style.display = "none"; });
        var map = { admin: "dash-admin", teamleitung: "dash-teamleitung", standortleitung: "dash-standortleitung", agent: "dash-agent" };
        var target = map[rolle] || "dash-admin";
        var el = document.getElementById(target);
        if (el) el.style.display = "block";
        var titel = document.getElementById("dashboard-titel");
        var rollenTitel = { admin: "Admin Dashboard", teamleitung: "Teamleiter Dashboard", standortleitung: "Standortleitung", agent: "Agent Dashboard" };
        if (titel) titel.textContent = rollenTitel[rolle] || "Dashboard";
    };
}

// ===== Chat-Widget =====

function initChatWidget() {
    var toggle = document.getElementById("chat-toggle");
    var fenster = document.getElementById("chat-fenster");
    var schliessen = document.getElementById("chat-schliessen");
    var input = document.getElementById("chat-input");
    var senden = document.getElementById("chat-senden");

    if (!toggle || !fenster) return;

    toggle.addEventListener("click", function () {
        var sichtbar = fenster.style.display === "flex";
        fenster.style.display = sichtbar ? "none" : "flex";
        if (!sichtbar) {
            var msgs = document.getElementById("chat-nachrichten");
            if (msgs && msgs.children.length === 0) {
                chatNachrichtHinzufuegen("bot", "Hallo! Ich bin der " + MED_BRANCHE.assistent + ". Wie kann ich helfen? Fragen Sie mich nach " + MED_BRANCHE.kunden + ", Terminen, " + MED_BRANCHE.mitarbeiter + " oder dem Wartezimmer.");
            }
            if (input) input.focus();
        }
    });

    if (schliessen) schliessen.addEventListener("click", function () { fenster.style.display = "none"; });

    if (senden) senden.addEventListener("click", chatSenden);
    if (input) input.addEventListener("keydown", function (e) { if (e.key === "Enter") chatSenden(); });
}

var chatVerlauf = [];

function chatSenden() {
    var input = document.getElementById("chat-input");
    if (!input || !input.value.trim()) return;
    var text = input.value.trim();
    input.value = "";
    chatNachrichtHinzufuegen("user", text);
    chatVerlauf.push({ role: "user", content: text });

    if (MED_LLM_VERFUEGBAR) {
        // Live-Modus: LLM-API aufrufen
        chatNachrichtHinzufuegen("bot-loading", "...");
        chatLlmAnfrage(text);
    } else {
        // Demo-Modus: lokale Antwort
        setTimeout(function () {
            var antwort = chatAntwortGenerieren(text);
            chatNachrichtHinzufuegen("bot", antwort);
            chatVerlauf.push({ role: "assistant", content: antwort });
            sprachAusgabe(antwort);
        }, 500);
    }
}

function chatLlmAnfrage(text) {
    var xhr = new XMLHttpRequest();
    xhr.open("POST", API_BASE + "/chat", true);
    xhr.setRequestHeader("Content-Type", "application/json");
    xhr.timeout = 30000;
    xhr.onload = function () {
        // Lade-Nachricht entfernen
        var loading = document.querySelector(".chat-msg-bot-loading");
        if (loading) loading.remove();
        if (xhr.status === 200) {
            try {
                var daten = JSON.parse(xhr.responseText);
                var antwort = daten.antwort || "Keine Antwort erhalten.";
                chatNachrichtHinzufuegen("bot", antwort);
                chatVerlauf.push({ role: "assistant", content: antwort });
                sprachAusgabe(antwort);
            } catch (e) {
                chatNachrichtHinzufuegen("bot", "Fehler bei der Verarbeitung.");
            }
        } else {
            // Fallback auf Demo-Modus
            var antwort = chatAntwortGenerieren(text);
            chatNachrichtHinzufuegen("bot", antwort);
            chatVerlauf.push({ role: "assistant", content: antwort });
            sprachAusgabe(antwort);
        }
    };
    xhr.onerror = function () {
        var loading = document.querySelector(".chat-msg-bot-loading");
        if (loading) loading.remove();
        var antwort = chatAntwortGenerieren(text);
        chatNachrichtHinzufuegen("bot", antwort);
        chatVerlauf.push({ role: "assistant", content: antwort });
        sprachAusgabe(antwort);
    };
    xhr.send(JSON.stringify({ text: text, verlauf: chatVerlauf.slice(-10), branche: MED_BRANCHE_KEY, firmen_name: MED_FIRMEN_NAME }));
}

function chatNachrichtHinzufuegen(typ, text) {
    var container = document.getElementById("chat-nachrichten");
    if (!container) return;
    var div = document.createElement("div");
    div.className = "chat-msg chat-msg-" + typ;
    div.textContent = text;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
}

function chatAntwortGenerieren(frage) {
    var f = frage.toLowerCase();
    var b = MED_BRANCHE;
    var name = MED_FIRMEN_NAME || b.label;

    if (f.includes("hallo") || f.includes("hi") || f.includes("guten")) {
        return "Hallo! Willkommen bei " + name + ". Wie kann ich Ihnen helfen?";
    }

    if (f.includes("patient") || f.includes("kunde") || f.includes("mandant") || f.includes("klient")) {
        var patienten = dbLaden("patienten");
        if (patienten.length === 0) return "Aktuell sind keine " + b.kunden + " angelegt.";
        var namen = patienten.map(function (p) { return p.vorname + " " + p.nachname; }).join(", ");
        return "Wir haben " + patienten.length + " " + b.kunden + ": " + namen + ".";
    }

    if (f.includes("arzt") || f.includes("aerzt") || f.includes("doktor") || f.includes("mitarbeiter") || f.includes("anwalt") || f.includes("berater") || f.includes("friseur") || f.includes("mechaniker")) {
        var aerzte = dbLaden("aerzte");
        if (aerzte.length === 0) return "Keine " + b.mitarbeiter + " angelegt.";
        var infos = aerzte.map(function (a) {
            return ((a.titel || "") + " " + a.vorname + " " + a.nachname).trim() + " (" + a.fachrichtung + ")";
        }).join(", ");
        return "Unsere " + b.mitarbeiter + ": " + infos;
    }

    if (f.includes("termin")) {
        var heute = new Date().toISOString().split("T")[0];
        var termine = dbLaden("termine").filter(function (t) { return t.datum === heute; });
        if (termine.length === 0) return "Heute sind keine Termine geplant.";
        var tInfos = termine.map(function (t) { return t.uhrzeit + " - " + t.patient_name + " bei " + t.arzt_name; }).join(" | ");
        return "Heute " + termine.length + " Termine: " + tInfos;
    }

    if (f.includes("warte")) {
        var wartezimmer = dbLaden("wartezimmer").filter(function (w) { return w.status !== "fertig"; });
        if (wartezimmer.length === 0) return "Das Wartezimmer ist leer.";
        return wartezimmer.length + " " + b.kunden + " im Wartezimmer: " +
            wartezimmer.map(function (w) { return w.patient_name + " (" + w.status + ")"; }).join(", ");
    }

    if (f.includes("hilfe") || f.includes("help")) {
        return "Ich kann Ihnen helfen mit: " + b.kunden + "-Info, " + b.mitarbeiter + "-Info, Termine heute, Wartezimmer-Status, Voicebot, Callflow, Uebersetzer.";
    }

    if (f.includes("agent")) {
        var agenten = dbLaden("agenten");
        var online = agenten.filter(function (a) { return a.status === "online"; });
        return agenten.length + " Agenten registriert, davon " + online.length + " online.";
    }

    if (f.includes("voicebot") || f.includes("sprachbot")) {
        return "Der Voicebot bearbeitet automatisch eingehende Anrufe. Dienste: " + b.dienste.join(", ") + ". Konfigurieren Sie ihn unter 'Voicebot'.";
    }

    if (f.includes("callflow") || f.includes("anrufablauf")) {
        return "Im Callflow Editor koennen Sie den Anrufablauf visuell gestalten.";
    }

    if (f.includes("uebersetz") || f.includes("sprache") || f.includes("translation")) {
        return "Der Uebersetzer hilft bei der Kommunikation mit fremdsprachigen " + b.kunden + ". Er unterstuetzt 6 Sprachen.";
    }

    if (f.includes("branche") || f.includes("buero")) {
        return "Aktuelle Branche: " + b.label + " (" + b.buero_name + "). Aendern Sie die Branche in den Standort-Einstellungen.";
    }

    if (f.includes("demo") || f.includes("reset") || f.includes("zurueck")) {
        localStorage.removeItem("med_demo_geladen");
        demoDatenLaden();
        return "Demo-Daten wurden zurueckgesetzt! Laden Sie die Seite neu.";
    }

    return "Das habe ich nicht verstanden. Fragen Sie mich nach: " + b.kunden + ", " + b.mitarbeiter + ", Termine, Wartezimmer, Voicebot, Callflow, Uebersetzer oder 'hilfe'.";
}

// ===== Hilfsfunktionen =====

function escapeHtml(text) {
    var div = document.createElement("div");
    div.textContent = text;
    return div.innerHTML;
}

// ===== Demo-Reset Button =====

function initDemoReset() {
    var btn = document.getElementById("btn-demo-reset");
    if (!btn) return;
    btn.addEventListener("click", function () {
        if (!confirm("Demo-Daten zuruecksetzen? Alle Aenderungen gehen verloren.")) return;
        localStorage.removeItem("med_demo_geladen");
        localStorage.removeItem("med_standort_geladen");
        localStorage.removeItem("med_acd_config");
        localStorage.removeItem("med_zeitplan");
        localStorage.removeItem("med_standort_info");
        demoDatenLaden();
        location.reload();
    });
}

// ===== Sprach-Chat (Web Speech API) =====

function initSprachChat() {
    var mikBtn = document.getElementById("chat-mikrofon");
    if (!mikBtn) return;
    var SpeechRec = typeof window !== "undefined" && (window.SpeechRecognition || window.webkitSpeechRecognition);
    if (!SpeechRec) {
        mikBtn.title = "Spracherkennung nicht verfuegbar";
        mikBtn.style.opacity = "0.5";
        return;
    }
    var recognition = new SpeechRec();
    recognition.lang = "de-DE";
    recognition.continuous = false;
    recognition.interimResults = false;
    var recording = false;

    mikBtn.addEventListener("click", function () {
        if (recording) {
            recognition.stop();
            return;
        }
        recording = true;
        mikBtn.classList.add("recording");
        recognition.start();
    });

    recognition.onresult = function (e) {
        if (!e.results || !e.results[0] || !e.results[0][0]) return;
        var text = e.results[0][0].transcript;
        var input = document.getElementById("chat-input");
        if (input) input.value = text;
        chatSenden();
    };

    recognition.onend = function () {
        recording = false;
        mikBtn.classList.remove("recording");
    };

    recognition.onerror = function () {
        recording = false;
        mikBtn.classList.remove("recording");
    };
}

function sprachAusgabe(text) {
    if (typeof window === "undefined" || !window.speechSynthesis) return;
    var utt = new SpeechSynthesisUtterance(text);
    utt.lang = "de-DE";
    utt.rate = 1.0;
    window.speechSynthesis.speak(utt);
}

// ===== Callflow Editor =====

var callflowDaten = [];
var callflowAusgewaehlt = null;

function demoCallflowLaden() {
    if (callflowDaten.length > 0) return;
    callflowDaten = [
        { id: 1, typ: "start", label: "Eingehender Anruf", config: { quelle: "SIP-Trunk" } },
        { id: 2, typ: "ansage", label: "Willkommen", config: { text: "Willkommen bei der Arztpraxis MED Rezeption.", datei: "willkommen.wav" } },
        { id: 3, typ: "dtmf", label: "Hauptmenue", config: { text: "1=Termin, 2=Rezept, 3=Rezeption, 0=Warteschlange", timeout: 8, optionen: [
            { taste: "1", label: "Terminvergabe", ziel_id: 4 },
            { taste: "2", label: "Rezeptbestellung", ziel_id: 5 },
            { taste: "3", label: "Rezeption", ziel_id: 6 },
            { taste: "0", label: "Warteschlange", ziel_id: 7 }
        ] } },
        { id: 4, typ: "voicebot", label: "Termin-Dialog", config: { dialog: "termin", beschreibung: "Automatische Terminvergabe per Sprache" } },
        { id: 5, typ: "voicebot", label: "Rezept-Dialog", config: { dialog: "rezept", beschreibung: "Rezeptbestellung per Versicherungsnummer" } },
        { id: 6, typ: "transfer", label: "Transfer Rezeption", config: { nebenstelle: "100", timeout: 30 } },
        { id: 7, typ: "warteschlange", label: "Queue Rezeption", config: { queue: "rezeption", ansage: "bitte-warten.wav", maxWait: 120 } },
        { id: 8, typ: "ende", label: "Auflegen", config: {} }
    ];
}

function initCallflowEditor() {
    var canvas = document.getElementById("callflow-flow");
    if (!canvas) return;
    demoCallflowLaden();
    callflowRendern();

    // Baustein-Buttons
    var bausteine = document.querySelectorAll(".callflow-baustein");
    for (var i = 0; i < bausteine.length; i++) {
        bausteine[i].addEventListener("click", function () {
            var typ = this.getAttribute("data-typ");
            var maxId = 0;
            for (var j = 0; j < callflowDaten.length; j++) {
                if (callflowDaten[j].id > maxId) maxId = callflowDaten[j].id;
            }
            callflowDaten.push({
                id: maxId + 1, typ: typ, label: typ.charAt(0).toUpperCase() + typ.slice(1) + " (neu)",
                config: typ === "dtmf" ? { text: "", timeout: 5, optionen: [] } :
                    typ === "ansage" ? { text: "", datei: "" } :
                    typ === "voicebot" ? { dialog: "willkommen", beschreibung: "" } :
                    typ === "warteschlange" ? { queue: "rezeption", ansage: "", maxWait: 120 } :
                    typ === "transfer" ? { nebenstelle: "", timeout: 30 } : {}
            });
            callflowRendern();
        });
    }

    // Speichern
    var saveBtn = document.getElementById("btn-flow-speichern");
    if (saveBtn) saveBtn.addEventListener("click", function () {
        localStorage.setItem("med_callflow", JSON.stringify(callflowDaten));
        alert("Callflow gespeichert!");
    });

    // Simulieren
    var simBtn = document.getElementById("btn-flow-simulieren");
    if (simBtn) simBtn.addEventListener("click", callflowSimulieren);
}

function callflowRendern() {
    var container = document.getElementById("callflow-flow");
    if (!container) return;
    container.innerHTML = "";

    for (var i = 0; i < callflowDaten.length; i++) {
        var node = callflowDaten[i];
        var el = document.createElement("div");
        el.className = "callflow-node" + (callflowAusgewaehlt === node.id ? " selected" : "");
        el.setAttribute("data-id", node.id);

        var bodyHtml = "";
        if (node.typ === "ansage") bodyHtml = '<div class="node-detail">' + escapeHtml(node.config.text || "Keine Ansage") + '</div><div class="node-detail"><small>Datei: ' + escapeHtml(node.config.datei || "-") + '</small></div>';
        else if (node.typ === "dtmf") {
            bodyHtml = '<div class="node-detail">' + escapeHtml(node.config.text || "") + '</div>';
            var opts = node.config.optionen || [];
            for (var o = 0; o < opts.length; o++) bodyHtml += '<div class="node-detail"><small>Taste ' + opts[o].taste + '  ' + escapeHtml(opts[o].label) + '</small></div>';
        }
        else if (node.typ === "voicebot") bodyHtml = '<div class="node-detail">' + escapeHtml(node.config.beschreibung || node.config.dialog) + '</div>';
        else if (node.typ === "transfer") bodyHtml = '<div class="node-detail">Nebenstelle: ' + escapeHtml(node.config.nebenstelle || "-") + '</div>';
        else if (node.typ === "warteschlange") bodyHtml = '<div class="node-detail">Queue: ' + escapeHtml(node.config.queue || "-") + '</div><div class="node-detail"><small>Max. Wartezeit: ' + (node.config.maxWait || 120) + 's</small></div>';
        else if (node.typ === "start") bodyHtml = '<div class="node-detail">' + escapeHtml(node.config.quelle || "Eingehend") + '</div>';

        el.innerHTML = '<div class="callflow-node-header typ-' + node.typ + '"><i class="fa-solid ' + callflowIcon(node.typ) + '"></i> ' + escapeHtml(node.label) + '</div><div class="callflow-node-body">' + bodyHtml + '</div>';
        el.addEventListener("click", (function (nid) {
            return function () { callflowNodeAuswaehlen(nid); };
        })(node.id));
        container.appendChild(el);

        if (i < callflowDaten.length - 1) {
            var pfeil = document.createElement("div");
            pfeil.className = "callflow-pfeil";
            pfeil.innerHTML = '<i class="fa-solid fa-arrow-down"></i>';
            container.appendChild(pfeil);
        }
    }
}

function callflowIcon(typ) {
    var icons = { start: "fa-play", ansage: "fa-volume-high", dtmf: "fa-hashtag", voicebot: "fa-robot", warteschlange: "fa-users-line", transfer: "fa-right-left", bedingung: "fa-code-branch", aufnahme: "fa-microphone", ende: "fa-phone-slash" };
    return icons[typ] || "fa-circle";
}

function callflowNodeAuswaehlen(id) {
    callflowAusgewaehlt = id;
    callflowRendern();
    var node = null;
    for (var i = 0; i < callflowDaten.length; i++) {
        if (callflowDaten[i].id === id) { node = callflowDaten[i]; break; }
    }
    if (!node) return;
    var propsEl = document.getElementById("callflow-props-inhalt");
    if (!propsEl) return;
    var html = '<div class="form-group"><label>Label</label><input type="text" id="cf-prop-label" value="' + escapeHtml(node.label) + '"></div>';
    html += '<div class="form-group"><label>Typ</label><input type="text" value="' + node.typ + '" disabled></div>';
    if (node.config.text !== undefined) html += '<div class="form-group"><label>Text</label><textarea id="cf-prop-text" rows="3">' + escapeHtml(node.config.text || "") + '</textarea></div>';
    if (node.config.nebenstelle !== undefined) html += '<div class="form-group"><label>Nebenstelle</label><input type="text" id="cf-prop-nst" value="' + escapeHtml(node.config.nebenstelle || "") + '"></div>';
    if (node.config.queue !== undefined) html += '<div class="form-group"><label>Queue</label><input type="text" id="cf-prop-queue" value="' + escapeHtml(node.config.queue || "") + '"></div>';
    if (node.config.timeout !== undefined) html += '<div class="form-group"><label>Timeout (Sek.)</label><input type="number" id="cf-prop-timeout" value="' + (node.config.timeout || 5) + '"></div>';
    html += '<div class="button-gruppe"><button type="button" onclick="callflowPropsSpeichern()">Uebernehmen</button>';
    if (node.typ !== "start") html += '<button type="button" class="btn-loeschen" onclick="callflowNodeLoeschen(' + node.id + ')">Loeschen</button>';
    html += '</div>';
    propsEl.innerHTML = html;
}

function callflowPropsSpeichern() {
    if (!callflowAusgewaehlt) return;
    for (var i = 0; i < callflowDaten.length; i++) {
        if (callflowDaten[i].id === callflowAusgewaehlt) {
            var labelEl = document.getElementById("cf-prop-label");
            if (labelEl) callflowDaten[i].label = labelEl.value;
            var textEl = document.getElementById("cf-prop-text");
            if (textEl) callflowDaten[i].config.text = textEl.value;
            var nstEl = document.getElementById("cf-prop-nst");
            if (nstEl) callflowDaten[i].config.nebenstelle = nstEl.value;
            var queueEl = document.getElementById("cf-prop-queue");
            if (queueEl) callflowDaten[i].config.queue = queueEl.value;
            var timeoutEl = document.getElementById("cf-prop-timeout");
            if (timeoutEl) callflowDaten[i].config.timeout = parseInt(timeoutEl.value) || 5;
            break;
        }
    }
    callflowRendern();
    callflowNodeAuswaehlen(callflowAusgewaehlt);
}

function callflowNodeLoeschen(id) {
    callflowDaten = callflowDaten.filter(function (n) { return n.id !== id; });
    callflowAusgewaehlt = null;
    callflowRendern();
    var propsEl = document.getElementById("callflow-props-inhalt");
    if (propsEl) propsEl.innerHTML = '<p class="text-muted">Baustein geloescht.</p>';
}

function callflowSimulieren() {
    var simEl = document.getElementById("callflow-simulation");
    var ablaufEl = document.getElementById("simulation-ablauf");
    if (!simEl || !ablaufEl) return;
    simEl.hidden = false;
    ablaufEl.innerHTML = "";
    var zeilen = [
        { cls: "sim-zeile-system", text: "[SYSTEM] Eingehender Anruf von +49 170 1234567" },
        { cls: "sim-zeile-system", text: "[SYSTEM] Kanal geoeffnet, Sprache: de" },
        { cls: "sim-zeile-audio", text: "[AUDIO] Abspielen: willkommen.wav" },
        { cls: "sim-zeile-audio", text: '[AUDIO] "Willkommen bei der Arztpraxis MED Rezeption."' },
        { cls: "sim-zeile-audio", text: '[AUDIO] "Druecken Sie 1 fuer Terminvergabe, 2 fuer Rezept, 3 fuer Rezeption."' },
        { cls: "sim-zeile-system", text: "[SYSTEM] Warte auf DTMF-Eingabe... (Timeout: 8s)" },
        { cls: "sim-zeile-eingabe", text: "[DTMF] Eingabe: 1" },
        { cls: "sim-zeile-aktion", text: "[AKTION] Weiterleitung an Voicebot-Dialog: termin" },
        { cls: "sim-zeile-system", text: "[VOICEBOT] AGI-Script gestartet: med_voicebot.py termin" },
        { cls: "sim-zeile-audio", text: '[AUDIO] "Fuer welche Fachrichtung? 1=Allgemein, 2=Innere, 3=Andere"' },
        { cls: "sim-zeile-eingabe", text: "[DTMF] Eingabe: 1" },
        { cls: "sim-zeile-aktion", text: "[VOICEBOT] Fachrichtung: Allgemeinmedizin" },
        { cls: "sim-zeile-aktion", text: "[API] GET /api/aerzte  3 Aerzte geladen" },
        { cls: "sim-zeile-aktion", text: "[VOICEBOT] Arzt gefunden: Dr. Mueller (Allgemeinmedizin)" },
        { cls: "sim-zeile-audio", text: '[AUDIO] "Terminvorschlag: Morgen 09:00 Uhr bei Dr. Mueller. Druecken Sie 1 zur Bestaetigung."' },
        { cls: "sim-zeile-eingabe", text: "[DTMF] Eingabe: 1" },
        { cls: "sim-zeile-aktion", text: "[API] POST /api/termine  Termin erstellt (ID: 5)" },
        { cls: "sim-zeile-aktion", text: "[VOICEBOT] VOICEBOT_RESULT=TERMIN" },
        { cls: "sim-zeile-audio", text: '[AUDIO] "Ihr Termin ist bestaetigt. Auf Wiedersehen!"' },
        { cls: "sim-zeile-system", text: "[SYSTEM] Anruf beendet. Dauer: 45 Sekunden" }
    ];
    var idx = 0;
    function naechsteZeile() {
        if (idx >= zeilen.length) return;
        var div = document.createElement("div");
        div.className = "sim-zeile " + zeilen[idx].cls;
        div.textContent = zeilen[idx].text;
        ablaufEl.appendChild(div);
        ablaufEl.scrollTop = ablaufEl.scrollHeight;
        idx++;
        setTimeout(naechsteZeile, 600);
    }
    naechsteZeile();

    var stopBtn = document.getElementById("btn-sim-stop");
    if (stopBtn) stopBtn.addEventListener("click", function () { idx = zeilen.length; simEl.hidden = true; });
}

// ===== Voicebot Konfiguration & Test =====

function initVoicebotSeite() {
    var configForm = document.getElementById("voicebot-config-form");
    if (!configForm) return;

    // Config speichern
    configForm.addEventListener("submit", function (e) {
        e.preventDefault();
        var config = {
            begruessung: document.getElementById("vb-begruessung").value,
            sprache: document.getElementById("vb-sprache").value,
            stimme: document.getElementById("vb-stimme").value,
            maxVersuche: parseInt(document.getElementById("vb-max-versuche").value, 10) || 3,
            timeout: parseInt(document.getElementById("vb-timeout").value, 10) || 5,
            tasten: {
                "1": document.getElementById("vb-taste1").value,
                "2": document.getElementById("vb-taste2").value,
                "3": document.getElementById("vb-taste3").value,
                "0": document.getElementById("vb-taste0").value
            }
        };
        localStorage.setItem("med_voicebot_config", JSON.stringify(config));
        var erfolg = document.getElementById("vb-config-erfolg");
        if (erfolg) { erfolg.textContent = "Konfiguration gespeichert!"; erfolg.hidden = false; setTimeout(function () { erfolg.hidden = true; }, 3000); }
    });

    // Test starten
    var testBtn = document.getElementById("btn-vb-test");
    if (testBtn) testBtn.addEventListener("click", voicebotTestStarten);

    // DTMF-Tasten im Test
    var dtmfBtns = document.querySelectorAll(".vb-dtmf");
    for (var i = 0; i < dtmfBtns.length; i++) {
        dtmfBtns[i].addEventListener("click", function () {
            voicebotTestDtmf(this.getAttribute("data-dtmf"));
        });
    }

    var resetBtn = document.getElementById("btn-vb-test-reset");
    if (resetBtn) resetBtn.addEventListener("click", voicebotTestStarten);

    // Demo-Anrufe laden
    voicebotAnrufeLaden();
}

var vbTestSchritt = 0;
var vbDialogTyp = "allgemein";

function voicebotTestStarten() {
    var bereich = document.getElementById("voicebot-test-bereich");
    var chat = document.getElementById("vb-test-chat");
    if (!bereich || !chat) return;
    bereich.hidden = false;
    chat.innerHTML = "";
    vbTestSchritt = 0;
    vbDialogTyp = "allgemein";

    if (MED_LLM_VERFUEGBAR) {
        vbTestNachricht("system", "[Live-Modus: KI-Voicebot aktiv]");
        voicebotLlmAnfrage("start", 0, "allgemein");
    } else {
        var vbName = MED_FIRMEN_NAME || MED_BRANCHE.label;
        var vbDienste = MED_BRANCHE.dienste;
        var vbMenue = [];
        for (var d = 0; d < vbDienste.length && d < 3; d++) vbMenue.push((d + 1) + " fuer " + vbDienste[d]);
        vbMenue.push("0 fuer die Warteschlange");
        vbTestNachricht("bot", "Willkommen bei " + vbName + ".");
        vbTestNachricht("bot", "Druecken Sie " + vbMenue.join(", ") + ".");
        vbTestNachricht("system", "Warte auf DTMF-Eingabe...");
        sprachAusgabe("Willkommen bei " + vbName + ". Druecken Sie " + vbMenue.join(", ") + ".");
    }
}

function voicebotTestDtmf(taste) {
    var chat = document.getElementById("vb-test-chat");
    if (!chat) return;
    vbTestNachricht("anrufer", "DTMF: " + taste);

    if (MED_LLM_VERFUEGBAR) {
        voicebotLlmAnfrage(taste, vbTestSchritt, vbDialogTyp);
        return;
    }

    // Demo-Modus (unveraendert)
    if (vbTestSchritt === 0) {
        if (taste === "1") {
            vbTestSchritt = 1;
            vbTestNachricht("bot", "Fuer welche Fachrichtung moechten Sie einen Termin?");
            vbTestNachricht("bot", "1 = Allgemeinmedizin, 2 = Innere Medizin, 3 = Andere");
            vbTestNachricht("system", "Warte auf DTMF-Eingabe...");
            sprachAusgabe("Fuer welche Fachrichtung moechten Sie einen Termin?");
        } else if (taste === "2") {
            vbTestSchritt = 10;
            vbTestNachricht("bot", "Bitte geben Sie Ihre Versicherungsnummer ein.");
            vbTestNachricht("system", "Warte auf Eingabe... (max. 12 Ziffern)");
            sprachAusgabe("Bitte geben Sie Ihre Versicherungsnummer ein.");
        } else if (taste === "3") {
            vbTestNachricht("bot", "Sie werden mit der Rezeption verbunden...");
            vbTestNachricht("system", "TRANSFER  Nebenstelle 100");
            sprachAusgabe("Sie werden mit der Rezeption verbunden.");
        } else if (taste === "0") {
            vbTestNachricht("bot", "Bitte warten Sie, Sie werden mit dem naechsten freien Mitarbeiter verbunden.");
            vbTestNachricht("system", "WARTESCHLANGE  rezeption (Prioritaet: 1)");
            sprachAusgabe("Bitte warten Sie.");
        }
    } else if (vbTestSchritt === 1) {
        var fach = taste === "1" ? "Allgemeinmedizin" : taste === "2" ? "Innere Medizin" : "Sonstiges";
        vbTestSchritt = 2;
        var morgen = new Date(Date.now() + 86400000).toLocaleDateString("de-DE");
        vbTestNachricht("system", "API-Anfrage: GET /api/aerzte");
        vbTestNachricht("system", "Arzt gefunden: Dr. Mueller (" + fach + ")");
        vbTestNachricht("bot", "Terminvorschlag: " + morgen + " um 09:00 Uhr bei Dr. Mueller, " + fach + ".");
        vbTestNachricht("bot", "Druecken Sie 1 zur Bestaetigung oder 2 fuer Abbruch.");
        sprachAusgabe("Terminvorschlag: morgen um 9 Uhr bei Doktor Mueller. Druecken Sie 1 zur Bestaetigung.");
    } else if (vbTestSchritt === 2) {
        if (taste === "1") {
            vbTestNachricht("system", "API-Anfrage: POST /api/termine  Termin erstellt");
            vbTestNachricht("bot", "Ihr Termin wurde erfolgreich gebucht! Auf Wiedersehen.");
            vbTestNachricht("system", "VOICEBOT_RESULT = TERMIN ");
            sprachAusgabe("Ihr Termin wurde erfolgreich gebucht. Auf Wiedersehen.");
        } else {
            vbTestNachricht("bot", "Kein Problem. Sie werden mit der Rezeption verbunden.");
            vbTestNachricht("system", "TRANSFER  Rezeption");
        }
        vbTestSchritt = 99;
    } else if (vbTestSchritt === 10) {
        vbTestNachricht("system", "Versicherungsnummer erkannt: " + taste + "...");
        vbTestNachricht("bot", "Ihre Rezeptanfrage wird an die Rezeption weitergeleitet.");
        vbTestNachricht("system", "VOICEBOT_RESULT = TRANSFER, VOICEBOT_REZEPT_VNR = " + taste);
        sprachAusgabe("Ihre Rezeptanfrage wird an die Rezeption weitergeleitet.");
        vbTestSchritt = 99;
    }
}

function voicebotLlmAnfrage(eingabe, schritt, dialogTyp) {
    vbTestNachricht("system", "KI verarbeitet...");
    var xhr = new XMLHttpRequest();
    xhr.open("POST", API_BASE + "/voicebot/dialog", true);
    xhr.setRequestHeader("Content-Type", "application/json");
    xhr.timeout = 30000;
    xhr.onload = function () {
        if (xhr.status === 200) {
            try {
                var daten = JSON.parse(xhr.responseText);
                vbTestSchritt = daten.schritt || vbTestSchritt + 1;
                if (daten.aktion) vbDialogTyp = daten.aktion === "termin_buchen" ? "termin" : daten.aktion === "rezept" ? "rezept" : vbDialogTyp;
                vbTestNachricht("bot", daten.antwort || "...");
                if (daten.aktion && daten.aktion !== "weiter") {
                    vbTestNachricht("system", "AKTION: " + daten.aktion.toUpperCase());
                }
                sprachAusgabe(daten.antwort || "");
            } catch (e) {
                vbTestNachricht("system", "Fehler bei KI-Antwort.");
            }
        } else {
            vbTestNachricht("system", "KI nicht erreichbar - Demo-Modus.");
        }
    };
    xhr.onerror = function () {
        vbTestNachricht("system", "KI nicht erreichbar.");
    };
    xhr.send(JSON.stringify({ eingabe: eingabe, schritt: schritt, dialog_typ: dialogTyp, branche: MED_BRANCHE_KEY, firmen_name: MED_FIRMEN_NAME }));
}

function vbTestNachricht(typ, text) {
    var chat = document.getElementById("vb-test-chat");
    if (!chat) return;
    var div = document.createElement("div");
    div.className = "vb-chat-msg " + (typ === "bot" ? "vb-msg-bot" : typ === "anrufer" ? "vb-msg-anrufer" : "vb-msg-system");
    div.textContent = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

function voicebotAnrufeLaden() {
    var liste = document.getElementById("voicebot-anrufe-liste");
    if (!liste) return;
    var demoAnrufe = [
        { zeit: "09:15", nummer: "+49 170 1234567", ergebnis: "termin", detail: "Termin: Dr. Mueller, Allgemeinmedizin" },
        { zeit: "09:32", nummer: "+49 171 9876543", ergebnis: "rezept", detail: "Rezept-Anfrage VNR: A98765" },
        { zeit: "09:45", nummer: "+49 160 5551234", ergebnis: "transfer", detail: "Weiterleitung an Rezeption" },
        { zeit: "10:03", nummer: "+49 172 3456789", ergebnis: "termin", detail: "Termin: Dr. Schmidt, Innere Medizin" },
        { zeit: "10:18", nummer: "+49 176 8884321", ergebnis: "transfer", detail: "Weiterleitung nach Timeout" },
        { zeit: "10:40", nummer: "+49 151 7779999", ergebnis: "rezept", detail: "Rezept-Anfrage VNR: B12345" }
    ];
    liste.innerHTML = "";
    for (var i = 0; i < demoAnrufe.length; i++) {
        var a = demoAnrufe[i];
        var div = document.createElement("div");
        div.className = "voicebot-anruf-eintrag";
        div.innerHTML = '<div class="anruf-info"><strong>' + a.zeit + ' - ' + escapeHtml(a.nummer) + '</strong>' + escapeHtml(a.detail) + '</div><span class="anruf-ergebnis ergebnis-' + a.ergebnis + '">' + a.ergebnis.charAt(0).toUpperCase() + a.ergebnis.slice(1) + '</span>';
        liste.appendChild(div);
    }
}

// ===== Uebersetzer =====

var medPhrases = {
    begruessung: [
        { de: "Guten Tag, wie kann ich Ihnen helfen?", en: "Good day, how can I help you?", tr: "Merhaba, size nasil yardimci olabilirim?", ar: "   ", ru: ",   ?", pl: "Dzien dobry, jak moge pomoc?" },
        { de: "Haben Sie einen Termin?", en: "Do you have an appointment?", tr: "Randevunuz var mi?", ar: "  ", ru: "   ?", pl: "Czy ma Pan/Pani wizyte?" },
        { de: "Bitte nehmen Sie im Wartezimmer Platz.", en: "Please take a seat in the waiting room.", tr: "Lutfen bekleme odasinda oturunuz.", ar: "    .", ru: ",    .", pl: "Prosze usiasc w poczekalni." },
        { de: "Ihre Versichertenkarte bitte.", en: "Your insurance card, please.", tr: "Sigorta kartinizi lutfen.", ar: "   .", ru: "  , .", pl: "Prosze o karte ubezpieczenia." }
    ],
    anamnese: [
        { de: "Was fuehrt Sie zu uns?", en: "What brings you to us?", tr: "Bizi neden ziyaret ediyorsunuz?", ar: "    ", ru: "    ?", pl: "Co Pana/Pania do nas sprowadza?" },
        { de: "Nehmen Sie regelmaessig Medikamente?", en: "Do you take regular medication?", tr: "Duzenli ilac kullaniyor musunuz?", ar: "   ", ru: "   ?", pl: "Czy przyjmuje Pan/Pani regularnie leki?" },
        { de: "Haben Sie Allergien?", en: "Do you have any allergies?", tr: "Alerjiniz var mi?", ar: "  ", ru: "   ?", pl: "Czy ma Pan/Pani alergie?" },
        { de: "Seit wann haben Sie die Beschwerden?", en: "Since when have you had these symptoms?", tr: "Sikayetleriniz ne zamandan beri var?", ar: "     ", ru: "      ?", pl: "Od kiedy ma Pan/Pani te dolegliwosci?" }
    ],
    schmerzen: [
        { de: "Wo haben Sie Schmerzen?", en: "Where do you have pain?", tr: "Nereniz agriyor?", ar: "  ", ru: "   ?", pl: "Gdzie odczuwa Pan/Pani bol?" },
        { de: "Wie stark sind die Schmerzen auf einer Skala von 1-10?", en: "How severe is the pain on a scale of 1-10?", tr: "1-10 olceginde agriniz ne kadar siddetli?", ar: "       1  10", ru: "      1  10?", pl: "Jak silny jest bol w skali od 1 do 10?" },
        { de: "Ist der Schmerz staendig oder kommt und geht er?", en: "Is the pain constant or does it come and go?", tr: "Agri surekli mi yoksa gelip gidiyor mu?", ar: "     ", ru: "     ?", pl: "Czy bol jest staly czy przychodzi i odchodzi?" }
    ],
    behandlung: [
        { de: "Ich verschreibe Ihnen ein Medikament.", en: "I will prescribe you a medication.", tr: "Size bir ilac yazacagim.", ar: "  .", ru: "   .", pl: "Przepisze Panu/Pani lek." },
        { de: "Bitte kommen Sie naechste Woche wieder.", en: "Please come back next week.", tr: "Lutfen gelecek hafta tekrar gelin.", ar: "   .", ru: ",    .", pl: "Prosze przyjsc w przyszlym tygodniu." },
        { de: "Sie muessen nuechtern zur Blutabnahme kommen.", en: "You need to come fasting for the blood test.", tr: "Kan testi icin ac karnina gelmelisiniz.", ar: "     .", ru: "      .", pl: "Musi Pan/Pani przyjsc na czczo na badanie krwi." }
    ],
    termin: [
        { de: "Ihr naechster Termin ist am...", en: "Your next appointment is on...", tr: "Bir sonraki randevunuz...", ar: "  ...", ru: "  ...", pl: "Pana/Pani nastepna wizyta jest..." },
        { de: "Moechten Sie den Termin verschieben?", en: "Would you like to reschedule?", tr: "Randevunuzu ertelemek ister misiniz?", ar: "   ", ru: "  ?", pl: "Czy chcialby Pan/chcialaby Pani przesunac wizyte?" }
    ],
    rezept: [
        { de: "Ihr Rezept liegt an der Rezeption bereit.", en: "Your prescription is ready at the reception.", tr: "Recetiniz resepsiyonda hazir.", ar: "   .", ru: "    .", pl: "Recepta czeka na Pana/Pania w recepcji." },
        { de: "Das Rezept ist 3 Monate gueltig.", en: "The prescription is valid for 3 months.", tr: "Recete 3 ay gecerlidir.", ar: "   3 .", ru: "  3 .", pl: "Recepta jest wazna przez 3 miesiace." }
    ]
};

function initUebersetzer() {
    var uebersetzenBtn = document.getElementById("btn-ue-uebersetzen");
    if (!uebersetzenBtn) return;

    uebersetzenBtn.addEventListener("click", uebersetzen);

    var tauschBtn = document.getElementById("btn-ue-tauschen");
    if (tauschBtn) tauschBtn.addEventListener("click", function () {
        var von = document.getElementById("ue-sprache-von");
        var nach = document.getElementById("ue-sprache-nach");
        var tmp = von.value; von.value = nach.value; nach.value = tmp;
    });

    var vorlesenBtn = document.getElementById("btn-ue-vorlesen");
    if (vorlesenBtn) vorlesenBtn.addEventListener("click", function () {
        var ausgabe = document.getElementById("ue-ausgabe");
        if (ausgabe && ausgabe.textContent) {
            var nach = document.getElementById("ue-sprache-nach");
            var langMap = { de: "de-DE", en: "en-US", tr: "tr-TR", ar: "ar-SA", ru: "ru-RU", pl: "pl-PL" };
            var utt = new SpeechSynthesisUtterance(ausgabe.textContent);
            utt.lang = langMap[nach.value] || "de-DE";
            window.speechSynthesis.speak(utt);
        }
    });

    var kopierenBtn = document.getElementById("btn-ue-kopieren");
    if (kopierenBtn) kopierenBtn.addEventListener("click", function () {
        var ausgabe = document.getElementById("ue-ausgabe");
        if (ausgabe && navigator.clipboard) {
            navigator.clipboard.writeText(ausgabe.textContent);
            kopierenBtn.textContent = "Kopiert!";
            setTimeout(function () { kopierenBtn.innerHTML = '<i class="fa-solid fa-copy"></i> Kopieren'; }, 2000);
        }
    });

    // Mikrofon fuer Uebersetzer
    var mikBtn = document.getElementById("btn-ue-mikrofon");
    if (mikBtn) {
        var SpeechRec = typeof window !== "undefined" && (window.SpeechRecognition || window.webkitSpeechRecognition);
        if (SpeechRec) {
            var rec = new SpeechRec();
            rec.continuous = false;
            rec.interimResults = false;
            var isRec = false;
            mikBtn.addEventListener("click", function () {
                if (isRec) { rec.stop(); return; }
                var von = document.getElementById("ue-sprache-von");
                var langMap = { de: "de-DE", en: "en-US", tr: "tr-TR", ar: "ar-SA", ru: "ru-RU", pl: "pl-PL" };
                rec.lang = langMap[von.value] || "de-DE";
                isRec = true;
                mikBtn.classList.add("recording");
                rec.start();
            });
            rec.onresult = function (e) {
                var text = e.results[0][0].transcript;
                document.getElementById("ue-eingabe").value = text;
                uebersetzen();
            };
            rec.onend = function () { isRec = false; mikBtn.classList.remove("recording"); };
            rec.onerror = function () { isRec = false; mikBtn.classList.remove("recording"); };
        }
    }

    // Phrasen laden
    initPhrasen();
}

function uebersetzen() {
    var eingabe = document.getElementById("ue-eingabe").value.trim();
    var von = document.getElementById("ue-sprache-von").value;
    var nach = document.getElementById("ue-sprache-nach").value;
    var ausgabe = document.getElementById("ue-ausgabe");
    if (!eingabe || !ausgabe) return;

    // Im Live-Modus: LLM-Uebersetzung nutzen
    if (MED_LLM_VERFUEGBAR) {
        ausgabe.textContent = "Uebersetze...";
        uebersetzenLlm(eingabe, von, nach, ausgabe);
        return;
    }

    // Demo-Modus: Phrasen-Suche + Fallback
    uebersetzenDemo(eingabe, von, nach, ausgabe);
}

function uebersetzenLlm(eingabe, von, nach, ausgabe) {
    var xhr = new XMLHttpRequest();
    xhr.open("POST", API_BASE + "/uebersetzen", true);
    xhr.setRequestHeader("Content-Type", "application/json");
    xhr.timeout = 30000;
    xhr.onload = function () {
        if (xhr.status === 200) {
            try {
                var daten = JSON.parse(xhr.responseText);
                ausgabe.textContent = daten.uebersetzung || eingabe;
            } catch (e) {
                // Fallback auf Demo
                uebersetzenDemo(eingabe, von, nach, ausgabe);
            }
        } else {
            uebersetzenDemo(eingabe, von, nach, ausgabe);
        }
        ueVerlaufSpeichern(eingabe, ausgabe.textContent, von, nach);
    };
    xhr.onerror = function () {
        uebersetzenDemo(eingabe, von, nach, ausgabe);
        ueVerlaufSpeichern(eingabe, ausgabe.textContent, von, nach);
    };
    xhr.send(JSON.stringify({ text: eingabe, von: von, nach: nach, branche: MED_BRANCHE_KEY, firmen_name: MED_FIRMEN_NAME }));
}

function uebersetzenDemo(eingabe, von, nach, ausgabe) {
    // Suche in den medizinischen Phrasen
    var gefunden = null;
    var kategorien = Object.keys(medPhrases);
    for (var k = 0; k < kategorien.length; k++) {
        var phrasen = medPhrases[kategorien[k]];
        for (var p = 0; p < phrasen.length; p++) {
            if (phrasen[p][von] && phrasen[p][von].toLowerCase() === eingabe.toLowerCase()) {
                gefunden = phrasen[p][nach] || phrasen[p].en || eingabe;
                break;
            }
        }
        if (gefunden) break;
    }

    if (gefunden) {
        ausgabe.textContent = gefunden;
    } else {
        var demoUe = {
            "de-en": { "hallo": "hello", "ja": "yes", "nein": "no", "danke": "thank you", "bitte": "please", "schmerzen": "pain", "kopf": "head", "bauch": "stomach", "termin": "appointment", "arzt": "doctor", "medikament": "medication", "rezept": "prescription" },
            "de-tr": { "hallo": "merhaba", "ja": "evet", "nein": "hayir", "danke": "tesekkurler", "bitte": "lutfen", "schmerzen": "agri", "termin": "randevu", "arzt": "doktor" }
        };
        var key = von + "-" + nach;
        var woerter = eingabe.toLowerCase().split(" ");
        var uebersetzt = [];
        var dict = demoUe[key] || {};
        for (var w = 0; w < woerter.length; w++) {
            uebersetzt.push(dict[woerter[w]] || woerter[w]);
        }
        ausgabe.textContent = uebersetzt.join(" ");
        if (Object.keys(dict).length === 0) {
            ausgabe.textContent = "[Demo] " + eingabe + " (" + von + "  " + nach + ")";
        }
    }

    ueVerlaufSpeichern(eingabe, ausgabe.textContent, von, nach);
}

function ueVerlaufSpeichern(eingabe, uebersetzung, von, nach) {
    var verlauf = dbLaden("ue_verlauf");
    verlauf.unshift({ original: eingabe, uebersetzung: uebersetzung, von: von, nach: nach, zeit: new Date().toLocaleTimeString("de-DE") });
    if (verlauf.length > 20) verlauf = verlauf.slice(0, 20);
    dbSpeichern("ue_verlauf", verlauf);
    ueVerlaufAktualisieren();
}

function ueVerlaufAktualisieren() {
    var tabelle = document.getElementById("ue-verlauf-tabelle");
    if (!tabelle) return;
    var tbody = tabelle.querySelector("tbody");
    if (!tbody) return;
    var verlauf = dbLaden("ue_verlauf");
    tbody.innerHTML = "";
    for (var i = 0; i < verlauf.length; i++) {
        var v = verlauf[i];
        var tr = document.createElement("tr");
        tr.innerHTML = '<td>' + escapeHtml(v.original) + '</td><td>' + escapeHtml(v.uebersetzung) + '</td><td>' + v.von.toUpperCase() + '  ' + v.nach.toUpperCase() + '</td><td>' + escapeHtml(v.zeit) + '</td>';
        tbody.appendChild(tr);
    }
}

function initPhrasen() {
    var katBtns = document.querySelectorAll(".phrasen-kat");
    for (var i = 0; i < katBtns.length; i++) {
        katBtns[i].addEventListener("click", function () {
            for (var j = 0; j < katBtns.length; j++) katBtns[j].classList.remove("active");
            this.classList.add("active");
            phrasenAnzeigen(this.getAttribute("data-kat"));
        });
    }

    var sprachSel = document.getElementById("ue-phrasen-sprache");
    if (sprachSel) sprachSel.addEventListener("change", function () {
        var aktiveKat = document.querySelector(".phrasen-kat.active");
        phrasenAnzeigen(aktiveKat ? aktiveKat.getAttribute("data-kat") : "begruessung");
    });

    phrasenAnzeigen("begruessung");
    ueVerlaufAktualisieren();
}

function phrasenAnzeigen(kategorie) {
    var liste = document.getElementById("phrasen-liste");
    var sprachSel = document.getElementById("ue-phrasen-sprache");
    if (!liste || !sprachSel) return;
    var sprache = sprachSel.value;
    var phrasen = medPhrases[kategorie] || [];
    liste.innerHTML = "";
    for (var i = 0; i < phrasen.length; i++) {
        var p = phrasen[i];
        var div = document.createElement("div");
        div.className = "phrase-card";
        div.innerHTML = '<div class="phrase-de">' + escapeHtml(p.de) + '</div><div class="phrase-uebersetzt">' + escapeHtml(p[sprache] || p.en) + '</div><div class="phrase-actions"><button type="button" class="btn-sm" onclick="phraseVorlesen(\'' + escapeHtml(p[sprache] || p.en).replace(/'/g, "\\'") + '\',\'' + sprache + '\')"><i class="fa-solid fa-volume-high"></i></button><button type="button" class="btn-sm" onclick="phraseUebernehmen(\'' + escapeHtml(p.de).replace(/'/g, "\\'") + '\')"><i class="fa-solid fa-arrow-right"></i></button></div>';
        liste.appendChild(div);
    }
}

function phraseVorlesen(text, sprache) {
    if (!window.speechSynthesis) return;
    var langMap = { en: "en-US", tr: "tr-TR", ar: "ar-SA", ru: "ru-RU", pl: "pl-PL" };
    var utt = new SpeechSynthesisUtterance(text);
    utt.lang = langMap[sprache] || "en-US";
    window.speechSynthesis.speak(utt);
}

function phraseUebernehmen(text) {
    var eingabe = document.getElementById("ue-eingabe");
    if (eingabe) { eingabe.value = text; uebersetzen(); }
}

// ===== Standort & ACD =====

var WOCHENTAGE = ["Montag", "Dienstag", "Mittwoch", "Donnerstag", "Freitag", "Samstag", "Sonntag"];
var ACD_MODUS_LABEL = { alle_annehmen: "Alle Anrufe annehmen", klingeln_dann_bot: "Klingeln, dann Bot", bot_direkt: "Bot direkt" };

function standardZeitplan() {
    return WOCHENTAGE.map(function (tag, i) {
        return { tag: tag, aktiv: i < 5, von: "08:00", bis: "18:00", modus: "klingeln_dann_bot", pause_von: "12:00", pause_bis: "13:00", pause_modus: "bot_direkt" };
    });
}

function acdConfigLaden() { try { var d = localStorage.getItem("med_acd_config"); return d ? JSON.parse(d) : null; } catch (e) { return null; } }
function acdConfigSpeichern(c) { localStorage.setItem("med_acd_config", JSON.stringify(c)); }
function zeitplanLaden() { try { var d = localStorage.getItem("med_zeitplan"); return d ? JSON.parse(d) : standardZeitplan(); } catch (e) { return standardZeitplan(); } }
function zeitplanSpeichern(p) { localStorage.setItem("med_zeitplan", JSON.stringify(p)); }

function standortleitungLaden() { return dbLaden("standortleitung"); }
function standortleitungSpeichernApi(daten) { var l = dbLaden("standortleitung"); daten.id = dbNaechsteId("standortleitung"); daten.status = daten.status || "offline"; l.push(daten); dbSpeichern("standortleitung", l); return daten; }
function standortleitungAktualisierenApi(id, daten) { dbAktualisieren("standortleitung", parseInt(id), daten); return daten; }
function standortleitungLoeschenApi(id) { dbLoeschen("standortleitung", parseInt(id)); return { erfolg: true }; }
function standortleitungStatusSetzen(id, status) { dbAktualisieren("standortleitung", parseInt(id), { status: status }); return { erfolg: true }; }

function demoStandortdatenLaden() {
    if (localStorage.getItem("med_standort_geladen")) return;
    dbSpeichern("standortleitung", [
        { id: 1, name: "Dr. Sabine Gross", rolle: "standortleitung", nebenstelle: "300", sip_passwort: "sl300", warteschlange: "alle", telefon: "0170-9876543", email: "s.gross@praxis.de", status: "online" },
        { id: 2, name: "Frank Weber", rolle: "teamleiter", nebenstelle: "301", sip_passwort: "tl301", warteschlange: "rezeption", telefon: "0171-1234567", email: "f.weber@praxis.de", status: "online" }
    ]);
    if (!acdConfigLaden()) acdConfigSpeichern({ modus: "klingeln_dann_bot", klingelanzahl: 3, klingel_timeout: 15, verteilung: "alle_gleichzeitig" });
    localStorage.setItem("med_standort_geladen", "1");
}

function aktuellenAcdModusErmitteln() {
    var config = acdConfigLaden() || { modus: "klingeln_dann_bot" };
    var plan = zeitplanLaden();
    var jetzt = new Date();
    var jsTag = jetzt.getDay();
    var tagIdx = jsTag === 0 ? 6 : jsTag - 1;
    var tag = plan[tagIdx];
    if (!tag || !tag.aktiv) return { modus: config.modus, quelle: "Standard (Tag inaktiv)" };
    var zeit = ("0" + jetzt.getHours()).slice(-2) + ":" + ("0" + jetzt.getMinutes()).slice(-2);
    if (tag.pause_von && tag.pause_bis && zeit >= tag.pause_von && zeit < tag.pause_bis) return { modus: tag.pause_modus, quelle: tag.tag + " Pause (" + tag.pause_von + "-" + tag.pause_bis + ")" };
    if (zeit >= tag.von && zeit < tag.bis) return { modus: tag.modus, quelle: tag.tag + " (" + tag.von + "-" + tag.bis + ")" };
    return { modus: config.modus, quelle: "Standard (ausserhalb Oeffnungszeiten)" };
}

function initBranchenAuswahl() {
    var container = document.getElementById("branche-auswahl");
    if (!container) return;

    // Select bauen
    var select = document.getElementById("branche-select");
    var nameInput = document.getElementById("branche-firmenname");
    if (!select) return;

    // Optionen einfuegen
    var keys = Object.keys(BRANCHEN);
    select.innerHTML = "";
    for (var i = 0; i < keys.length; i++) {
        var opt = document.createElement("option");
        opt.value = keys[i];
        opt.textContent = BRANCHEN[keys[i]].label;
        if (keys[i] === MED_BRANCHE_KEY) opt.selected = true;
        select.appendChild(opt);
    }
    if (nameInput) nameInput.value = MED_FIRMEN_NAME;

    // Vorschau
    brancheVorschauRendern(MED_BRANCHE_KEY);
    select.addEventListener("change", function () { brancheVorschauRendern(select.value); });

    // Speichern
    var btnSpeichern = document.getElementById("btn-branche-speichern");
    if (btnSpeichern) btnSpeichern.addEventListener("click", function () {
        var key = select.value;
        var firmenName = nameInput ? nameInput.value.trim() : "";
        brancheSpeichern(key, firmenName);
        var erfolg = document.getElementById("branche-erfolg");
        if (erfolg) {
            erfolg.textContent = "Branche gespeichert: " + BRANCHEN[key].label + (firmenName ? " (" + firmenName + ")" : "") + ". Seite wird neu geladen...";
            erfolg.hidden = false;
            setTimeout(function () { location.reload(); }, 1500);
        }
    });
}

function brancheVorschauRendern(key) {
    var vorschau = document.getElementById("branche-vorschau");
    if (!vorschau) return;
    var b = BRANCHEN[key] || BRANCHEN.allgemein;
    vorschau.innerHTML =
        '<div style="display:grid;grid-template-columns:1fr 1fr;gap:0.5rem;font-size:0.85rem">' +
        '<div><strong>Buero-Typ:</strong> ' + escapeHtmlSafe(b.buero_name) + '</div>' +
        '<div><strong>Verwaltung:</strong> ' + escapeHtmlSafe(b.verwaltung) + '</div>' +
        '<div><strong>Assistent:</strong> ' + escapeHtmlSafe(b.assistent) + '</div>' +
        '<div><strong>Kunden:</strong> ' + escapeHtmlSafe(b.kunden) + '</div>' +
        '<div><strong>Mitarbeiter:</strong> ' + escapeHtmlSafe(b.mitarbeiter) + '</div>' +
        '<div><strong>Dienste:</strong> ' + escapeHtmlSafe(b.dienste.join(", ")) + '</div>' +
        (b.notfall ? '<div style="grid-column:1/-1;color:#dc2626"><strong>Notfall:</strong> ' + escapeHtmlSafe(b.notfall) + '</div>' : '') +
        '</div>';
}

function initStandortSeite() {
    var acdAuswahl = document.getElementById("acd-modus-auswahl");
    if (!acdAuswahl) return;
    demoStandortdatenLaden();
    initBranchenAuswahl();

    // Standort-Info
    var infoForm = document.getElementById("standort-info-form");
    if (infoForm) {
        try { var info = JSON.parse(localStorage.getItem("med_standort_info") || "{}");
            if (info.name) document.getElementById("standort-name").value = info.name;
            if (info.telefon) document.getElementById("standort-telefon").value = info.telefon;
            if (info.strasse) document.getElementById("standort-strasse").value = info.strasse;
            if (info.notfall) document.getElementById("standort-notfall").value = info.notfall;
        } catch (e) {}
        infoForm.addEventListener("submit", function (e) {
            e.preventDefault();
            localStorage.setItem("med_standort_info", JSON.stringify({ name: document.getElementById("standort-name").value, telefon: document.getElementById("standort-telefon").value, strasse: document.getElementById("standort-strasse").value, notfall: document.getElementById("standort-notfall").value }));
            var erfolg = document.getElementById("standort-info-erfolg");
            if (erfolg) { erfolg.textContent = "Standort gespeichert!"; erfolg.hidden = false; setTimeout(function () { erfolg.hidden = true; }, 3000); }
        });
    }

    // ACD-Modus
    var config = acdConfigLaden() || { modus: "klingeln_dann_bot", klingelanzahl: 3, klingel_timeout: 15, verteilung: "alle_gleichzeitig" };
    var karten = acdAuswahl.querySelectorAll(".acd-modus-karte");
    karten.forEach(function (k) {
        if (k.getAttribute("data-modus") === config.modus) k.classList.add("selected"); else k.classList.remove("selected");
        k.addEventListener("click", function () { karten.forEach(function (x) { x.classList.remove("selected"); }); k.classList.add("selected"); });
    });
    var kaEl = document.getElementById("acd-klingelanzahl"), ktEl = document.getElementById("acd-klingel-timeout"), vEl = document.getElementById("acd-verteilung");
    if (kaEl) kaEl.value = config.klingelanzahl || 3;
    if (ktEl) ktEl.value = config.klingel_timeout || 15;
    if (vEl) vEl.value = config.verteilung || "alle_gleichzeitig";

    var btnAcd = document.getElementById("btn-acd-speichern");
    if (btnAcd) btnAcd.addEventListener("click", function () {
        var sel = acdAuswahl.querySelector(".acd-modus-karte.selected");
        var modus = sel ? sel.getAttribute("data-modus") : "klingeln_dann_bot";
        acdConfigSpeichern({ modus: modus, klingelanzahl: parseInt(kaEl.value) || 3, klingel_timeout: parseInt(ktEl.value) || 15, verteilung: vEl.value });
        var erfolg = document.getElementById("acd-modus-erfolg");
        if (erfolg) { erfolg.textContent = "ACD-Modus gespeichert: " + ACD_MODUS_LABEL[modus]; erfolg.hidden = false; setTimeout(function () { erfolg.hidden = true; }, 3000); }
        acdLiveStatusRendern();
    });

    initZeitplan();
    initStandortleitungBoard();
    acdLiveStatusRendern();
    acdStatistikenDemo();
}

function initZeitplan() {
    var tbody = document.getElementById("zeitplan-body");
    if (!tbody) return;
    var plan = zeitplanLaden();
    tbody.innerHTML = "";
    plan.forEach(function (tag, idx) {
        var tr = document.createElement("tr");
        if (!tag.aktiv) tr.className = "zeitplan-tag-inaktiv";
        tr.innerHTML =
            '<td><strong>' + escapeHtml(tag.tag) + '</strong></td>' +
            '<td><input type="checkbox" class="zp-aktiv" ' + (tag.aktiv ? "checked" : "") + '></td>' +
            '<td><input type="time" class="zp-von" value="' + (tag.von || "08:00") + '"' + (tag.aktiv ? "" : " disabled") + '></td>' +
            '<td><input type="time" class="zp-bis" value="' + (tag.bis || "18:00") + '"' + (tag.aktiv ? "" : " disabled") + '></td>' +
            '<td><select class="zp-modus"' + (tag.aktiv ? "" : " disabled") + '><option value="alle_annehmen"' + (tag.modus === "alle_annehmen" ? " selected" : "") + '>Alle annehmen</option><option value="klingeln_dann_bot"' + (tag.modus === "klingeln_dann_bot" ? " selected" : "") + '>Klingeln+Bot</option><option value="bot_direkt"' + (tag.modus === "bot_direkt" ? " selected" : "") + '>Bot direkt</option></select></td>' +
            '<td><input type="time" class="zp-pause-von" value="' + (tag.pause_von || "12:00") + '"' + (tag.aktiv ? "" : " disabled") + '></td>' +
            '<td><input type="time" class="zp-pause-bis" value="' + (tag.pause_bis || "13:00") + '"' + (tag.aktiv ? "" : " disabled") + '></td>' +
            '<td><select class="zp-pause-modus"' + (tag.aktiv ? "" : " disabled") + '><option value="alle_annehmen"' + (tag.pause_modus === "alle_annehmen" ? " selected" : "") + '>Alle annehmen</option><option value="klingeln_dann_bot"' + (tag.pause_modus === "klingeln_dann_bot" ? " selected" : "") + '>Klingeln+Bot</option><option value="bot_direkt"' + (tag.pause_modus === "bot_direkt" ? " selected" : "") + '>Bot direkt</option></select></td>';
        var cb = tr.querySelector(".zp-aktiv");
        cb.addEventListener("change", function () {
            tr.querySelectorAll("input:not(.zp-aktiv), select").forEach(function (f) { f.disabled = !cb.checked; });
            tr.className = cb.checked ? "" : "zeitplan-tag-inaktiv";
        });
        tbody.appendChild(tr);
    });

    var btnSpeichern = document.getElementById("btn-zeitplan-speichern");
    if (btnSpeichern) btnSpeichern.addEventListener("click", function () {
        var neuerPlan = [];
        tbody.querySelectorAll("tr").forEach(function (tr, idx) {
            neuerPlan.push({ tag: WOCHENTAGE[idx], aktiv: tr.querySelector(".zp-aktiv").checked, von: tr.querySelector(".zp-von").value, bis: tr.querySelector(".zp-bis").value, modus: tr.querySelector(".zp-modus").value, pause_von: tr.querySelector(".zp-pause-von").value, pause_bis: tr.querySelector(".zp-pause-bis").value, pause_modus: tr.querySelector(".zp-pause-modus").value });
        });
        zeitplanSpeichern(neuerPlan);
        var erfolg = document.getElementById("zeitplan-erfolg");
        if (erfolg) { erfolg.textContent = "Zeitplan gespeichert!"; erfolg.hidden = false; setTimeout(function () { erfolg.hidden = true; }, 3000); }
        acdLiveStatusRendern();
    });

    var btnReset = document.getElementById("btn-zeitplan-reset");
    if (btnReset) btnReset.addEventListener("click", function () {
        if (!confirm("Zeitplan auf Standard zuruecksetzen?")) return;
        zeitplanSpeichern(standardZeitplan());
        initZeitplan();
        acdLiveStatusRendern();
    });
}

function acdLiveStatusRendern() {
    var container = document.getElementById("acd-live-status");
    if (!container) return;
    var aktuell = aktuellenAcdModusErmitteln();
    var config = acdConfigLaden() || {};
    var onAg = dbLaden("agenten").filter(function (a) { return a.status === "online"; }).length;
    var onSl = standortleitungLaden().filter(function (s) { return s.status === "online"; }).length;
    var mc = aktuell.modus === "alle_annehmen" ? "modus-alle" : aktuell.modus === "klingeln_dann_bot" ? "modus-klingeln" : "modus-bot";
    container.innerHTML =
        '<div class="acd-live-box"><h3><i class="fa-solid fa-signal"></i> Aktiver Modus</h3><span class="acd-live-modus ' + mc + '"><i class="fa-solid fa-circle" style="font-size:0.5rem"></i> ' + escapeHtml(ACD_MODUS_LABEL[aktuell.modus] || aktuell.modus) + '</span><p style="margin-top:0.5rem;font-size:0.8rem;color:#64748b">Quelle: ' + escapeHtml(aktuell.quelle) + '</p></div>' +
        '<div class="acd-live-box"><h3><i class="fa-solid fa-users"></i> Verfuegbare Teilnehmer</h3><p style="font-size:0.9rem"><strong>' + onAg + '</strong> Agenten online</p><p style="font-size:0.9rem"><strong>' + onSl + '</strong> Leitung/Teamleiter online</p><p style="font-size:0.8rem;color:#64748b;margin-top:0.5rem">Verteilung: ' + escapeHtml(config.verteilung || "alle_gleichzeitig") + '</p></div>';
}

function initStandortleitungBoard() {
    var form = document.getElementById("standortleitung-form");
    if (!form) return;
    standortleitungBoardRendern();
    var btnAbbr = document.getElementById("btn-sl-abbrechen");
    if (btnAbbr) btnAbbr.addEventListener("click", function () { slFormReset(); });

    form.addEventListener("submit", function (e) {
        e.preventDefault();
        var editId = document.getElementById("sl-id").value;
        var daten = { name: document.getElementById("sl-name").value, rolle: document.getElementById("sl-rolle").value, nebenstelle: document.getElementById("sl-nebenstelle").value, sip_passwort: document.getElementById("sl-sip-passwort").value, warteschlange: document.getElementById("sl-warteschlange").value, telefon: document.getElementById("sl-telefon").value, email: document.getElementById("sl-email").value };
        var erfolgDiv = document.getElementById("sl-erfolg"), fehlerDiv = document.getElementById("sl-fehler");
        if (!daten.name || !daten.nebenstelle || !daten.sip_passwort) { fehlerDiv.textContent = "Name, Nebenstelle und SIP-Passwort sind Pflicht."; fehlerDiv.hidden = false; erfolgDiv.hidden = true; return; }
        if (editId) { standortleitungAktualisierenApi(editId, daten); erfolgDiv.textContent = "Aktualisiert!"; }
        else { standortleitungSpeichernApi(daten); erfolgDiv.textContent = "Gespeichert!"; }
        erfolgDiv.hidden = false; fehlerDiv.hidden = true;
        slFormReset(); standortleitungBoardRendern(); acdLiveStatusRendern();
    });
}

function slFormReset() {
    var f = document.getElementById("standortleitung-form"); if (f) f.reset();
    document.getElementById("sl-id").value = "";
    var b = document.getElementById("btn-sl-abbrechen"); if (b) b.hidden = true;
    var s = document.getElementById("btn-sl-speichern"); if (s) s.textContent = "Speichern";
}

function slBearbeiten(sl) {
    document.getElementById("sl-id").value = sl.id;
    document.getElementById("sl-name").value = sl.name;
    document.getElementById("sl-rolle").value = sl.rolle;
    document.getElementById("sl-nebenstelle").value = sl.nebenstelle;
    document.getElementById("sl-sip-passwort").value = sl.sip_passwort;
    document.getElementById("sl-warteschlange").value = sl.warteschlange || "alle";
    document.getElementById("sl-telefon").value = sl.telefon || "";
    document.getElementById("sl-email").value = sl.email || "";
    var b = document.getElementById("btn-sl-abbrechen"); if (b) b.hidden = false;
    var s = document.getElementById("btn-sl-speichern"); if (s) s.textContent = "Aktualisieren";
    document.getElementById("standortleitung-form").scrollIntoView({ behavior: "smooth" });
}

function standortleitungBoardRendern() {
    var container = document.getElementById("standortleitung-karten");
    if (!container) return;
    var liste = standortleitungLaden();
    container.innerHTML = "";
    if (liste.length === 0) { container.innerHTML = '<p style="color:#666;text-align:center;padding:2rem">Keine Standortleitung/Teamleiter angelegt.</p>'; return; }
    var SL_STATUS_LABELS = { online: "Verfuegbar", im_gespraech: "Im Gespraech", pause: "Pause", azu: "AZU", meeting: "Meeting", at_chris: "@Chris", offline: "Offline" };
    var SL_STATUS_ICONS = { online: "fa-circle", im_gespraech: "fa-phone", pause: "fa-pause", azu: "fa-graduation-cap", meeting: "fa-users", at_chris: "fa-at", offline: "fa-circle-xmark" };
    liste.forEach(function (sl) {
        var rl = sl.rolle === "standortleitung" ? "Standortleitung" : "Teamleiter";
        var slLabel = SL_STATUS_LABELS[sl.status] || sl.status;
        var k = document.createElement("div"); k.className = "agent-karte";
        k.innerHTML = '<h3><span class="agent-status-punkt ' + escapeHtml(sl.status) + '"></span>' + escapeHtml(sl.name) + '</h3>' +
            '<p><i class="fa-solid fa-user-tie"></i> ' + escapeHtml(rl) + '</p>' +
            '<p>NSt: ' + escapeHtml(sl.nebenstelle) + ' | Queue: ' + escapeHtml(sl.warteschlange || '-') + '</p>' +
            '<p>Status: <strong><i class="fa-solid ' + (SL_STATUS_ICONS[sl.status] || 'fa-circle') + '"></i> ' + escapeHtml(slLabel) + '</strong></p>' +
            (sl.telefon ? '<p><i class="fa-solid fa-mobile"></i> ' + escapeHtml(sl.telefon) + '</p>' : '') +
            '<div class="agent-aktionen">' +
                '<button class="btn-online" title="Verfuegbar"><i class="fa-solid fa-circle"></i> Frei</button>' +
                '<button class="btn-im_gespraech" title="Im Gespraech"><i class="fa-solid fa-phone"></i> Gespraech</button>' +
                '<button class="btn-pause" title="Pause"><i class="fa-solid fa-pause"></i> Pause</button>' +
                '<button class="btn-azu" title="AZU"><i class="fa-solid fa-graduation-cap"></i> AZU</button>' +
                '<button class="btn-meeting" title="Meeting"><i class="fa-solid fa-users"></i> Meeting</button>' +
                '<button class="btn-at_chris" title="@Chris"><i class="fa-solid fa-at"></i> @Chris</button>' +
                '<button class="btn-offline" title="Offline"><i class="fa-solid fa-circle-xmark"></i> Offline</button>' +
            '</div>' +
            '<div style="display:flex;gap:0.25rem;margin-top:0.25rem">' +
                '<button class="btn-bearbeiten" style="font-size:0.75rem;padding:0.2rem 0.5rem"><i class="fa-solid fa-pen"></i> Bearbeiten</button>' +
                '<button class="btn-loeschen" style="font-size:0.75rem;padding:0.2rem 0.5rem;background:var(--danger)"><i class="fa-solid fa-trash"></i> Loeschen</button>' +
            '</div>';
        ["online", "im_gespraech", "pause", "azu", "meeting", "at_chris", "offline"].forEach(function (s) {
            var btn = k.querySelector(".btn-" + s);
            if (btn) btn.addEventListener("click", function () { standortleitungStatusSetzen(sl.id, s); standortleitungBoardRendern(); acdLiveStatusRendern(); });
        });
        k.querySelector(".btn-bearbeiten").addEventListener("click", function () { slBearbeiten(sl); });
        k.querySelector(".btn-loeschen").addEventListener("click", function () { if (!confirm(rl + " loeschen?")) return; standortleitungLoeschenApi(sl.id); standortleitungBoardRendern(); acdLiveStatusRendern(); });
        container.appendChild(k);
    });
}

function acdStatistikenDemo() {
    var el = function (id, v) { var e = document.getElementById(id); if (e) e.textContent = v; };
    el("acd-stat-anrufe", "47"); el("acd-stat-angenommen", "32"); el("acd-stat-bot", "12"); el("acd-stat-verpasst", "3"); el("acd-stat-wartezeit", "8s");
}

/** Exportieren fuer Tests (Node.js) */
if (typeof module !== "undefined" && module.exports) {
    module.exports = {
        berechnen, benutzerValidieren, escapeHtml, OP_SYMBOLE,
        patientValidieren, arztValidieren, terminValidieren,
        wartezeitBerechnen, STATUS_KLASSEN,
        berechnenApi,
        benutzerSpeichernApi, benutzerAktualisierenApi,
        benutzerLoeschenApi, benutzerLadenApi,
        verlaufLadenApi, verlaufLoeschenApi,
        patientenLadenApi, patientSpeichernApi,
        patientAktualisierenApi, patientLoeschenApi,
        aerzteLadenApi, arztSpeichernApi,
        arztAktualisierenApi, arztLoeschenApi,
        termineLadenApi, terminSpeichernApi,
        terminAktualisierenApi, terminLoeschenApi,
        wartezimmerLadenApi, wartezimmerCheckinApi,
        wartezimmerStatusApi, wartezimmerEntfernenApi,
        agentenLadenApi, agentSpeichernApi,
        agentAktualisierenApi, agentLoeschenApi,
        agentStatusSetzenApi, anrufeLadenApi,
        startAnrufTimer, stopAnrufTimer,
        formularZuruecksetzen, benutzerBearbeiten, benutzerZurTabelle,
        benutzerListeAktualisieren, benutzerEntfernen,
        verlaufAktualisieren,
        patientFormZuruecksetzen, patientBearbeiten, patientenListeAktualisieren,
        arztFormZuruecksetzen, arztBearbeiten, aerzteListeAktualisieren,
        terminFormZuruecksetzen, terminBearbeiten, termineListeAktualisieren,
        terminDropdownsLaden,
        wartezimmerAktualisieren, wartezimmerDropdownsLaden, wartezimmerTermineLaden,
        agentFormZuruecksetzen, agentBearbeiten, agentenBoardAktualisieren,
        aktiveAnrufeAktualisieren, anrufprotokollAktualisieren,
        sprachAusgabe, callflowDaten: callflowDaten,
        medPhrases: medPhrases, uebersetzen: typeof uebersetzen !== "undefined" ? uebersetzen : function () {},
        WOCHENTAGE: WOCHENTAGE, ACD_MODUS_LABEL: ACD_MODUS_LABEL,
        standardZeitplan: standardZeitplan,
        acdConfigLaden: acdConfigLaden, acdConfigSpeichern: acdConfigSpeichern,
        zeitplanLaden: zeitplanLaden, zeitplanSpeichern: zeitplanSpeichern,
        standortleitungLaden: standortleitungLaden,
        standortleitungSpeichernApi: standortleitungSpeichernApi,
        standortleitungAktualisierenApi: standortleitungAktualisierenApi,
        standortleitungLoeschenApi: standortleitungLoeschenApi,
        standortleitungStatusSetzen: standortleitungStatusSetzen,
        aktuellenAcdModusErmitteln: aktuellenAcdModusErmitteln,
    };
}

// ===== Wissensdatenbank =====

function initWissensdatenbank() {
    var btnNeu = document.getElementById("btn-kb-neu");
    var formBereich = document.getElementById("kb-formular-bereich");
    var formular = document.getElementById("kb-formular");
    var btnAbbrechen = document.getElementById("btn-kb-abbrechen");
    var suchfeld = document.getElementById("kb-suche");
    var katFilter = document.getElementById("kb-kategorie-filter");
    if (!btnNeu) return;

    var editId = null;

    function kbLaden() { return dbLaden("kb_artikel"); }
    function kbSpeichern(d) { dbSpeichern("kb_artikel", d); }

    function kbDemoLaden() {
        var artikel = kbLaden();
        if (artikel.length > 0) return;
        var demo = [
            { id: "kb1", titel: "Wie funktioniert die Terminbuchung?", kategorie: "termine", tags: "termin, buchung, online", inhalt: "Patienten koennen ueber das Web-Widget oder telefonisch Termine buchen. Der Voicebot erkennt Terminwuensche automatisch und schlaegt freie Slots vor.", botAntwort: "Sie koennen Termine online ueber unsere Webseite oder telefonisch vereinbaren. Moechten Sie einen Termin buchen?", aufrufe: 142, botNutzungen: 89, erstellt: new Date().toISOString() },
            { id: "kb2", titel: "Rezept bestellen - Ablauf", kategorie: "patienten", tags: "rezept, bestellung, wiederholung", inhalt: "Patienten koennen Folgerezepte telefonisch oder per Widget bestellen. Der Agent prueft die Patientenakte und leitet die Bestellung an den Arzt weiter.", botAntwort: "Fuer ein Folgerezept benoetigen wir Ihren Namen und die Versichertennummer. Welches Medikament benoetigen Sie?", aufrufe: 98, botNutzungen: 45, erstellt: new Date().toISOString() },
            { id: "kb3", titel: "Notfallnummern und Bereitschaft", kategorie: "notfall", tags: "notfall, bereitschaft, notruf", inhalt: "Bei lebensbedrohlichen Notfaellen: 112 anrufen. Aerztlicher Bereitschaftsdienst: 116117. Unsere Praxis ist Mo-Fr 8-18 Uhr erreichbar.", botAntwort: "Bei einem Notfall rufen Sie bitte sofort die 112 an. Den aerztlichen Bereitschaftsdienst erreichen Sie unter 116117.", aufrufe: 67, botNutzungen: 34, erstellt: new Date().toISOString() },
            { id: "kb4", titel: "ACD-Modi erklaert", kategorie: "telefonie", tags: "acd, telefonie, modus, bot", inhalt: "Es gibt 3 ACD-Modi: 1) Alle annehmen - Telefon klingelt bei allen Agenten. 2) Klingeln dann Bot - Nach X Klingeln uebernimmt der Voicebot. 3) Bot direkt - Voicebot nimmt sofort entgegen.", botAntwort: "Unsere Telefonanlage verteilt Anrufe automatisch an freie Mitarbeiter. Bei Wartezeiten uebernimmt unser KI-Assistent.", aufrufe: 23, botNutzungen: 5, erstellt: new Date().toISOString() },
            { id: "kb5", titel: "Oeffnungszeiten und Sprechstunden", kategorie: "praxisablauf", tags: "oeffnungszeiten, sprechstunde, zeiten", inhalt: "Mo-Fr: 8:00-12:00 und 14:00-18:00 Uhr. Mittwochnachmittag geschlossen. Samstag nach Vereinbarung.", botAntwort: "Unsere Sprechzeiten sind Montag bis Freitag von 8 bis 12 und 14 bis 18 Uhr. Mittwochnachmittag ist geschlossen.", aufrufe: 234, botNutzungen: 178, erstellt: new Date().toISOString() },
            { id: "kb6", titel: "Abrechnung und Privatpatienten", kategorie: "abrechnung", tags: "abrechnung, privat, kasse, igel", inhalt: "Kassenpatienten: Chipkarte mitbringen. Privatpatienten: Rechnung nach GOAe. IGeL-Leistungen werden vor Behandlung besprochen und schriftlich vereinbart.", botAntwort: "Bitte bringen Sie Ihre Versichertenkarte mit. Fuer Fragen zur Abrechnung verbinde ich Sie gerne mit der Rezeption.", aufrufe: 56, botNutzungen: 12, erstellt: new Date().toISOString() }
        ];
        kbSpeichern(demo);
    }

    var KAT_LABELS = { telefonie: "Telefonie & ACD", patienten: "Patienten", termine: "Termine", abrechnung: "Abrechnung", praxisablauf: "Praxisablauf", notfall: "Notfall", technik: "Technik" };
    var KAT_FARBEN = { telefonie: "#0891b2", patienten: "#7c3aed", termine: "#2563eb", abrechnung: "#059669", praxisablauf: "#d97706", notfall: "#dc2626", technik: "#64748b" };

    function statsAktualisieren() {
        var artikel = kbLaden();
        var el = function (id, val) { var e = document.getElementById(id); if (e) e.textContent = val; };
        el("kb-stat-artikel", artikel.length);
        var kats = {};
        var aufrufe = 0;
        var bot = 0;
        artikel.forEach(function (a) {
            kats[a.kategorie] = true;
            aufrufe += (a.aufrufe || 0);
            bot += (a.botNutzungen || 0);
        });
        el("kb-stat-kategorien", Object.keys(kats).length);
        el("kb-stat-aufrufe", aufrufe);
        el("kb-stat-bot", bot);
    }

    function artikelAnzeigen() {
        var liste = document.getElementById("kb-artikel-liste");
        if (!liste) return;
        var artikel = kbLaden();
        var suche = (suchfeld ? suchfeld.value.toLowerCase() : "");
        var kat = (katFilter ? katFilter.value : "");

        var gefiltert = artikel.filter(function (a) {
            if (kat && a.kategorie !== kat) return false;
            if (suche) {
                var text = (a.titel + " " + a.tags + " " + a.inhalt).toLowerCase();
                if (text.indexOf(suche) === -1) return false;
            }
            return true;
        });

        if (gefiltert.length === 0) {
            liste.innerHTML = '<p style="text-align:center;color:var(--text-muted);padding:2rem">Keine Artikel gefunden.</p>';
            return;
        }

        liste.innerHTML = "";
        gefiltert.forEach(function (a) {
            var farbe = KAT_FARBEN[a.kategorie] || "#64748b";
            var katLabel = KAT_LABELS[a.kategorie] || a.kategorie;
            var div = document.createElement("div");
            div.style.cssText = "border:1px solid var(--border);border-radius:var(--radius);padding:1rem;margin-bottom:0.75rem;background:var(--card);";
            div.innerHTML =
                '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0.5rem">' +
                    '<div><strong style="font-size:0.95rem">' + escapeHtml(a.titel) + '</strong>' +
                    '<div style="margin-top:0.3rem"><span style="display:inline-block;padding:0.15rem 0.5rem;border-radius:4px;font-size:0.75rem;color:#fff;background:' + farbe + '">' + escapeHtml(katLabel) + '</span>' +
                    (a.tags ? ' <span style="font-size:0.75rem;color:var(--text-muted)">' + escapeHtml(a.tags) + '</span>' : '') +
                    '</div></div>' +
                    '<div style="display:flex;gap:0.3rem">' +
                        '<button type="button" onclick="kbBearbeiten(\'' + a.id + '\')" style="padding:0.3rem 0.6rem;border-radius:4px;background:var(--primary);color:#fff;border:none;font-size:0.75rem;cursor:pointer"><i class="fa-solid fa-pen"></i></button>' +
                        '<button type="button" onclick="kbLoeschen(\'' + a.id + '\')" style="padding:0.3rem 0.6rem;border-radius:4px;background:var(--danger);color:#fff;border:none;font-size:0.75rem;cursor:pointer"><i class="fa-solid fa-trash"></i></button>' +
                    '</div>' +
                '</div>' +
                '<p style="font-size:0.85rem;color:var(--text-muted);line-height:1.5;margin-bottom:0.5rem">' + escapeHtml(a.inhalt).substring(0, 200) + (a.inhalt.length > 200 ? '...' : '') + '</p>' +
                (a.botAntwort ? '<div style="background:var(--bg);padding:0.5rem 0.75rem;border-radius:6px;font-size:0.8rem;border-left:3px solid var(--primary)"><i class="fa-solid fa-robot" style="color:var(--primary)"></i> <strong>Bot:</strong> ' + escapeHtml(a.botAntwort).substring(0, 120) + '</div>' : '') +
                '<div style="display:flex;gap:1rem;margin-top:0.5rem;font-size:0.75rem;color:var(--text-muted)">' +
                    '<span><i class="fa-solid fa-eye"></i> ' + (a.aufrufe || 0) + ' Aufrufe</span>' +
                    '<span><i class="fa-solid fa-robot"></i> ' + (a.botNutzungen || 0) + ' Bot-Antworten</span>' +
                '</div>';
            liste.appendChild(div);
        });
        statsAktualisieren();
    }

    btnNeu.addEventListener("click", function () {
        editId = null;
        document.getElementById("kb-formular-titel").innerHTML = '<i class="fa-solid fa-pen"></i> Neuen Artikel erstellen';
        formular.reset();
        formBereich.hidden = false;
    });

    btnAbbrechen.addEventListener("click", function () {
        formBereich.hidden = true;
        editId = null;
    });

    formular.addEventListener("submit", function (e) {
        e.preventDefault();
        var artikel = kbLaden();
        var obj = {
            id: editId || "kb" + Date.now(),
            titel: document.getElementById("kb-titel").value.trim(),
            kategorie: document.getElementById("kb-kat").value,
            tags: document.getElementById("kb-tags").value.trim(),
            inhalt: document.getElementById("kb-inhalt").value.trim(),
            botAntwort: document.getElementById("kb-bot-antwort").value.trim(),
            aufrufe: 0,
            botNutzungen: 0,
            erstellt: new Date().toISOString()
        };
        if (editId) {
            for (var i = 0; i < artikel.length; i++) {
                if (artikel[i].id === editId) {
                    obj.aufrufe = artikel[i].aufrufe;
                    obj.botNutzungen = artikel[i].botNutzungen;
                    artikel[i] = obj;
                    break;
                }
            }
        } else {
            artikel.push(obj);
        }
        kbSpeichern(artikel);
        formBereich.hidden = true;
        editId = null;
        artikelAnzeigen();
        var erfolg = document.getElementById("kb-erfolg");
        if (erfolg) {
            erfolg.textContent = "Artikel gespeichert!";
            erfolg.hidden = false;
            setTimeout(function () { erfolg.hidden = true; }, 2000);
        }
    });

    if (suchfeld) suchfeld.addEventListener("input", artikelAnzeigen);
    if (katFilter) katFilter.addEventListener("change", artikelAnzeigen);

    window.kbBearbeiten = function (id) {
        var artikel = kbLaden();
        var a = artikel.find(function (x) { return x.id === id; });
        if (!a) return;
        editId = id;
        document.getElementById("kb-formular-titel").innerHTML = '<i class="fa-solid fa-pen"></i> Artikel bearbeiten';
        document.getElementById("kb-titel").value = a.titel;
        document.getElementById("kb-kat").value = a.kategorie;
        document.getElementById("kb-tags").value = a.tags || "";
        document.getElementById("kb-inhalt").value = a.inhalt;
        document.getElementById("kb-bot-antwort").value = a.botAntwort || "";
        formBereich.hidden = false;
    };

    window.kbLoeschen = function (id) {
        if (!confirm("Artikel wirklich loeschen?")) return;
        var artikel = kbLaden().filter(function (a) { return a.id !== id; });
        kbSpeichern(artikel);
        artikelAnzeigen();
    };

    kbDemoLaden();
    artikelAnzeigen();
}

// ===== Ansagen Generator =====

function initAnsagenGenerator() {
    var formular = document.getElementById("ans-formular");
    var vorlagenContainer = document.getElementById("ans-vorlagen");
    var vorschauBereich = document.getElementById("ans-vorschau-bereich");
    var filterTyp = document.getElementById("ans-filter-typ");
    if (!formular) return;

    function ansLaden() { return dbLaden("ansagen"); }
    function ansSpeichern(d) { dbSpeichern("ansagen", d); }

    var VORLAGEN = {
        begruessung_standard: "Willkommen in der Praxis {praxis_name}. Wie koennen wir Ihnen helfen?",
        warteschleife_standard: "Bitte haben Sie einen Moment Geduld. Ihr Anruf ist uns wichtig und wird in Kuerze entgegengenommen.",
        ab_standard: "Sie haben die Praxis {praxis_name} erreicht. Leider koennen wir Ihren Anruf gerade nicht entgegennehmen. Bitte hinterlassen Sie eine Nachricht nach dem Signalton.",
        oeffnungszeiten_standard: "Unsere Sprechzeiten sind {oeffnungszeiten}. Ausserhalb der Sprechzeiten wenden Sie sich bitte an den aerztlichen Bereitschaftsdienst unter 116117.",
        notfall_standard: "Bei einem medizinischen Notfall rufen Sie bitte umgehend die 112 an. Den aerztlichen Bereitschaftsdienst erreichen Sie unter 116117.",
        ivr_menue: "Willkommen bei {praxis_name}. Fuer einen Termin sagen Sie bitte Termin. Fuer ein Rezept sagen Sie Rezept. Fuer alle anderen Anliegen bleiben Sie bitte in der Leitung.",
        feiertag_standard: "Frohe Feiertage! Unsere Praxis ist am {datum} geschlossen. In dringenden Faellen wenden Sie sich an den aerztlichen Bereitschaftsdienst unter 116117."
    };

    var TYP_LABELS = { begruessung: "Begruessung", warteschleife: "Warteschleife", abwesenheit: "Abwesenheit", oeffnungszeiten: "Oeffnungszeiten", notfall: "Notfall", feiertag: "Feiertag", weiterleitung: "Weiterleitung", ivr_menue: "IVR-Menue" };
    var TYP_ICONS = { begruessung: "fa-hand-wave", warteschleife: "fa-clock", abwesenheit: "fa-voicemail", oeffnungszeiten: "fa-clock", notfall: "fa-triangle-exclamation", feiertag: "fa-tree", weiterleitung: "fa-arrow-right", ivr_menue: "fa-list-ol" };

    function demoDatenLaden() {
        var ansagen = ansLaden();
        if (ansagen.length > 0) return;
        var demo = [
            { id: "ans1", name: "Hauptbegruessung", typ: "begruessung", sprache: "de", stimme: "anna", tempo: "normal", text: "Willkommen in der Praxis Dr. Schmidt. Wie koennen wir Ihnen helfen?", aktiv: true, dauer: 4, erstellt: new Date().toISOString() },
            { id: "ans2", name: "Warteschleife Standard", typ: "warteschleife", sprache: "de", stimme: "sophie", tempo: "langsam", text: "Bitte haben Sie einen Moment Geduld. Ihr Anruf wird in Kuerze entgegengenommen. Sie koennen auch gerne eine Nachricht hinterlassen.", aktiv: true, dauer: 7, erstellt: new Date().toISOString() },
            { id: "ans3", name: "Notfall-Ansage", typ: "notfall", sprache: "de", stimme: "thomas", tempo: "normal", text: "Bei einem Notfall rufen Sie bitte sofort die 112 an. Den aerztlichen Bereitschaftsdienst erreichen Sie unter 116117.", aktiv: true, dauer: 6, erstellt: new Date().toISOString() },
            { id: "ans4", name: "Oeffnungszeiten", typ: "oeffnungszeiten", sprache: "de", stimme: "anna", tempo: "normal", text: "Unsere Sprechzeiten sind Montag bis Freitag 8 bis 12 Uhr und 14 bis 18 Uhr. Mittwochnachmittag geschlossen.", aktiv: true, dauer: 5, erstellt: new Date().toISOString() },
            { id: "ans5", name: "Welcome English", typ: "begruessung", sprache: "en", stimme: "anna", tempo: "normal", text: "Welcome to Dr. Schmidt's practice. How can we help you?", aktiv: false, dauer: 3, erstellt: new Date().toISOString() }
        ];
        ansSpeichern(demo);
    }

    function statsAktualisieren() {
        var ansagen = ansLaden();
        var el = function (id, val) { var e = document.getElementById(id); if (e) e.textContent = val; };
        el("ans-stat-gesamt", ansagen.length);
        el("ans-stat-aktiv", ansagen.filter(function (a) { return a.aktiv; }).length);
    }

    function listeAnzeigen() {
        var container = document.getElementById("ans-liste");
        if (!container) return;
        var ansagen = ansLaden();
        var filter = filterTyp ? filterTyp.value : "";
        if (filter) {
            ansagen = ansagen.filter(function (a) { return a.typ === filter; });
        }

        if (ansagen.length === 0) {
            container.innerHTML = '<p style="text-align:center;color:var(--text-muted);padding:2rem">Keine Ansagen vorhanden.</p>';
            return;
        }

        container.innerHTML = "";
        ansagen.forEach(function (a) {
            var icon = TYP_ICONS[a.typ] || "fa-volume-high";
            var typLabel = TYP_LABELS[a.typ] || a.typ;
            var spracheLabel = { de: "Deutsch", en: "English", tr: "Tuerkisch", ar: "Arabisch", ru: "Russisch", fr: "Franzoesisch" }[a.sprache] || a.sprache;
            var div = document.createElement("div");
            div.style.cssText = "border:1px solid var(--border);border-radius:var(--radius);padding:1rem;margin-bottom:0.75rem;background:var(--card);display:flex;align-items:center;gap:1rem;";
            div.innerHTML =
                '<div style="width:40px;height:40px;border-radius:8px;background:' + (a.aktiv ? 'var(--primary)' : 'var(--text-muted)') + ';display:flex;align-items:center;justify-content:center;flex-shrink:0"><i class="fa-solid ' + icon + '" style="color:#fff"></i></div>' +
                '<div style="flex:1;min-width:0">' +
                    '<div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:0.25rem">' +
                        '<strong style="font-size:0.9rem">' + escapeHtml(a.name) + '</strong>' +
                        '<span style="padding:0.1rem 0.4rem;border-radius:4px;font-size:0.7rem;background:' + (a.aktiv ? '#dcfce7;color:#15803d' : '#f1f5f9;color:#94a3b8') + '">' + (a.aktiv ? 'Aktiv' : 'Inaktiv') + '</span>' +
                    '</div>' +
                    '<div style="font-size:0.8rem;color:var(--text-muted)">' + escapeHtml(typLabel) + '  ' + escapeHtml(spracheLabel) + '  ' + escapeHtml(a.stimme) + '  ~' + (a.dauer || 0) + 's</div>' +
                    '<div style="font-size:0.8rem;color:var(--text-muted);margin-top:0.2rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">' + escapeHtml(a.text).substring(0, 80) + '...</div>' +
                '</div>' +
                '<div style="display:flex;gap:0.3rem;flex-shrink:0">' +
                    '<button type="button" onclick="ansVorhoeren(\'' + a.id + '\')" style="padding:0.4rem 0.6rem;border-radius:6px;background:var(--info);color:#fff;border:none;font-size:0.75rem;cursor:pointer" title="Vorhoeren"><i class="fa-solid fa-play"></i></button>' +
                    '<button type="button" onclick="ansAktivToggle(\'' + a.id + '\')" style="padding:0.4rem 0.6rem;border-radius:6px;background:' + (a.aktiv ? 'var(--warning)' : 'var(--success)') + ';color:#fff;border:none;font-size:0.75rem;cursor:pointer" title="' + (a.aktiv ? 'Deaktivieren' : 'Aktivieren') + '"><i class="fa-solid ' + (a.aktiv ? 'fa-pause' : 'fa-check') + '"></i></button>' +
                    '<button type="button" onclick="ansLoeschen(\'' + a.id + '\')" style="padding:0.4rem 0.6rem;border-radius:6px;background:var(--danger);color:#fff;border:none;font-size:0.75rem;cursor:pointer" title="Loeschen"><i class="fa-solid fa-trash"></i></button>' +
                '</div>';
            container.appendChild(div);
        });
        statsAktualisieren();
    }

    // Vorlagen-Buttons
    if (vorlagenContainer) {
        vorlagenContainer.addEventListener("click", function (e) {
            var btn = e.target.closest("[data-vorlage]");
            if (!btn) return;
            var key = btn.dataset.vorlage;
            if (VORLAGEN[key]) {
                document.getElementById("ans-text").value = VORLAGEN[key];
            }
        });
    }

    // KI-Text generieren (Demo)
    var btnGen = document.getElementById("btn-ans-generieren");
    if (btnGen) {
        btnGen.addEventListener("click", function () {
            var typ = document.getElementById("ans-typ").value;
            var text = VORLAGEN[typ + "_standard"] || VORLAGEN.begruessung_standard;
            document.getElementById("ans-text").value = text;
        });
    }

    // Vorhoeren (Web Speech API)
    var btnVorhoeren = document.getElementById("btn-ans-vorhoeren");
    if (btnVorhoeren) {
        btnVorhoeren.addEventListener("click", function () {
            var text = document.getElementById("ans-text").value;
            if (!text) return;
            if (typeof speechSynthesis !== "undefined") {
                speechSynthesis.cancel();
                var utt = new SpeechSynthesisUtterance(text);
                utt.lang = document.getElementById("ans-sprache").value === "de" ? "de-DE" : document.getElementById("ans-sprache").value;
                var tempo = document.getElementById("ans-tempo").value;
                utt.rate = tempo === "langsam" ? 0.8 : tempo === "schnell" ? 1.3 : 1.0;
                speechSynthesis.speak(utt);
                vorschauBereich.hidden = false;
                var stimme = document.getElementById("ans-stimme");
                document.getElementById("ans-stimme-label").textContent = stimme.options[stimme.selectedIndex].text;
            }
        });
    }

    // Formular speichern
    formular.addEventListener("submit", function (e) {
        e.preventDefault();
        var ansagen = ansLaden();
        var text = document.getElementById("ans-text").value.trim();
        if (!text) return;
        var obj = {
            id: "ans" + Date.now(),
            name: document.getElementById("ans-name").value.trim() || "Neue Ansage",
            typ: document.getElementById("ans-typ").value,
            sprache: document.getElementById("ans-sprache").value,
            stimme: document.getElementById("ans-stimme").value,
            tempo: document.getElementById("ans-tempo").value,
            text: text,
            aktiv: true,
            dauer: Math.ceil(text.split(/\s+/).length / 2.5),
            erstellt: new Date().toISOString()
        };
        ansagen.push(obj);
        ansSpeichern(ansagen);
        formular.reset();
        vorschauBereich.hidden = true;
        listeAnzeigen();
        var erfolg = document.getElementById("ans-erfolg");
        if (erfolg) {
            erfolg.textContent = "Ansage gespeichert!";
            erfolg.hidden = false;
            setTimeout(function () { erfolg.hidden = true; }, 2000);
        }
    });

    if (filterTyp) filterTyp.addEventListener("change", listeAnzeigen);

    window.ansVorhoeren = function (id) {
        var a = ansLaden().find(function (x) { return x.id === id; });
        if (!a || typeof speechSynthesis === "undefined") return;
        speechSynthesis.cancel();
        var utt = new SpeechSynthesisUtterance(a.text);
        utt.lang = a.sprache === "de" ? "de-DE" : a.sprache;
        utt.rate = a.tempo === "langsam" ? 0.8 : a.tempo === "schnell" ? 1.3 : 1.0;
        speechSynthesis.speak(utt);
    };

    window.ansAktivToggle = function (id) {
        var ansagen = ansLaden();
        for (var i = 0; i < ansagen.length; i++) {
            if (ansagen[i].id === id) {
                ansagen[i].aktiv = !ansagen[i].aktiv;
                break;
            }
        }
        ansSpeichern(ansagen);
        listeAnzeigen();
    };

    window.ansLoeschen = function (id) {
        if (!confirm("Ansage wirklich loeschen?")) return;
        var ansagen = ansLaden().filter(function (a) { return a.id !== id; });
        ansSpeichern(ansagen);
        listeAnzeigen();
    };

    demoDatenLaden();
    listeAnzeigen();
}

// ===== AUSWERTUNGEN & KOSTEN =====

function initAuswertungen() {
    var container = document.getElementById("aw-agenten-body");
    if (!container) return;

    var agenten = dbLaden("agenten");

    // Demo-Daten fuer Anrufstatistik
    var DEMO_STATS = {
        heute:   { anrufe: 47, angenommen: 38, verpasst: 4, voicebot: 5, wartezeit: 8, gespraech: 195 },
        woche:   { anrufe: 312, angenommen: 267, verpasst: 22, voicebot: 23, wartezeit: 11, gespraech: 203 },
        monat:   { anrufe: 1284, angenommen: 1098, verpasst: 87, voicebot: 99, wartezeit: 13, gespraech: 198 },
        quartal: { anrufe: 3847, angenommen: 3302, verpasst: 248, voicebot: 297, wartezeit: 12, gespraech: 201 },
        jahr:    { anrufe: 15392, angenommen: 13187, verpasst: 993, voicebot: 1212, wartezeit: 11, gespraech: 200 }
    };

    // Anrufgruende
    var ANRUF_GRUENDE = [
        { grund: "Terminvergabe", prozent: 34, farbe: "var(--primary)" },
        { grund: "Rezeptbestellung", prozent: 22, farbe: "var(--success)" },
        { grund: "Befundanfrage", prozent: 15, farbe: "var(--warning)" },
        { grund: "Ueberweisung", prozent: 11, farbe: "var(--info)" },
        { grund: "Allg. Auskunft", prozent: 8, farbe: "#7c3aed" },
        { grund: "Notfall/Dringend", prozent: 6, farbe: "var(--danger)" },
        { grund: "Sonstiges", prozent: 4, farbe: "#94a3b8" }
    ];

    // Tageszeit-Erreichbarkeit
    var TAGESZEIT = [
        { zeit: "07:00-08:00", erreich: 95, anrufe: 12 },
        { zeit: "08:00-09:00", erreich: 88, anrufe: 38 },
        { zeit: "09:00-10:00", erreich: 82, anrufe: 52 },
        { zeit: "10:00-11:00", erreich: 79, anrufe: 48 },
        { zeit: "11:00-12:00", erreich: 85, anrufe: 41 },
        { zeit: "12:00-13:00", erreich: 72, anrufe: 22 },
        { zeit: "13:00-14:00", erreich: 68, anrufe: 18 },
        { zeit: "14:00-15:00", erreich: 83, anrufe: 35 },
        { zeit: "15:00-16:00", erreich: 87, anrufe: 28 },
        { zeit: "16:00-17:00", erreich: 91, anrufe: 15 },
        { zeit: "17:00-18:00", erreich: 94, anrufe: 8 }
    ];

    // EVN Demo-Daten
    var EVN_DATEN = [];
    var rufnummern = ["0171-2345678", "030-1234567", "089-9876543", "040-5551234", "0152-8765432", "0163-3456789", "0221-7654321", "069-1112233", "0711-4445566", "0351-8889900"];
    var namen = ["Hr. Weber", "Fr. Mueller", "Hr. Schmidt", "Fr. Klein", "Hr. Braun", "Fr. Fischer", "Hr. Hoffmann", "Fr. Wagner", "Hr. Becker", "Fr. Schulz"];
    var statusOptionen = ["angenommen", "angenommen", "angenommen", "angenommen", "verpasst", "voicebot", "weiterleitung"];
    var agentenNamen = agenten.map(function (a) { return a.name; });
    if (agentenNamen.length === 0) agentenNamen = ["Lisa M.", "Tom R.", "Sarah K.", "Max B."];

    for (var i = 0; i < 50; i++) {
        var d = new Date();
        d.setMinutes(d.getMinutes() - Math.floor(Math.random() * 7 * 24 * 60));
        var status = statusOptionen[Math.floor(Math.random() * statusOptionen.length)];
        var dauer = status === "verpasst" ? 0 : Math.floor(Math.random() * 420 + 15);
        var kosten = status === "voicebot" ? (Math.random() * 0.15 + 0.02).toFixed(2) : (dauer / 60 * 0.039).toFixed(2);
        EVN_DATEN.push({
            datum: d.toISOString().split("T")[0] + " " + ("0" + d.getHours()).slice(-2) + ":" + ("0" + d.getMinutes()).slice(-2),
            rufnummer: rufnummern[Math.floor(Math.random() * rufnummern.length)],
            name: namen[Math.floor(Math.random() * namen.length)],
            richtung: Math.random() > 0.15 ? "eingehend" : "ausgehend",
            agent: status === "voicebot" ? "Voicebot" : agentenNamen[Math.floor(Math.random() * agentenNamen.length)],
            dauer: dauer,
            status: status,
            kosten: kosten
        });
    }
    EVN_DATEN.sort(function (a, b) { return b.datum.localeCompare(a.datum); });

    var aktuellerZeitraum = "woche";
    var evnSeite = 0;
    var EVN_PRO_SEITE = 10;

    function kpiAktualisieren() {
        var s = DEMO_STATS[aktuellerZeitraum] || DEMO_STATS.woche;
        setText("aw-anrufe-gesamt", s.anrufe.toLocaleString("de-DE"));
        setText("aw-angenommen", s.angenommen.toLocaleString("de-DE"));
        setText("aw-verpasst", s.verpasst.toLocaleString("de-DE"));
        setText("aw-voicebot", s.voicebot.toLocaleString("de-DE"));
        setText("aw-wartezeit", s.wartezeit + "s");
        setText("aw-gespraechsdauer", Math.floor(s.gespraech / 60) + ":" + ("0" + (s.gespraech % 60)).slice(-2));
    }

    function setText(id, val) {
        var el = document.getElementById(id);
        if (el) el.textContent = val;
    }

    function chartZeichnen() {
        var chartDiv = document.getElementById("aw-chart-anrufe");
        var labelsDiv = document.getElementById("aw-chart-labels");
        if (!chartDiv) return;

        var tage = aktuellerZeitraum === "heute" ? 24 : aktuellerZeitraum === "woche" ? 7 : aktuellerZeitraum === "monat" ? 30 : aktuellerZeitraum === "quartal" ? 12 : 12;
        var labels = [];
        var daten = [];
        var wochentage = ["Mo", "Di", "Mi", "Do", "Fr", "Sa", "So"];
        var monate = ["Jan", "Feb", "Mr", "Apr", "Mai", "Jun", "Jul", "Aug", "Sep", "Okt", "Nov", "Dez"];

        for (var i = 0; i < tage; i++) {
            var ang = Math.floor(Math.random() * 30 + 20);
            var verp = Math.floor(Math.random() * 6);
            var bot = Math.floor(Math.random() * 8 + 2);
            daten.push({ angenommen: ang, verpasst: verp, voicebot: bot });

            if (aktuellerZeitraum === "heute") {
                labels.push((7 + i) + ":00");
            } else if (aktuellerZeitraum === "woche") {
                labels.push(wochentage[i % 7]);
            } else if (aktuellerZeitraum === "monat") {
                labels.push((i + 1) + ".");
            } else {
                labels.push(monate[i % 12]);
            }
        }

        var maxWert = Math.max.apply(null, daten.map(function (d) { return d.angenommen + d.verpasst + d.voicebot; }));
        if (maxWert === 0) maxWert = 1;

        var chartHtml = "";
        var labelsHtml = "";
        var barWidth = Math.max(8, Math.floor(100 / tage) - 1);

        daten.forEach(function (d, idx) {
            var gesamt = d.angenommen + d.verpasst + d.voicebot;
            var hAng = Math.round((d.angenommen / maxWert) * 180);
            var hVerp = Math.round((d.verpasst / maxWert) * 180);
            var hBot = Math.round((d.voicebot / maxWert) * 180);

            chartHtml += '<div style="flex:1;display:flex;flex-direction:column;justify-content:flex-end;align-items:center;gap:1px" title="' + labels[idx] + ': ' + gesamt + ' Anrufe">' +
                '<div style="width:100%;max-width:' + barWidth + 'px;height:' + hBot + 'px;background:var(--info);border-radius:2px 2px 0 0"></div>' +
                '<div style="width:100%;max-width:' + barWidth + 'px;height:' + hVerp + 'px;background:var(--danger)"></div>' +
                '<div style="width:100%;max-width:' + barWidth + 'px;height:' + hAng + 'px;background:var(--primary);border-radius:0 0 2px 2px"></div>' +
                '</div>';
            labelsHtml += '<div style="flex:1;text-align:center">' + labels[idx] + '</div>';
        });

        chartDiv.innerHTML = chartHtml;
        labelsDiv.innerHTML = labelsHtml;
    }

    function agentenPerformance() {
        var body = document.getElementById("aw-agenten-body");
        if (!body) return;
        body.innerHTML = "";

        var liste = agenten.length > 0 ? agenten : [
            { name: "Lisa M." }, { name: "Tom R." }, { name: "Sarah K." }, { name: "Max B." }
        ];

        liste.forEach(function (a) {
            var anrufe = Math.floor(Math.random() * 40 + 10);
            var avgDauer = Math.floor(Math.random() * 200 + 80);
            var erreich = Math.floor(Math.random() * 15 + 85);
            var bewertung = (Math.random() * 1.5 + 3.5).toFixed(1);

            var erreichFarbe = erreich >= 90 ? "var(--success)" : erreich >= 80 ? "var(--warning)" : "var(--danger)";
            var sterne = "";
            for (var s = 1; s <= 5; s++) {
                sterne += '<i class="fa-' + (s <= Math.round(parseFloat(bewertung)) ? "solid" : "regular") + ' fa-star" style="color:' + (s <= Math.round(parseFloat(bewertung)) ? "#f59e0b" : "#d1d5db") + ';font-size:0.75rem"></i>';
            }

            var tr = document.createElement("tr");
            tr.innerHTML = '<td><strong>' + escapeHtml(a.name) + '</strong></td>' +
                '<td>' + anrufe + '</td>' +
                '<td>' + Math.floor(avgDauer / 60) + ':' + ('0' + (avgDauer % 60)).slice(-2) + '</td>' +
                '<td><span style="color:' + erreichFarbe + ';font-weight:700">' + erreich + '%</span></td>' +
                '<td>' + sterne + ' <small>' + bewertung + '</small></td>';
            body.appendChild(tr);
        });
    }

    function kostenAnzeigen() {
        var bereich = document.getElementById("aw-kosten-bereich");
        if (!bereich) return;

        var s = DEMO_STATS[aktuellerZeitraum] || DEMO_STATS.woche;
        var kostenProAnruf = 0.039;
        var kostenBot = 0.05;
        var kostenAgent = 2.80;
        var kostenOhneBot = s.anrufe * kostenAgent;
        var kostenMitBot = (s.anrufe - s.voicebot) * kostenAgent + s.voicebot * kostenBot;
        var ersparnis = kostenOhneBot - kostenMitBot;
        var prozent = Math.round((ersparnis / kostenOhneBot) * 100);

        bereich.innerHTML =
            '<div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-bottom:1rem">' +
            '<div style="background:var(--bg);border-radius:var(--radius);padding:1rem;text-align:center">' +
            '<div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:0.25rem">Telefonie-Kosten</div>' +
            '<div style="font-size:1.5rem;font-weight:700;color:var(--text)">' + kostenMitBot.toFixed(2) + ' &euro;</div>' +
            '</div>' +
            '<div style="background:#f0fdf4;border-radius:var(--radius);padding:1rem;text-align:center">' +
            '<div style="font-size:0.8rem;color:var(--text-muted);margin-bottom:0.25rem">Ersparnis durch Bot</div>' +
            '<div style="font-size:1.5rem;font-weight:700;color:var(--success)">' + ersparnis.toFixed(2) + ' &euro; <small>(' + prozent + '%)</small></div>' +
            '</div>' +
            '</div>' +

            '<h3 style="font-size:0.9rem;margin-bottom:0.75rem"><i class="fa-solid fa-receipt"></i> Kostenaufschluesselung</h3>' +
            '<table style="width:100%;font-size:0.85rem">' +
            '<tr><td>Agenten-Gespraeche (' + (s.anrufe - s.voicebot) + ' x ' + kostenAgent.toFixed(2) + ' &euro;)</td><td style="text-align:right;font-weight:600">' + ((s.anrufe - s.voicebot) * kostenAgent).toFixed(2) + ' &euro;</td></tr>' +
            '<tr><td>Voicebot-Gespraeche (' + s.voicebot + ' x ' + kostenBot.toFixed(2) + ' &euro;)</td><td style="text-align:right;font-weight:600">' + (s.voicebot * kostenBot).toFixed(2) + ' &euro;</td></tr>' +
            '<tr><td>Telekom-Kosten (geschaetzt)</td><td style="text-align:right;font-weight:600">' + (s.anrufe * kostenProAnruf).toFixed(2) + ' &euro;</td></tr>' +
            '<tr style="border-top:2px solid var(--border);font-weight:700"><td>Gesamt</td><td style="text-align:right">' + (kostenMitBot + s.anrufe * kostenProAnruf).toFixed(2) + ' &euro;</td></tr>' +
            '</table>' +

            '<div style="margin-top:1rem;padding:0.75rem;background:#eff6ff;border-radius:var(--radius);border:1px solid #bfdbfe">' +
            '<div style="font-size:0.8rem;color:#1e40af"><i class="fa-solid fa-lightbulb"></i> <strong>Tipp:</strong> Ohne Voicebot haetten Sie ' + kostenOhneBot.toFixed(2) + ' &euro; gezahlt. Der Bot spart Ihnen <strong>' + prozent + '%</strong> der Personalkosten.</div>' +
            '</div>';
    }

    function anrufgruendeZeichnen() {
        var bereich = document.getElementById("aw-anrufgruende");
        if (!bereich) return;
        var html = "";
        ANRUF_GRUENDE.forEach(function (g) {
            html += '<div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:0.6rem">' +
                '<span style="min-width:120px;font-size:0.85rem;font-weight:600">' + escapeHtml(g.grund) + '</span>' +
                '<div style="flex:1;background:var(--bg);border-radius:4px;height:20px;overflow:hidden;position:relative">' +
                '<div style="width:' + g.prozent + '%;height:100%;background:' + g.farbe + ';border-radius:4px;transition:width 0.5s"></div>' +
                '</div>' +
                '<span style="font-size:0.85rem;font-weight:700;min-width:35px;text-align:right">' + g.prozent + '%</span></div>';
        });
        bereich.innerHTML = html;
    }

    function tageszeitZeichnen() {
        var bereich = document.getElementById("aw-tageszeit");
        if (!bereich) return;
        var html = '<table style="width:100%;font-size:0.85rem"><thead><tr><th>Uhrzeit</th><th>Anrufe</th><th>Erreichbarkeit</th><th></th></tr></thead><tbody>';
        TAGESZEIT.forEach(function (t) {
            var farbe = t.erreich >= 90 ? "var(--success)" : t.erreich >= 80 ? "var(--warning)" : "var(--danger)";
            html += '<tr><td>' + t.zeit + '</td><td>' + t.anrufe + '</td>' +
                '<td style="font-weight:700;color:' + farbe + '">' + t.erreich + '%</td>' +
                '<td style="width:120px"><div style="background:var(--bg);border-radius:4px;height:6px;overflow:hidden"><div style="width:' + t.erreich + '%;height:100%;background:' + farbe + ';border-radius:4px"></div></div></td></tr>';
        });
        html += '</tbody></table>';
        bereich.innerHTML = html;
    }

    function evnAnzeigen() {
        var body = document.getElementById("aw-evn-body");
        var paging = document.getElementById("aw-evn-paging");
        if (!body) return;

        var suche = (document.getElementById("aw-evn-suche") || {}).value || "";
        var filter = (document.getElementById("aw-evn-filter") || {}).value || "";

        var gefiltert = EVN_DATEN.filter(function (e) {
            if (filter && e.status !== filter) return false;
            if (suche) {
                var s = suche.toLowerCase();
                return e.rufnummer.indexOf(s) !== -1 || e.name.toLowerCase().indexOf(s) !== -1 || e.agent.toLowerCase().indexOf(s) !== -1;
            }
            return true;
        });

        var start = evnSeite * EVN_PRO_SEITE;
        var seite = gefiltert.slice(start, start + EVN_PRO_SEITE);

        body.innerHTML = "";
        seite.forEach(function (e) {
            var statusBadge = {
                angenommen: "status-bestaetigt",
                verpasst: "status-abgesagt",
                voicebot: "status-geplant",
                weiterleitung: "status-geplant"
            };
            var richtungIcon = e.richtung === "eingehend" ? '<i class="fa-solid fa-arrow-down" style="color:var(--success)"></i>' : '<i class="fa-solid fa-arrow-up" style="color:var(--primary)"></i>';
            var tr = document.createElement("tr");
            tr.innerHTML = '<td>' + escapeHtml(e.datum) + '</td>' +
                '<td>' + escapeHtml(e.rufnummer) + '<br><small style="color:var(--text-muted)">' + escapeHtml(e.name) + '</small></td>' +
                '<td>' + richtungIcon + ' ' + escapeHtml(e.richtung) + '</td>' +
                '<td>' + escapeHtml(e.agent) + '</td>' +
                '<td>' + (e.dauer > 0 ? Math.floor(e.dauer / 60) + ':' + ('0' + (e.dauer % 60)).slice(-2) : '-') + '</td>' +
                '<td><span class="status-badge ' + (statusBadge[e.status] || "") + '">' + escapeHtml(e.status) + '</span></td>' +
                '<td>' + e.kosten + ' &euro;</td>';
            body.appendChild(tr);
        });

        if (paging) {
            var gesamtSeiten = Math.ceil(gefiltert.length / EVN_PRO_SEITE);
            paging.innerHTML = '<span>' + gefiltert.length + ' Eintraege (Seite ' + (evnSeite + 1) + '/' + Math.max(1, gesamtSeiten) + ')</span>' +
                '<div style="display:flex;gap:0.5rem">' +
                '<button type="button" id="aw-evn-zurueck" style="padding:0.3rem 0.7rem;font-size:0.8rem" ' + (evnSeite === 0 ? 'disabled' : '') + '><i class="fa-solid fa-chevron-left"></i></button>' +
                '<button type="button" id="aw-evn-vor" style="padding:0.3rem 0.7rem;font-size:0.8rem" ' + (evnSeite >= gesamtSeiten - 1 ? 'disabled' : '') + '><i class="fa-solid fa-chevron-right"></i></button></div>';

            var btnZ = document.getElementById("aw-evn-zurueck");
            var btnV = document.getElementById("aw-evn-vor");
            if (btnZ) btnZ.addEventListener("click", function () { if (evnSeite > 0) { evnSeite--; evnAnzeigen(); } });
            if (btnV) btnV.addEventListener("click", function () { evnSeite++; evnAnzeigen(); });
        }
    }

    function allesAktualisieren() {
        kpiAktualisieren();
        chartZeichnen();
        agentenPerformance();
        kostenAnzeigen();
        anrufgruendeZeichnen();
        tageszeitZeichnen();
        evnSeite = 0;
        evnAnzeigen();
    }

    // Event Listener
    var zeitraumSel = document.getElementById("aw-zeitraum");
    if (zeitraumSel) {
        zeitraumSel.addEventListener("change", function () {
            aktuellerZeitraum = this.value;
            allesAktualisieren();
        });
    }

    var btnAkt = document.getElementById("btn-aw-aktualisieren");
    if (btnAkt) btnAkt.addEventListener("click", allesAktualisieren);

    var btnExport = document.getElementById("btn-aw-export");
    if (btnExport) {
        btnExport.addEventListener("click", function () {
            var csv = "Datum;Rufnummer;Name;Richtung;Agent;Dauer (s);Status;Kosten\n";
            EVN_DATEN.forEach(function (e) {
                csv += e.datum + ";" + e.rufnummer + ";" + e.name + ";" + e.richtung + ";" + e.agent + ";" + e.dauer + ";" + e.status + ";" + e.kosten + "\n";
            });
            var blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
            var url = URL.createObjectURL(blob);
            var a = document.createElement("a");
            a.href = url;
            a.download = "auswertung_" + aktuellerZeitraum + ".csv";
            a.click();
            URL.revokeObjectURL(url);
        });
    }

    var evnSuche = document.getElementById("aw-evn-suche");
    var evnFilter = document.getElementById("aw-evn-filter");
    if (evnSuche) evnSuche.addEventListener("input", function () { evnSeite = 0; evnAnzeigen(); });
    if (evnFilter) evnFilter.addEventListener("change", function () { evnSeite = 0; evnAnzeigen(); });

    // Initialisieren
    allesAktualisieren();
}

// Globale Funktionen fuer onclick-Handler im HTML
if (typeof window !== "undefined") {
    window.callflowPropsSpeichern = callflowPropsSpeichern;
    window.callflowNodeLoeschen = callflowNodeLoeschen;
    window.phraseVorlesen = phraseVorlesen;
    window.phraseUebernehmen = phraseUebernehmen;
}

/** Init (nur im Browser) */
if (typeof document !== "undefined") {
    document.addEventListener("DOMContentLoaded", function () {
        // Guard: Auth-Check auf allen Seiten ausser guard.html
        var istGuardSeite = window.location.pathname.indexOf("guard.html") !== -1;
        if (!istGuardSeite) {
            var auth = guardPruefen();
            if (!auth) return; // Redirect zur Guard-Seite
            guardInfoAnzeigen();
        }

        brancheLaden();
        brancheAnwenden();
        modusPruefen();
        demoDatenLaden();
        initDashboard();
        initRechner();
        initBenutzerFormular();
        initPatienten();
        initAerzte();
        initTermine();
        initWartezimmer();
        initAgentenBoard();
        initSoftphone();
        initChatWidget();
        initSprachChat();
        initCallflowEditor();
        initVoicebotSeite();
        initUebersetzer();
        initStandortSeite();
        initWissensdatenbank();
        initAnsagenGenerator();
        initAuswertungen();
        initDemoReset();

        // Mobile Sidebar Toggle
        var menuBtn = document.getElementById("menu-toggle");
        var sidebar = document.getElementById("sidebar");
        if (menuBtn && sidebar) {
            menuBtn.addEventListener("click", function () {
                sidebar.classList.toggle("open");
            });
        }
    });
}


// ===== SPA Navigation =====
var SPA_PAGES = {"dashboard": {"icon": "fa-chart-pie", "label": "Dashboard", "rollen": ["admin", "teamleitung", "standortleitung", "agent"]}, "patienten": {"icon": "fa-users", "label": "Patienten", "rollen": ["admin", "teamleitung", "standortleitung"]}, "aerzte": {"icon": "fa-user-doctor", "label": "Aerzte", "rollen": ["admin", "teamleitung", "standortleitung"]}, "termine": {"icon": "fa-calendar-days", "label": "Termine", "rollen": ["admin", "teamleitung", "standortleitung", "agent"]}, "wartezimmer": {"icon": "fa-couch", "label": "Wartezimmer", "rollen": ["admin", "teamleitung", "standortleitung", "agent"]}, "wissensdatenbank": {"icon": "fa-book", "label": "Wissensdatenbank", "rollen": ["admin", "teamleitung", "standortleitung", "agent"]}, "ansagen": {"icon": "fa-tower-broadcast", "label": "Ansagen Generator", "rollen": ["admin", "teamleitung"]}, "auswertung": {"icon": "fa-chart-line", "label": "Auswertungen", "rollen": ["admin", "teamleitung", "standortleitung"]}, "standort": {"icon": "fa-building", "label": "Standort &amp; ACD", "rollen": ["admin", "teamleitung", "standortleitung"]}, "callflow": {"icon": "fa-diagram-project", "label": "Callflow Editor", "rollen": ["admin", "teamleitung"]}, "voicebot": {"icon": "fa-robot", "label": "Voicebot", "rollen": ["admin", "teamleitung"]}, "agenten": {"icon": "fa-headset", "label": "Agenten", "rollen": ["admin", "teamleitung"]}, "softphone": {"icon": "fa-phone", "label": "Softphone", "rollen": ["admin", "teamleitung", "standortleitung", "agent"]}, "uebersetzung": {"icon": "fa-language", "label": "Uebersetzer", "rollen": ["admin", "teamleitung", "standortleitung", "agent"]}, "benutzer": {"icon": "fa-user-gear", "label": "Benutzer", "rollen": ["admin"]}};

function spaNavigieren(pageId) {
    document.querySelectorAll(".spa-page").forEach(function (p) { p.classList.remove("active"); });
    var page = document.getElementById("spa-" + pageId);
    if (page) page.classList.add("active");

    document.querySelectorAll(".spa-nav-link").forEach(function (l) { l.classList.remove("active"); });
    document.querySelectorAll('.spa-nav-link[data-page="' + pageId + '"]').forEach(function (l) { l.classList.add("active"); });

    var titel = document.getElementById("spa-page-title");
    if (titel && page) titel.textContent = page.dataset.title || pageId;
}

function spaRolleWechseln(rolle) {
    var nav = document.getElementById("spa-nav");
    if (!nav) return;
    nav.innerHTML = "";
    Object.keys(SPA_PAGES).forEach(function (id) {
        var p = SPA_PAGES[id];
        if (p.rollen.indexOf(rolle) !== -1) {
            var a = document.createElement("a");
            a.href = "#";
            a.className = "spa-nav-link";
            a.dataset.page = id;
            a.innerHTML = '<i class="fa-solid ' + p.icon + ' nav-icon"></i> ' + p.label;
            a.addEventListener("click", function (e) { e.preventDefault(); spaNavigieren(id); });
            nav.appendChild(a);
        }
    });
    // Erste sichtbare Seite aktivieren
    var ersteSeite = Object.keys(SPA_PAGES).find(function (id) { return SPA_PAGES[id].rollen.indexOf(rolle) !== -1; });
    if (ersteSeite) spaNavigieren(ersteSeite);
}

// Nav-Links Event Listener
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".spa-nav-link").forEach(function (link) {
        link.addEventListener("click", function (e) {
            e.preventDefault();
            spaNavigieren(this.dataset.page);
        });
    });

    // Guard ausblenden wenn auth vorhanden
    var guard = document.getElementById("spa-guard");
    var auth = sessionStorage.getItem("med_guard_auth") || localStorage.getItem("med_guard_auth");
    if (auth && guard) {
        guard.classList.add("hidden");
    }

    // Original guardPruefen ueberschreiben damit es nicht redirected
    if (typeof window.guardPruefen === "function") {
        var origGuard = window.guardPruefen;
        window.guardPruefen = function () {
            var a = sessionStorage.getItem("med_guard_auth") || localStorage.getItem("med_guard_auth");
            if (!a) {
                var g = document.getElementById("spa-guard");
                if (g) g.classList.remove("hidden");
                return null;
            }
            return JSON.parse(a);
        };
    }

    // Erste Seite aktiv markieren
    var ersterLink = document.querySelector(".spa-nav-link");
    if (ersterLink) ersterLink.classList.add("active");
});

// Guard Login-Erfolg abfangen - statt redirect, guard ausblenden
var origGuardLogin = window.guardLoginHandler;
if (typeof document !== "undefined") {
    document.addEventListener("DOMContentLoaded", function () {
        var form = document.getElementById("guard-login-form");
        if (form) {
            form.addEventListener("submit", function (e) {
                // Nach kurzem Delay pruefen ob auth gesetzt
                setTimeout(function () {
                    var auth = sessionStorage.getItem("med_guard_auth") || localStorage.getItem("med_guard_auth");
                    if (auth) {
                        var guard = document.getElementById("spa-guard");
                        if (guard) guard.classList.add("hidden");
                        // Seite neu initialisieren
                        if (typeof initDashboard === "function") initDashboard();
                    }
                }, 500);
            });
        }
    });
}
</script>
</body>
</html>

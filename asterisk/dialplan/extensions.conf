; ============================================================
; MedReception — Dialplan
; Anrufsteuerung, Voicebot, ACD, Queues
; ============================================================

[general]
static=yes
writeprotect=no

; ===== EINGEHENDE ANRUFE =====
[eingehend]
; Alle eingehenden Anrufe landen hier.
; 1. Voicebot nimmt an (konfigurierbar)
; 2. Falls Voicebot uebergibt → Queue / Agent
; 3. Falls kein Agent frei → Ansage + Mailbox

; Hauptnummer — Voicebot uebernimmt
exten => _X.,1,NoOp(Eingehender Anruf von ${CALLERID(num)})
 same => n,Set(CDR(accountcode)=medreception)
 same => n,Set(CHANNEL(language)=de)
 same => n,Answer()
 same => n,Wait(0.5)
 ; Pruefen ob Voicebot aktiv (via ARI/AGI)
 same => n,AGI(agi://127.0.0.1:4573/voicebot,${CALLERID(num)},${EXTEN})
 ; Nach Voicebot: Variable VOICEBOT_RESULT enthaelt Ergebnis
 ; VOICEBOT_RESULT = TRANSFER → An Queue weiterleiten
 ; VOICEBOT_RESULT = TERMIN  → Termin gebucht, auflegen
 ; VOICEBOT_RESULT = HANGUP  → Bot hat erledigt
 same => n,GotoIf($["${VOICEBOT_RESULT}" = "TRANSFER"]?transfer)
 same => n,GotoIf($["${VOICEBOT_RESULT}" = "TERMIN"]?fertig)
 same => n,Goto(fertig)

 ; Transfer an Queue
 same => n(transfer),NoOp(Voicebot uebergibt an Queue: ${VOICEBOT_QUEUE})
 same => n,Set(QUEUE_NAME=${IF($["${VOICEBOT_QUEUE}" != ""]?${VOICEBOT_QUEUE}:rezeption)})
 same => n,Goto(acd,${QUEUE_NAME},1)

 ; Fertig — Verabschiedung
 same => n(fertig),NoOp(Anruf erledigt)
 same => n,Hangup()


; ===== ACD — Automatic Call Distribution =====
[acd]
; Queue-Routing — Anrufer wird in Warteschlange eingereiht

; Rezeption (Standard-Queue)
exten => rezeption,1,NoOp(ACD: Queue Rezeption)
 same => n,Set(CHANNEL(musicclass)=default)
 same => n,Playback(willkommen-warteschlange)
 same => n,Queue(rezeption,tT,,,120)
 same => n,Goto(overflow,rezeption,1)

; Notfall-Queue
exten => notfall,1,NoOp(ACD: Queue Notfall)
 same => n,Set(CHANNEL(musicclass)=default)
 same => n,Queue(notfall,tT,,,30)
 same => n,Goto(overflow,notfall,1)

; Termin-Queue
exten => termin,1,NoOp(ACD: Queue Termin)
 same => n,Set(CHANNEL(musicclass)=default)
 same => n,Queue(termin,tT,,,90)
 same => n,Goto(overflow,termin,1)

; Rezept-Queue
exten => rezept,1,NoOp(ACD: Queue Rezept)
 same => n,Set(CHANNEL(musicclass)=default)
 same => n,Queue(rezept,tT,,,90)
 same => n,Goto(overflow,rezept,1)

; Generisch — Queue-Name als Extension
exten => _X.,1,NoOp(ACD: Queue ${EXTEN})
 same => n,Queue(${EXTEN},tT,,,120)
 same => n,Goto(overflow,${EXTEN},1)


; ===== OVERFLOW — Kein Agent verfuegbar =====
[overflow]
exten => _X.,1,NoOp(Overflow: Kein Agent fuer ${EXTEN})
 same => n,Playback(kein-agent-verfuegbar)
 ; Zurueck zum Voicebot fuer Rueckruf/Nachricht
 same => n,AGI(agi://127.0.0.1:4573/overflow,${CALLERID(num)},${EXTEN})
 same => n,Hangup()


; ===== INTERNE ANRUFE =====
[intern]
; Agent zu Agent
exten => _1XX,1,NoOp(Interner Anruf an ${EXTEN})
 same => n,Dial(PJSIP/${EXTEN},30,tT)
 same => n,Hangup()

; Agent → Voicebot-Test
exten => 200,1,NoOp(Voicebot-Test)
 same => n,Answer()
 same => n,AGI(agi://127.0.0.1:4573/voicebot,${CALLERID(num)},test)
 same => n,Hangup()

; Feature Codes
exten => *1,1,NoOp(Agent Login)
 same => n,AddQueueMember(rezeption,PJSIP/${CALLERID(num)})
 same => n,Playback(agent-eingeloggt)
 same => n,Hangup()

exten => *2,1,NoOp(Agent Logout)
 same => n,RemoveQueueMember(rezeption,PJSIP/${CALLERID(num)})
 same => n,Playback(agent-ausgeloggt)
 same => n,Hangup()

exten => *3,1,NoOp(Agent Pause)
 same => n,PauseQueueMember(rezeption,PJSIP/${CALLERID(num)})
 same => n,Playback(agent-pause)
 same => n,Hangup()

exten => *4,1,NoOp(Agent Unpause)
 same => n,UnpauseQueueMember(rezeption,PJSIP/${CALLERID(num)})
 same => n,Playback(agent-bereit)
 same => n,Hangup()


; ===== VOICEBOT CONTEXT =====
[voicebot]
exten => s,1,NoOp(Voicebot-Kanal)
 same => n,Answer()
 same => n,AGI(agi://127.0.0.1:4573/voicebot,${CALLERID(num)},${EXTEN})
 same => n,Hangup()
